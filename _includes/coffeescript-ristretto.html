<div id="leanpub-main">

<!-- begin frontmatter -->
<h2 id="a-pull-of-the-lever-prefaces">A Pull of the Lever: Prefaces</h2>

<div class="image-with-caption">
  <p><img src="images/caffemolinari.jpg" alt="Caffe Molinari" />
  <p>Caffe Molinari</p>
</div>

<blockquote>
  <p>&ldquo;We always pour our coffee in the ristretto, or restricted, tradition. The coffee is restricted to the most flavourful part of the shot.  This tradition offers the heaviest shot, thickest texture and finest flavour that the coffee has to offer.&rdquo;&ndash;<a href="http://www.espressovivace.com/archives/9507scr.html">David Schomer</a></p>
</blockquote>

<div class="page-break" />
<h3 id="about-this-book">About This Book</h3>

<blockquote>
  <p>Learning about &ldquo;for&rdquo; loops is not learning to program, any more than learning about pencils is learning to draw.&ndash;Bret Victor, <a href="http://worrydream.com/LearnableProgramming/">Learnable Programming</a></p>
</blockquote>

<p>Programming languages are characterized by their syntax and their semantics. The syntax of a language defines its user interface; If you understand a language&rsquo;s syntax, you understand what it makes easy. The semantics of a language defines its capabilities; If you understand a language&rsquo;s semantics, you understand what it does well.</p>

<p><em>CoffeeScript Ristretto</em> is first and foremost about a book about programming with functions, because its flexible and powerful functions are what make the <a href="http://coffeescript.org">CoffeeScript</a> programming language so capable, and what CoffeeScript does well.</p>

<h4 id="how-this-book-is-organized">how this book is organized</h4>

<p><em>CoffeeScript Ristretto</em> begins at the beginning, with values and expressions, and builds from there to discuss types, identity, functions, closures, scopes, and many more subjects up to working with classes and instances in Chapter Five. Chapter Six, &ldquo;<a href="#extra-shot">An Extra Shot of Ideas</a>,&rdquo; introduces advanced CoffeeScript idioms like method decorators. Since <em>CoffeeScript Ristretto</em> is a book about CoffeeScript&rsquo;s semantics, each topic is covered thoroughly, without hand-waving or simplification.</p>

<p>As a result, <em>CoffeeScript Ristretto</em> is a rich, dense read, much like the Espresso Ristretto beloved by coffee enthusiasts everywhere.</p>

<div class="page-break" />
<h3 id="foreword-by-jeremy-ashkenas">Foreword by Jeremy Ashkenas</h3>

<blockquote>
  <p>&ldquo;I particularly enjoyed this small book because I&rsquo;ve reached for it a hundred times before and come up empty-handed. Large and heavy manuals on object-oriented programming and JavaScript are all around us, but to find a book that tackles the fundamental features of functions and objects in a brief, strong gulp, is rare indeed.</p>
</blockquote>

<blockquote>
  <p>&ldquo;With the inimitable Mr. Braithwaite as your guide, you&rsquo;ll explore the nature of functions, the nooks and crannies of lexical scope, the essence of reference, the method of mutation, the construction of classes, callbacks, prototypes, promises, and more. And you&rsquo;ll learn a great deal about the internals of CoffeeScript and the semantics of JavaScript along the way. Every feature is broken apart into its basic pieces, and you put it back together yourself, brick by brick.</p>
</blockquote>

<blockquote>
  <p>&ldquo;This book is dense, but hopefully you&rsquo;ve chosen it because you like your ristretto bold and strong. If Reg had pulled it any thicker you&rsquo;d have to chew it.&rdquo;—Jeremy Ashkenas, CoffeeScript&rsquo;s creator</p>
</blockquote>

<div class="page-break" />
<h3 id="legend">Legend</h3>

<p>Some text in monospaced type like <code>this</code> in the text represents some code being discussed. Some monospaced code in its own lines also represents code being discussed:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">this</code><code class="p">.</code><code class="n">async</code> <code class="p">=</code> <code class="n">do</code> <code class="p">(</code><code class="n">async</code> <code class="p">=</code> <code class="n">undefined</code><code class="p">)</code> <code class="o">-&gt;</code>

  <code class="n">async</code> <code class="p">=</code> <code class="p">(</code><code class="n">fn</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="p">(</code><code class="n">argv</code><code class="p">...,</code> <code class="n">callback</code><code class="p">)</code> <code class="o">-&gt;</code>
      <code class="n">callback</code><code class="p">(</code><code class="n">fn</code><code class="p">.</code><code class="n">apply</code><code class="p">(</code><code class="n">this</code><code class="p">,</code> <code class="n">argv</code><code class="p">))</code>
</pre></div>

</div>

<p>Sometimes it will contain some code for you to type in for yourself. When it does, the result of typing something in will often be shown using <code>#=&gt;</code>, like this:</p>

<div class="code-block">
<div class="highlight"><pre>2 <code class="o">+</code> 2
  #<code class="p">=</code><code class="o">&gt;</code> 4
</pre></div>

</div>

<div class="tip sidebarish">
  <hr />
  <p><img class="sidebar-image" alt="tip" src="images/leanpub_tip.png" />A paragraph marked like this is a &ldquo;key fact.&rdquo; It summarizes an idea without adding anything new.</p>

  <hr />
</div>

<div class="exercise sidebarish">
  <hr />
  <p><img class="sidebar-image" alt="exercise" src="images/leanpub_exercise.png" />A paragraph marked like this is a suggested exercise to be performed on your own.</p>

  <hr />
</div>

<div class="aside sidebarish">
  <hr />
  <p>A paragraph marked like this is an aside. It can be safely ignored. It contains whimsey and other doupleplusunserious logorrhea that will <em>not</em> be on the test.</p>

  <hr />
</div>

<div class="page-break" />
<h2 id="prelude-values-and-expressions">Prelude: Values and Expressions</h2>

<p><em>The following material is extremely basic, however like most stories, the best way to begin is to start at the very beginning.</em></p>

<p>Imagine we are visiting our favourite coffee shop. They will make for you just about any drink you desire, from a short, intense espresso ristretto through a dry cappuccino, up to those coffee-flavoured desert concoctions featuring various concentrated syrups and milks. (You tolerate the existence of sugary drinks because they provide a sufficient profit margin to the establishment to finance your hanging out there all day using their WiFi and ordering a $3 drink every few hours.)</p>

<p>You express your order at one end of their counter, the folks behind the counter perform their magic, and deliver the coffee you value at the other end. This is exactly how the CoffeeScript environment works for the purpose of this book. We are going to dispense with web servers, browsers and other complexities and deal with this simple model: You give the computer an <a href="https://en.wikipedia.org/wiki/Expression_" title="computer_science">expression</a>, and it returns a <a href="https://en.wikipedia.org/wiki/Value_" title="computer_science">value</a>, just as you express your wishes to a barista and receive a coffee in return.</p>

<h3 id="values-and-expressions">values and expressions</h3>

<p>All values are expressions. Say you hand the barista a Cafe Cubana. Yup, you hand over a cup with some coffee infused through partially caramelized sugar. You say, &ldquo;I want one of these.&rdquo; The barista is no fool, she gives it straight back to you, and you get exactly what you want. Thus, a Cafe Cubana is an expression (you can use it to place an order) and a value (you get it back from the barista).</p>

<p>Let&rsquo;s try this with something the computer understands easily:</p>

<div class="code-block">
<div class="highlight"><pre>42
</pre></div>

</div>

<p>Is this an expression? A value? Neither? Or both?</p>

<p>The answer is, this is both an expression <em>and</em> a value.<sup id="fnref-representation"><a href="#fn-representation" rel="footnote">1</a></sup> The way you can tell that it&rsquo;s both is very easy: When you type it into CoffeeScript, you get the same thing back, just like our Cafe Cubana:</p>

<div class="code-block">
<div class="highlight"><pre>42
  #<code class="p">=</code><code class="o">&gt;</code> 42
</pre></div>

</div>

<p>All values are expressions. That&rsquo;s easy! Are there any other kinds of expressions? Sure! let&rsquo;s go back to the coffee shop. Instead of handing over the finished coffee, we can hand over the ingredients. Let&rsquo;s hand over some ground coffee plus some boiling water.</p>

<div class="aside sidebarish">
  <hr />
  <p>Astute readers will realize we&rsquo;re omitting something. Congratulations! Take a sip of espresso. We&rsquo;ll get to that in a moment.</p>

  <hr />
</div>

<p>Now the barista gives us back an espresso. And if we hand over the espresso, we get the espresso right back. So, boiling water plus ground coffee is an expression, but it isn&rsquo;t a value.<sup id="fnref-homoiconicity"><a href="#fn-homoiconicity" rel="footnote">2</a></sup> Boiling water is a value. Ground coffee is a value. Espresso is a value. Boiling water plus ground coffee is an expression.</p>

<p>Let&rsquo;s try this as well with something else the computer understands easily:</p>

<div class="code-block">
<div class="highlight"><pre>&quot;<code class="n">CoffeeScript</code>&quot; <code class="o">+</code> &quot; &quot; <code class="o">+</code> &quot;<code class="n">Ristretto</code>&quot;
  #<code class="p">=</code><code class="o">&gt;</code> &quot;<code class="n">CoffeeScript</code> <code class="n">Ristretto</code>&quot;
</pre></div>

</div>

<p>These are &ldquo;strings,&rdquo; values featured in almost every contemporary computer language. We see that &ldquo;strings&rdquo; are values, and you can make an expression out of strings and an operator <code>+</code>. Since strings are values, they are also expressions by themselves. But strings with operators are not values, they are expressions. Now we know what was missing with our &ldquo;coffee grounds plus hot water&rdquo; example. The coffee grounds were a value, the boiling hot water was a value, and the &ldquo;plus&rdquo; operator between them made the whole thing an expression that was not a value.</p>

<h3 id="values-and-identity">values and identity</h3>

<p>In CoffeeScript, we test whether two values are identical with the <code>is</code> operator, and whether they are not identical with the <code>isnt</code> operator:</p>

<div class="code-block">
<div class="highlight"><pre>	2 <code class="n">is</code> 2
		#<code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code>
		
	<code class="s">&#39;hello&#39;</code> <code class="n">isnt</code> <code class="s">&#39;goodbye&#39;</code>
		#<code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code>
</pre></div>

</div>

<p>How does <code>is</code> work, exactly? Imagine that you&rsquo;re shown a cup of coffee. And then you&rsquo;re shown another cup of coffee. Are the two cups &ldquo;identical?&rdquo; In CoffeeScript, there are four possibilities:</p>

<p>First, sometimes, the cups are of different types. One is a demitasse, the other a mug. This corresponds to comparing two things in CoffeeScript that have different <em>types</em>. For example, the string <code>"2"</code> is not the same thing as the number <code>2</code>. Strings and numbers are different types, so strings and numbers are never identical:</p>

<div class="code-block">
<div class="highlight"><pre>2 <code class="n">is</code> <code class="s">&#39;2&#39;</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="n">false</code>
  
<code class="n">true</code> <code class="n">isnt</code> <code class="s">&#39;true&#39;</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code>
</pre></div>

</div>

<p>Second, sometimes, the cups are of the same type&ndash;perhaps two espresso cups&ndash;but they have different contents. One holds a single, one a double. This corresponds to comparing two CoffeeScript values that have the same type but different &ldquo;content.&rdquo; For example, the number <code>5</code> is not the same thing as the number <code>2</code>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">true</code> <code class="n">is</code> <code class="n">false</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="n">false</code>
  
2 <code class="n">isnt</code> 5
  #<code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code>
  
<code class="s">&#39;two&#39;</code> <code class="n">is</code> <code class="s">&#39;five&#39;</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="n">false</code>
</pre></div>

</div>

<p>What if the cups are of the same type <em>and</em> the contents are the same? Well, CoffeeScript&rsquo;s third and fourth possibilities cover that.</p>

<h4 id="value-types">value types</h4>

<p>Third, some types of cups have no distinguishing marks on them. If they are the same kind of cup, and they hold the same contents, we have no way to tell the difference between them. This is the case with the strings, numbers, and booleans we have seen so far.</p>

<div class="code-block">
<div class="highlight"><pre>2 <code class="o">+</code> 2 <code class="n">is</code> 4
  #<code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code>
  
<code class="p">(</code>2 <code class="o">+</code> 2 <code class="n">is</code> 4<code class="p">)</code> <code class="n">is</code> <code class="p">(</code>2 <code class="n">isnt</code> 5<code class="p">)</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code>
</pre></div>

</div>

<p>Note well what is happening with these examples: Even when we obtain a string, number, or boolean as the result of evaluating an expression, it is identical to another value of the same type with the same &ldquo;content.&rdquo; Strings, numbers, and booleans are examples of what CoffeeScript calls &ldquo;value&rdquo; or &ldquo;primitive&rdquo; types. We&rsquo;ll use both terms interchangeably.</p>

<p>We haven&rsquo;t encountered the fourth possibility yet. Stretching the metaphor somewhat, some types of cups have a serial number on the bottom. So even if you have two cups of the same type, and their contents are the same, you can still distinguish between them.</p>

<div class="image-with-caption">
  <p><img src="images/macchiato_1200.jpg" alt="Cafe Macchiato is also a fine drink, especially when following up on the fortunes of the Azzuri or the standings in the Giro D'Italia" />
  <p>Cafe Macchiato is also a fine drink, especially when following up on the fortunes of the Azzuri or the standings in the Giro D'Italia</p>
</div>

<h4 id="reference-types">reference types</h4>

<p>So what kinds of values might be the same type and have the same contents, but not be considered identical to CoffeeScript? Let&rsquo;s meet a data structure that is very common in contemporary programming languages, the <em>Array</em> (other languages sometimes call it a List or a Vector).</p>

<p>Here are some expressions for arrays you can try typing for yourself:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">[1, 2, 3]</code>
<code class="k">[1,2,2]</code>
<code class="k">[1..3]</code>
</pre></div>

</div>

<p>These are expressions, and you can combine <code>[]</code> with other expressions. Go wild with things like:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">[2-1, 2, 2+1]</code>
<code class="k">[1, 1+1, 1+1+1]</code>
</pre></div>

</div>

<p>We aren&rsquo;t going to spend a lot of time talking about it, but if you enable multiline mode (with ctrl-v), you can also type things like:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">[</code>
  1
  2
  3
  <code class="p">]</code>
</pre></div>

</div>

<p>Notice that you are always generating arrays with the same contents. But are they identical the same way that every value of <code>42</code> is identical to every other value of <code>42</code>? Try these for yourself:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">[1..3] is [1,2,3]</code>
<code class="k">[1,2,3] is [1, 2, 3]</code>
<code class="k">[1, 2, 3] is [1, 2, 3]</code>
</pre></div>

</div>

<p>How about that! When you type <code>[1, 2, 3]</code> or any of its variations, you are typing an expression that generates its own <em>unique</em> array that is not identical to any other array, even if that other array also looks like <code>[1, 2, 3]</code>. It&rsquo;s as if CoffeeScript is generating new cups of coffee with serial numbers on the bottom.</p>

<p>They look the same, but if you examine them with <code>is</code>, you see that they are different. Every time you evaluate an expression (including typing something in) to create an array, you&rsquo;re creating a new, distinct value even if it <em>appears</em> to be the same as some other array value. As we&rsquo;ll see, this is true of many other kinds of values, including <em>functions</em>, the main subject of this book.</p>

<div class="page-break" />
<h4 id="interlude">interlude&hellip;</h4>

<div class="image-with-caption">
  <p><img src="images/espresso.jpg" alt="A short, intense shot of espresso" />
  <p>A short, intense shot of espresso</p>
</div>

<p><a href="https://en.wikipedia.org/wiki/Ristretto">Wikipedia</a> on Ristretto:</p>

<blockquote>
  <p>&rdquo;<strong>Ristretto</strong> is a very &lsquo;short&rsquo; shot of espresso coffee. Originally this meant pulling a hand press faster than usual using the same amount of water as a regular shot of espresso. Since the water came in contact with the grinds for a much shorter time the caffeine is extracted in reduced ratio to the flavorful coffee oils. The resultant shot could be described as bolder, fuller, with more body and less bitterness.&rdquo;</p>
</blockquote>

<div class="page-break" />
<!-- begin mainmatter -->
<h2 id="coffeescript-ristretto">CoffeeScript Ristretto</h2>

<div class="image-with-caption">
  <p><img src="images/leaf-roaster.jpg" alt="The perfect Espresso Ristretto begins with the right beans, properly roasted. CoffeeScript Ristretto begins with functions, properly dissected." />
  <p>The perfect Espresso Ristretto begins with the right beans, properly roasted. CoffeeScript Ristretto begins with functions, properly dissected.</p>
</div>

<h2 id="functions">The first sip: Functions</h2>

<div class="image-with-caption">
  <p><img src="images/half-drunk.jpg" alt="While Terroir tends toward pretty low body (particularly at its age when we pulled it), the crema's so thin on this shot due to it having been sipped from already!" />
  <p>While Terroir tends toward pretty low body (particularly at its age when we pulled it), the crema's so thin on this shot due to it having been sipped from already!</p>
</div>

<div class="page-break" />
<h3 id="as-little-as-possible-about-functions-but-no-less">As Little As Possible About Functions, But No Less</h3>

<p>In CoffeeScript, functions are values, but they are also much more than simple numbers, strings, or even complex data structures like trees or maps. Functions represent computations to be performed. Like numbers, strings, and arrays, they have a representation in CoffeeScript. Let&rsquo;s start with the very simplest possible function. In CoffeeScript, it looks like this:<sup id="fnref-also"><a href="#fn-also" rel="footnote">3</a></sup></p>

<div class="code-block">
<div class="highlight"><pre><code class="o">-&gt;</code>
</pre></div>

</div>

<p>This is a function that is applied to no values and produces no value. Hah! There&rsquo;s the third thing. How do we represent &ldquo;no value&rdquo; in CoffeeScript? We&rsquo;ll find out in a minute. First, let&rsquo;s verify that our function is a value:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">-&gt;</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="p">[</code><code class="n">Function</code><code class="p">]</code>
</pre></div>

</div>

<p>What!? Why didn&rsquo;t it type back <code>-&gt;</code> for us? This <em>seems</em> to break our rule that if an expression is also a value, CoffeeScript will give the same value back to us. What&rsquo;s going on? The simplest and easiest answer is that although the CoffeeScript interpreter does indeed return that value, displaying it on the screen is a slightly different matter. <code>[Function]</code> is a choice made by the people who wrote Node.js, the JavaScript environment that hosts the CoffeeScript REPL. If you try the same thing in a browser (using &ldquo;Try CoffeeScript&rdquo; at <a href="http://coffeescript.org">coffeescript.org</a> for example), you&rsquo;ll get something else entirely that isn&rsquo;t CoffeeScript at all, it&rsquo;s JavaScript.</p>

<div class="page-break" />
<div class="aside sidebarish">
  <hr />
  <p>I&rsquo;d prefer something else, but I console myself with the thought that what gets typed back to us on the screen is arbitrary, and all that really counts is that it is somewhat useful for a human to read. But we must understand that whether we see <code>[Function]</code> or <code>function () {}</code> or&ndash;in some future version of CoffeeScript&ndash;<code>-&gt;</code>, internally CoffeeScript has a full and proper function.<sup id="fnref-circular"><a href="#fn-circular" rel="footnote">4</a></sup></p>

  <hr />
</div>

<h4 id="functions-and-identities">functions and identities</h4>

<p>You recall that we have two types of values with respect to identity: Value types and reference types. Value types share the same identity if they have the same contents. Reference types do not.</p>

<p>Which kind are functions? Let&rsquo;s try it. For reasons of appeasing the CoffeeScript parser, we&rsquo;ll enclose our functions in parentheses:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">(</code><code class="o">-&gt;</code><code class="p">)</code> <code class="n">is</code> <code class="p">(</code><code class="o">-&gt;</code><code class="p">)</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="n">false</code>
</pre></div>

</div>

<p>Like arrays, every time you evaluate an expression to produce a function, you get a new function that is not identical to any other function, even if you use the same expression to generate it. &ldquo;Function&rdquo; is a reference type.</p>

<h4 id="applying-functions">applying functions</h4>

<p>Let&rsquo;s put functions to work. The way we use functions is to <em>apply</em> them to zero or more values called <em>arguments</em>. Just as <code>2 + 2</code> produces a value (in this case <code>4</code>), applying a function to zero or more arguments produces a value as well. Some folks call the arguments the <em>inputs</em> to a function. Whether you use the word &ldquo;inputs&rdquo; or &ldquo;arguments,&rdquo; it&rsquo;s certainly a good thing to think of the function&rsquo;s arrow as pointing from the inputs to the output!</p>

<p>Here&rsquo;s how we apply a function to some values in CoffeeScript: Let&rsquo;s say that <em>fn_expr</em> is an expression that when evaluated, produces a function. Let&rsquo;s call the arguments <em>args</em>. Here&rsquo;s how to apply a function to some arguments:</p>

<p><em>fn_expr</em><code>(</code><em>args</em><code>)</code></p>

<p>Right now, we only know about one such expression: <code>-&gt;</code>, so let&rsquo;s use it. We&rsquo;ll put it in parentheses<sup id="fnref-ambiguous"><a href="#fn-ambiguous" rel="footnote">5</a></sup> to keep the parser happy, like we did above: <code>(-&gt;)</code>. Since we aren&rsquo;t giving it any arguments, we&rsquo;ll simply write <code>()</code> after the expression. So we write:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">(</code><code class="o">-&gt;</code><code class="p">)()</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="n">undefined</code>
</pre></div>

</div>

<p>What is this <code>undefined</code>?</p>

<h4 id="undefined"><code>undefined</code></h4>

<p>In CoffeeScript, the absence of a value is written <code>undefined</code>, and it means there is no value. It will crop up again. <code>undefined</code> is its own type of value, and it acts like a value type:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">undefined</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="n">undefined</code>
</pre></div>

</div>

<p>Like numbers, booleans and strings, CoffeeScript can print out the value <code>undefined</code>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">undefined</code> <code class="n">is</code> <code class="n">undefined</code>
  # <code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code>
<code class="p">(</code><code class="o">-&gt;</code><code class="p">)()</code> <code class="n">is</code> <code class="p">(</code><code class="o">-&gt;</code><code class="p">)()</code>
  # <code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code>
<code class="p">(</code><code class="o">-&gt;</code><code class="p">)()</code> <code class="n">is</code> <code class="n">undefined</code>
  # <code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code>
</pre></div>

</div>

<p>No matter how you evaluate <code>undefined</code>, you get an identical value back. <code>undefined</code> is a value that means &ldquo;I don&rsquo;t have a value.&rdquo; But it&rsquo;s still a value :-)</p>

<p>Speaking of <code>is undefined</code>, a common pattern in CoffeeScript programming is to test wither something <code>isnt undefined</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">undefined</code> <code class="n">isnt</code> <code class="n">undefined</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="n">false</code>
<code class="s">&#39;undefined&#39;</code> <code class="n">isnt</code> <code class="n">undefined</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code>
<code class="n">false</code> <code class="n">isnt</code> <code class="n">undefined</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code>
</pre></div>

</div>

<p>This is so common that a shortcut is provided, the suffix operator <code>?</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">undefined</code>?
  #<code class="p">=</code><code class="o">&gt;</code> <code class="n">false</code>
<code class="s">&#39;undefined&#39;</code>?
  #<code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code>
<code class="n">false</code>?
  #<code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code>
</pre></div>

</div>

<div class="aside sidebarish">
  <hr />
  <p>You might think that <code>undefined</code> in CoffeeScript is equivalent to <code>NULL</code> in SQL. No. In SQL, two things that are <code>NULL</code> are not equal to nor share the same identity, because two unknowns can&rsquo;t be equal. In CoffeeScript, every <code>undefined</code> is identical to every other <code>undefined</code>.</p>

  <hr />
</div>

<h4 id="functions-with-no-arguments">functions with no arguments</h4>

<p>Back to our function. We evaluated this:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">(</code><code class="o">-&gt;</code><code class="p">)()</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="n">undefined</code>
</pre></div>

</div>

<p>Let&rsquo;s recall that we were applying the function <code>-&gt;</code> to no arguments (because there was nothing inside of <code>()</code>). So how do we know to expect <code>undefined</code>? That&rsquo;s easy. When we define a function, we write the arguments it expects to the left of the <code>-&gt;</code> and an optional expression to the right. This expression is called the function&rsquo;s <em>body</em>. Like this:</p>

<p><code>(</code><em>args</em><code>) -&gt; </code><em>body</em></p>

<p>There is a funny rule: You can omit the body, and if you do, applying the function always evaluates to <code>undefined</code>.<sup id="fnref-omit"><a href="#fn-omit" rel="footnote">6</a></sup></p>

<p>What about functions that have a body? Let&rsquo;s write a few. Here&rsquo;s the rule: We can use <em>anything</em> we&rsquo;ve already learned how to use as an expression. Cutting and pasting, that means that the following are all expressions that evaluate to functions:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">-&gt;</code> 2
<code class="o">-&gt;</code> 2 <code class="o">+</code> 2
<code class="o">-&gt;</code> &quot;<code class="n">Hello</code>&quot; <code class="o">+</code> &quot; &quot; <code class="o">+</code> &quot;<code class="n">CoffeeScript</code>&quot;
<code class="o">-&gt;</code> <code class="n">true</code> <code class="n">is</code> <code class="n">not</code> <code class="n">false</code>
<code class="o">-&gt;</code> <code class="n">false</code> <code class="n">isnt</code> <code class="n">true</code>
</pre></div>

</div>

<p>And you can evaluate them by typing any of these into CoffeeScript:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">(</code><code class="o">-&gt;</code> 2<code class="p">)()</code>
  #<code class="p">=</code><code class="o">&gt;</code> 2
<code class="p">(</code><code class="o">-&gt;</code> 2 <code class="o">+</code> 2<code class="p">)()</code>
  #<code class="p">=</code><code class="o">&gt;</code> 4
<code class="p">(</code><code class="o">-&gt;</code> &quot;<code class="n">Hello</code>&quot; <code class="o">+</code> &quot; &quot; <code class="o">+</code> &quot;<code class="n">CoffeeScript</code>&quot;<code class="p">)()</code>
  #<code class="p">=</code><code class="o">&gt;</code> &quot;<code class="n">Hello</code> <code class="n">CoffeeScript</code>&quot;
<code class="p">(</code><code class="o">-&gt;</code> <code class="n">true</code> <code class="n">is</code> <code class="n">not</code> <code class="n">false</code><code class="p">)()</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code>
<code class="p">(</code><code class="o">-&gt;</code> <code class="n">false</code> <code class="n">isnt</code> <code class="n">true</code><code class="p">)()</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code>
</pre></div>

</div>

<p>We haven&rsquo;t discussed arguments yet, but let&rsquo;s get clever with what we already have.</p>

<h4 id="functions-that-evaluate-to-functions">functions that evaluate to functions</h4>

<p>If an expression that evaluates to a function is, well, an expression, and if a function expression can have any expression on its right side&hellip; <em>Can we put an expression that evaluates to a function on the right side of a function expression?</em></p>

<p>Yes:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">-&gt;</code> <code class="o">-&gt;</code>
</pre></div>

</div>

<p>That&rsquo;s a function! It&rsquo;s a function that when applied, evaluates to a function that when applied, evaluates to <code>undefined</code>. Watch and see:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">-&gt;</code> <code class="o">-&gt;</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="p">[</code><code class="n">Function</code><code class="p">]</code>
</pre></div>

</div>

<p>It evaluates to a function&hellip;</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">(</code><code class="o">-&gt;</code> <code class="o">-&gt;</code><code class="p">)()</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="p">[</code><code class="n">Function</code><code class="p">]</code>
</pre></div>

</div>

<p>That when applied, evaluates to a function&hellip;</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">(</code><code class="o">-&gt;</code> <code class="o">-&gt;</code><code class="p">)()()</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="n">undefined</code>
</pre></div>

</div>

<p>That when applied, evaluates to <code>undefined</code>. Likewise:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">-&gt;</code> <code class="o">-&gt;</code> <code class="n">true</code>
</pre></div>

</div>

<p>That&rsquo;s a function! It&rsquo;s a function that when applied, evaluates to a function, that when applied, evaluates to <code>true</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">(</code><code class="o">-&gt;</code> <code class="o">-&gt;</code> <code class="n">true</code><code class="p">)()()</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code>
</pre></div>

</div>

<p>Well. We&rsquo;ve been very clever, but so far this all seems very abstract and computer science-y. Diffraction of a crystal is beautiful and interesting in its own right, but you can&rsquo;t blame us for wanting to be shown a practical use for it, like being able to determine the composition of a star millions of light years away. So&hellip; In the next chapter, &ldquo;<a href="#fargs">I&rsquo;d Like to Have an Argument, Please</a>,&rdquo; we&rsquo;ll see how to make functions practical.</p>

<h4 id="showering-felicitous-encouragement-to-incentivise-the-practice-of-skewing-the-distribution-of-expression-length-towards-the-minimal-mode">showering felicitous encouragement to incentivise the practice of skewing the distribution of expression length towards the minimal mode</h4>

<p>Or, <em>In praise of keeping it short.</em></p>

<p>When describing the behaviour of functions, we often use the expression &ldquo;that when applied, evaluates to&hellip;&rdquo; For example, &ldquo;The function <code>(x, y) -&gt; x + y</code> is a function, that when applied to two integer arguments, evaluates to the sum of the arguments.&rdquo;<sup id="fnref-pedant"><a href="#fn-pedant" rel="footnote">7</a></sup> This is technically correct. But a mouthful. Another expression you will often hear is &ldquo;returns,&rdquo; as in &ldquo;The function <code>(x, y) -&gt; x + y</code> is a function that returns the sum of its arguments.&rdquo;</p>

<p>&ldquo;Returns&rdquo; is a little less precise, and is context dependant. But it suits our purposes, so we will often use it. But when we use it, we will <em>always</em> mean &ldquo;when applied, evaluates to&hellip;&rdquo;</p>

<p>And with that&rsquo;s let&rsquo;s move on!</p>

<div class="page-break" />
<h3 id="fargs">Ah. I&rsquo;d Like to Have an Argument, Please.<sup id="fnref-mp"><a href="#fn-mp" rel="footnote">8</a></sup></h3>

<p>Up to now, we&rsquo;ve looked at functions without arguments. We haven&rsquo;t even said what an argument <em>is</em>, only that our functions don&rsquo;t have any.</p>

<div class="aside sidebarish">
  <hr />
  <p>Most programmers are perfectly familiar with arguments (often called &ldquo;parameters&rdquo;). Secondary school mathematics discusses this. So you know what they are, and I know that you know what they are, but please be patient with the explanation!</p>

  <hr />
</div>

<p>Let&rsquo;s make a function with an argument:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">(</code><code class="n">room</code><code class="p">)</code> <code class="o">-&gt;</code>
</pre></div>

</div>

<p>This function has one argument, <code>room</code>, and no body. Here&rsquo;s a function with two arguments and no body:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">(</code><code class="n">room</code><code class="p">,</code> <code class="n">board</code><code class="p">)</code> <code class="o">-&gt;</code>
</pre></div>

</div>

<p>I&rsquo;m sure you are perfectly comfortable with the idea that this function has two arguments, <code>room</code>, and <code>board</code>. What does one do with the arguments? Use them in the body, of course. What do you think this is?</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">(</code><code class="n">diameter</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">diameter</code> <code class="o">*</code> 3<code class="p">.</code>14159265
</pre></div>

</div>

<p>It&rsquo;s a function for calculating the circumference of a circle given the radius. I read that aloud as &ldquo;When applied to a value representing the diameter, this function <em>gives</em> (that&rsquo;s my word for the arrow) the diameter times 3.14159265.&rdquo;</p>

<p>Remember that to apply a function with no arguments, we wrote <code>(-&gt;)()</code>. To apply a function with an argument (or arguments), we put the argument (or arguments) within the parentheses, like this:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">((</code><code class="n">diameter</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">diameter</code> <code class="o">*</code> 3<code class="p">.</code>14159265<code class="p">)(</code>2<code class="p">)</code>
  #<code class="p">=</code><code class="o">&gt;</code> 6<code class="p">.</code>2831853
</pre></div>

</div>

<p>You won&rsquo;t be surprised to see how to write and apply a function to two arguments:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">((</code><code class="n">room</code><code class="p">,</code> <code class="n">board</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">room</code> <code class="o">+</code> <code class="n">board</code><code class="p">)(</code>800<code class="p">,</code> 150<code class="p">)</code>
  #<code class="p">=</code><code class="o">&gt;</code> 950
</pre></div>

</div>

<div class="tip sidebarish">
  <hr />
  <h4 id="a-quick-summary-of-functions-and-bodies"><img class="sidebar-image" alt="tip" src="images/leanpub_tip.png" />a quick summary of functions and bodies</h4>

  <p>How arguments are used in a body&rsquo;s expression is probably perfectly obvious to you from the examples, especially if you&rsquo;ve used any programming language (except, possibly for the dialect of BASIC I recall from my secondary school that didn&rsquo;t allow parameters when you called a procedure).</p>

  <p>Expressions consist either of representations of values (like <code>3.14159265</code>, <code>true</code>, and <code>undefined</code>), operators that combine expressions (like <code>3 + 2</code>), and some special forms like <code>[1, 2, 3]</code> for creating arrays out of expressions and <code>(</code><em>arguments</em><code>) -&gt;</code><em>body-expression</em> for creating functions.</p>

  <p>This loose definition is recursive, so we can intuit (or use our experience with other languages) that since a function has an expression on its right hand side, we can write a function that has a function as its expression, or an array that contains another array expression. Or a function that gives an array, an array of functions, a function that gives an array of functions, and so forth:</p>

  <div class="code-block">
<div class="highlight"><pre><code class="o">-&gt;</code> <code class="o">-&gt;</code>
<code class="o">-&gt;</code> <code class="p">[</code> <code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">3</code><code class="p">]</code>
<code class="p">[</code><code class="mi">1</code><code class="p">,</code> <code class="p">[</code><code class="mi">2</code><code class="p">,</code> <code class="mi">3</code><code class="p">],</code> <code class="mi">4</code><code class="p">]</code>
<code class="o">-&gt;</code> <code class="p">[(</code><code class="o">-&gt;</code> <code class="mi">1</code><code class="p">),</code> <code class="p">(</code><code class="o">-&gt;</code> <code class="mi">2</code><code class="p">),</code> <code class="p">(</code><code class="o">-&gt;</code> <code class="mi">3</code><code class="p">)]</code>
</pre></div>
  
</div>

  <hr />
</div>

<h4 id="call-by-value">call by value</h4>

<p>Like most contemporary programming languages, CoffeeScript uses the &ldquo;call by value&rdquo; <a href="http://en.wikipedia.org/wiki/Evaluation_strategy">evaluation strategy</a>. That&rsquo;s a $2.75 way of saying that when you write some code that appears to apply a function to an expression or expressions, CoffeeScript evaluates all of those expressions and applies the functions to the resulting value(s).</p>

<p>So when you write:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">((</code><code class="n">diameter</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">diameter</code> <code class="o">*</code> 3<code class="p">.</code>14159265<code class="p">)(</code>1 <code class="o">+</code> 1<code class="p">)</code>
  #<code class="p">=</code><code class="o">&gt;</code> 6<code class="p">.</code>2831853
</pre></div>

</div>

<p>What happened internally is that the expression <code>1 + 1</code> was evaluated first, resulting in <code>2</code>. Then our circumference function was applied to <code>2</code>.<sup id="fnref-f2f"><a href="#fn-f2f" rel="footnote">9</a></sup></p>

<h4 id="variables-and-bindings">variables and bindings</h4>

<p>Right now everything looks simple and straightforward, and we can move on to talk about arguments in more detail. And we&rsquo;re going to work our way up from <code>(diameter) -&gt; diameter * 3.14159265</code> to functions like:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">(</code><code class="n">x</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="p">(</code><code class="n">y</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">x</code>
</pre></div>

</div>

<div class="aside sidebarish">
  <hr />
  <p><code>(x) -&gt; (y) -&gt; x</code> just looks crazy, as if we are learning English as a second language and the teacher promises us that soon we will be using words like <em>antidisestablishmentarianism</em>. Besides a desire to use long words to sound impressive, this is not going to seem attractive until we find ourselves wanting to discuss the role of the Church of England in 19th century British politics.</p>

  <p>But there&rsquo;s another reason for learning the word <em>antidisestablishmentarianism</em>: We might learn how prefixes and postfixes work in English grammar. It&rsquo;s the same thing with <code>(x) -&gt; (y) -&gt; x</code>. It has a certain important meaning in its own right, and it&rsquo;s also an excellent excuse to learn about functions that make functions, environments, variables, and more.</p>

  <hr />
</div>

<p>In order to talk about how this works, we should agree on a few terms (you may already know them, but let&rsquo;s check-in together and &ldquo;synchronize our dictionaries&rdquo;). The first <code>x</code>, the one in <code>(x) -&gt;</code>, is an <em>argument</em>. The <code>y</code> in <code>(y) -&gt;</code> is another argument. The second <code>x</code>, the one in <code>-&gt; x</code>, is not an argument, <em>it&rsquo;s an expression referring to a variable</em>. Arguments and variables work the same way whether we&rsquo;re talking about <code>(x) -&gt; (y) -&gt; x</code>  or just plain <code>(x) -&gt; x</code>.</p>

<p>Every time a function is invoked (&ldquo;invoked&rdquo; is a synonym for &ldquo;applied to zero or more arguments&rdquo;), a new <em>environment</em> is created. An environment is a (possibly empty) dictionary that maps variables to values by name. The <code>x</code> in the expression that we call a &ldquo;variable&rdquo; is itself an expression that is evaluated by looking up the value in the environment.</p>

<p>How does the value get put in the environment? Well for arguments, that is very simple. When you apply the function to the arguments, an entry is placed in the dictionary for each argument. So when we write:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">((</code><code class="n">x</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">x</code><code class="p">)(</code>2<code class="p">)</code>
  #<code class="p">=</code><code class="o">&gt;</code> 2
</pre></div>

</div>

<p>What happens is this:</p>

<ol class="numeric">
  <li>CoffeeScript parses this whole thing as an expression made up of several sub-expressions.</li>
  <li>It then starts evaluating the expression, including evaluating sub-expressions</li>
  <li>One sub-expression, <code>(x) -&gt; x</code> evaluates to a function.</li>
  <li>Another, <code>2</code>, evaluates to the number 2.</li>
  <li>CoffeeScript now evaluates applying the function to the argument <code>2</code>. Here&rsquo;s where it gets interesting&hellip;</li>
  <li>An environment is created.</li>
  <li>The value &lsquo;2&rsquo; is bound to the name &lsquo;x&rsquo; in the environment.</li>
  <li>The expression &lsquo;x&rsquo; (the right side of the function) is evaluated within the environment we just created.</li>
  <li>The value of a variable when evaluated in an environment is the value bound to the variable&rsquo;s name in that environment, which is &lsquo;2&rsquo;</li>
  <li>And that&rsquo;s our result.</li>
</ol>

<p>When we talk about environments, we&rsquo;ll use an <a href="http://json.org/">unsurprising syntax</a> for showing their bindings: <code>{x: 2, ...}</code>. meaning, that the environment is a dictionary, and that the value <code>2</code> is bound to the name <code>x</code>, and that there might be other stuff in that dictionary we aren&rsquo;t discussing right now.</p>

<h4 id="call-by-sharing">call by sharing</h4>

<p>Earlier, we distinguished CoffeeScript&rsquo;s <em>value types</em> from its <em>reference types</em>. At that time, we looked at how CoffeeScript distinguishes objects that are identical from objects that are not. Now it is time to take another look at the distinction between value and reference types.</p>

<p>There is a property that CoffeeScript strictly maintains: When a value&ndash;any value&ndash;is passed as an argument to a function, the value bound in the function&rsquo;s environment must be identical to the original.</p>

<p>We said that CoffeeScript binds names to values, but we didn&rsquo;t say what it means to bind a name to a value. Now we can elaborate: When CoffeeScript binds a name to a value type value, it makes a copy of the value and places the copy in the environment. As you recall, value types like strings and numbers are identical to each other if they have the same content. So CoffeeScript can make as many copies of strings, numbers, or booleans as it wishes.</p>

<p>What about reference types? CoffeeScript cannot place a copy of an array or object in an environment, because the copy would not be identical to the original. So instead, CoffeeScript does not place reference values in any environment. CoffeeScript places <em>references</em> to reference types in environments, and when the value needs to be used, CoffeeScript uses the reference to obtain the original.</p>

<p>Because many references can share the same value, and because CoffeeScript passes references as arguments, CoffeeScript can be said to implement &ldquo;call by sharing&rdquo; semantics. Call by sharing is generally understood to be a specialization of call by value, and it explains why some values are known as value types and other values are known as reference types.</p>

<p>And with that, we&rsquo;re ready to look at <em>closures</em>. When we combine our knowledge of value types, reference types, arguments, and closures, we&rsquo;ll understand why this function always evaluates to <code>true</code> no matter what argument you apply it to:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">(</code><code class="n">value</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="p">((</code><code class="n">copy</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="n">copy</code> <code class="n">is</code> <code class="n">value</code>
  <code class="p">)(</code><code class="n">value</code><code class="p">)</code>
</pre></div>

</div>

<div class="page-break" />
<h3 id="closures">Closures and Scope</h3>

<p>Before we explain <code>(x) -&gt; (y) -&gt; x</code>, we&rsquo;re going to toss in something that doesn&rsquo;t directly affect our explanation, but makes things easier to see <em>visually</em>. Up to now, every function has looked like this: <code>(</code><em>arguments</em><code>) -&gt; </code><em>body</em>. There&rsquo;s another way to write functions. For example here&rsquo;s the other way to write <code>(x) -&gt; x</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">(</code><code class="n">x</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="n">x</code>
</pre></div>

</div>

<p>You get the idea: You can indent the body instead of putting it on the same line. Let&rsquo;s introduce a new term: <code>(x) -&gt;</code> is the function&rsquo;s <em>signature</em>, and <code>x</code> is its <em>body</em>, just as we&rsquo;ve mentioned before.</p>

<p>That means inductively we can also write <code>(x) -&gt; (y) -&gt; x</code> in two other ways:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">(</code><code class="n">x</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="p">(</code><code class="n">y</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">x</code>
</pre></div>

</div>

<p>Or:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">(</code><code class="n">x</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="p">(</code><code class="n">y</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="n">x</code>
</pre></div>

</div>

<p>The indents help us see that the <code>x</code> is the body &ldquo;belonging to&rdquo; a function with signature <code>(y) -&gt;</code>, and that it belongs to a function with signature <code>(x) -&gt;</code>.</p>

<p>Time to see how a function within a function works:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">((</code><code class="n">x</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="p">(</code><code class="n">y</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="n">x</code>
<code class="p">)(</code>1<code class="p">)(</code>2<code class="p">)</code>
  #<code class="p">=</code><code class="o">&gt;</code> 1
</pre></div>

</div>

<p>First off, let&rsquo;s use what we learned above. Given <code>(</code><em>some function</em><code>)(</code><em>some argument</em><code>)</code>, we know that we apply the function to the argument, create an environment, bind the value of the argument to the name, and evaluate the function&rsquo;s expression. So we do that first with this code:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">((</code><code class="n">x</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="p">(</code><code class="n">y</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="n">x</code>
<code class="p">)(</code>1<code class="p">)</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="p">[</code><code class="n">Function</code><code class="p">]</code>
</pre></div>

</div>

<p>The environment belonging to the function with signature <code>(x) -&gt;</code> becomes <code>{x: 1, ...}</code>, and the result of applying the function is another function value. It makes sense that the result value is a function, because the expression for <code>(x) -&gt;</code>&rsquo;s body is:</p>

<div class="code-block">
<div class="highlight"><pre>  <code class="p">(</code><code class="n">y</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="n">x</code>
</pre></div>

</div>

<p>So now we have a value representing that function. Then we&rsquo;re going to take the value of that function and apply it to the argument <code>2</code>, something like this:</p>

<div class="code-block">
<div class="highlight"><pre>  <code class="p">((</code><code class="n">y</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="n">x</code><code class="p">)(</code>2<code class="p">)</code>
</pre></div>

</div>

<p>So we seem to get a new environment <code>{y: 2, ...}</code>. How is the expression <code>x</code> going to be evaluated in that function&rsquo;s environment? There is no <code>x</code> in its environment, it must come from somewhere else.</p>

<div class="aside sidebarish">
  <hr />
  <p>This, by the way, is one of the great defining characteristic of CoffeeScript and languages in the same family: Whether they allow things like functions to nest inside each other, and if so, how they handle variables from &ldquo;outside&rdquo; of a function that are referenced inside a function. For example, here&rsquo;s the equivalent code in Ruby:</p>

  <div class="code-block">
<div class="highlight"><pre><code class="nb">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">x</code><code class="o">|</code>
  <code class="nb">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">y</code><code class="o">|</code> <code class="n">x</code> <code class="p">}</code>
<code class="p">}</code><code class="o">[</code><code class="mi">1</code><code class="o">][</code><code class="mi">2</code><code class="o">]</code>
  <code class="c1">#=&gt; 1</code>
</pre></div>
  
</div>

  <p>Now let&rsquo;s have an Espresso before we continue!</p>

  <hr />
</div>

<h4 id="if-functions-without-free-variables-are-pure-are-closures-impure">If functions without free variables are pure, are closures impure?</h4>

<p>The function <code>(y) -&gt; x</code> is interesting. It contains a <em>free variable</em>, <code>x</code>.<sup id="fnref-nonlocal"><a href="#fn-nonlocal" rel="footnote">10</a></sup> A free variable is one that is not bound within the function. Up to now, we&rsquo;ve only seen one way to &ldquo;bind&rdquo; a variable, namely by passing in an argument with the same name. Since the function <code>(y) -&gt; x</code> doesn&rsquo;t have an argument named <code>x</code>, the variable <code>x</code> isn&rsquo;t bound in this function, which makes it &ldquo;free.&rdquo;</p>

<p>Now that we know that variables used in a function are either bound or free, we can bifurcate functions into those with free variables and those without:</p>

<ul>
  <li>Functions containing no free variables are called <em>pure functions</em>.</li>
  <li>Functions containing one or more free variables are called <em>closures</em>.</li>
</ul>

<p>Pure functions are easiest to understand. They always mean the same thing wherever you use them. Here are some pure functions we&rsquo;ve already seen:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">-&gt;</code>

<code class="p">(</code><code class="n">x</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="n">x</code>
  
<code class="p">(</code><code class="n">x</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="p">(</code><code class="n">y</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="n">x</code>
</pre></div>

</div>

<p>The first function doesn&rsquo;t have any variables, therefore doesn&rsquo;t have any free variables. The second doesn&rsquo;t have any free variables, because its only variable is bound. The third one is actually two functions, one in side the other. <code>(y) -&gt;</code> has a free variable, but the entire expression refers to <code>(x) -&gt;</code>, and it doesn&rsquo;t have a free variable: The only variable anywhere in its body is <code>x</code>, which is certainly bound within <code>(x) -&gt;</code>.</p>

<p>From this, we learn something: A pure function can contain a closure.</p>

<div class="exercise sidebarish">
  <hr />
  <p><img class="sidebar-image" alt="exercise" src="images/leanpub_exercise.png" />If pure functions can contain closures, can a closure contain a pure function? Using only what we&rsquo;ve learned so far, attempt to compose a closure that contains a pure function. If you can&rsquo;t, give your reasoning for why it&rsquo;s impossible.</p>

  <hr />
</div>

<p>Pure functions always mean the same thing because all of their &ldquo;inputs&rdquo; are fully defined by their arguments. Not so with a closure. If I present to you this free function <code>(x, y) -&gt; x + y</code>, we know exactly what it does with <code>(2, 2)</code>. But what about this closure: <code>(y) -&gt; x + y</code>? We can&rsquo;t say what it will do with argument <code>(2)</code> without understanding the magic for evaluating the free variable <code>x</code>.</p>

<h4 id="its-always-the-environment">it&rsquo;s always the environment</h4>

<p>To understand how closures are evaluated, we need to revisit environments. As we&rsquo;ve said before, all functions are associated with an environment. We also hand-waved something when describing our environment. Remember that we said the environment for <code>((x) -&gt; (y) -&gt; x)(1)</code> is <code>{x: 1, ...}</code> and that the environment for <code>((y) -&gt; x)(2)</code> is <code>{y: 2, ...}</code>? Let&rsquo;s fill in the blanks!</p>

<p>The environment for <code>((y) -&gt; x)(2)</code> is <em>actually</em> <code>{y: 2, '..': {x: 1, ...}}</code>. <code>'..'</code> means something like &ldquo;parent&rdquo; or &ldquo;enclosure&rdquo; or &ldquo;super-environment.&rdquo; It&rsquo;s <code>(x) -&gt;</code>&rsquo;s environment, because the function <code>(y) -&gt; x</code> is within <code>(x) -&gt;</code>&rsquo;s body. So whenever a function is applied to arguments, its environment always has a reference to its parent environment.</p>

<p>And now you can guess how we evaluate <code>((y) -&gt; x)(2)</code> in the environment <code>{y: 2, '..': {x: 1, ...}}</code>. The variable <code>x</code> isn&rsquo;t in <code>(y) -&gt;</code>&rsquo;s immediate environment, but it is in its parent&rsquo;s environment, so it evaluates to <code>1</code> and that&rsquo;s what <code>((y) -&gt; x)(2)</code> returns even though it ended up ignoring its own argument.</p>

<div class="aside sidebarish">
  <hr />
  <p><code>(x) -&gt; x</code> is called the I Combinator or Identity Function. <code>(x) -&gt; (y) -&gt; x</code> is called the K Combinator or Kestrel. Some people get so excited by this that they write entire books about them, some are <a href="http://www.amzn.com/0192801422?tag=raganwald001-20">great</a>, some&ndash;how shall I put this&ndash;are <a href="https://leanpub.com/combinators" title="Kestrels, Quirky Birds, and Hopeless Egocentricity">interesting</a> if you use Ruby.</p>

  <hr />
</div>

<p>Functions can have grandparents too:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">(</code><code class="n">x</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="p">(</code><code class="n">y</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="p">(</code><code class="n">z</code><code class="p">)</code> <code class="o">-&gt;</code>
      <code class="n">x</code> <code class="o">+</code> <code class="n">y</code> <code class="o">+</code> <code class="n">z</code>
</pre></div>

</div>

<p>This function does much the same thing as:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">(</code><code class="n">x</code><code class="p">,</code> <code class="n">y</code><code class="p">,</code> <code class="n">z</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="n">x</code> <code class="o">+</code> <code class="n">y</code> <code class="o">+</code> <code class="n">z</code>
</pre></div>

</div>

<p>Only you call it with <code>(1)(2)(3)</code> instead of <code>(1, 2, 3)</code>. The other big difference is that you can call it with <code>(1)</code> and get a function back that you can later call with <code>(2)(3)</code>.</p>

<div class="page-break" />
<div class="aside sidebarish">
  <hr />
  <p>The first function is the result of <a href="https://en.wikipedia.org/wiki/Currying">currying</a> the second function. Calling a curried function with only some of its arguments is sometimes called <a href="https://en.wikipedia.org/wiki/Partial_application">partial application</a>. Some programming languages automatically curry and partially evaluate functions without the need to manually nest them.</p>

  <hr />
</div>

<h4 id="shadowy-variables-from-a-shadowy-planet">shadowy variables from a shadowy planet</h4>

<p>An interesting thing happens when a variable has the same name as an ancestor environment&rsquo;s variable. Consider:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">(</code><code class="n">x</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="p">(</code><code class="n">x</code><code class="p">,</code> <code class="n">y</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="n">x</code> <code class="o">+</code> <code class="n">y</code>
</pre></div>

</div>

<p>The function <code>(x, y) -&gt; x + y</code> is a pure function, because its <code>x</code> is defined within its own environment. Although its parent also defines an <code>x</code>, it is ignored when evaluating <code>x + y</code>. CoffeeScript always searches for a binding starting with the functions own environment and then each parent in turn until it finds one. The same is true of:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">(</code><code class="n">x</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="p">(</code><code class="n">x</code><code class="p">,</code> <code class="n">y</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="p">(</code><code class="n">w</code><code class="p">,</code> <code class="n">z</code><code class="p">)</code> <code class="o">-&gt;</code>
      <code class="p">(</code><code class="n">w</code><code class="p">)</code> <code class="o">-&gt;</code>
        <code class="n">x</code> <code class="o">+</code> <code class="n">y</code> <code class="o">+</code> <code class="n">z</code>
</pre></div>

</div>

<p>When evaluating <code>x + y + z</code>, CoffeeScript will find <code>x</code> and <code>y</code> in the great-grandparent scope and <code>z</code> in the parent scope. The <code>x</code> in the great-great-grandparent scope is ignored, as are both <code>w</code>s. When a variable has the same name as an ancestor environment&rsquo;s binding, it is said to <em>shadow</em> the ancestor.</p>

<p>There can be spirited discussions over shadowing variables. Some people argue that shadowing is a good thing, as it allows small pieces of code to be understood without checking any enclosing environments. Others argue that it&rsquo;s a bad thing, as it creates a confusing situation where two things with the same name actually are different things, a lot like naming both of your twins &ldquo;Lesley.&rdquo;</p>

<h4 id="which-came-first-the-chicken-or-the-egg">which came first, the chicken or the egg?</h4>

<p>This behaviour of pure functions and closures has many, many consequences that can be exploited to write software. We are going to explore them in some detail as well as look at some of the other mechanisms CoffeeScript provides for working with variables and mutable state.</p>

<p>But before we do so, there&rsquo;s one final question: Where does the ancestry start? If there&rsquo;s no other code in a file, what is <code>(x) -&gt; x</code>&rsquo;s parent environment?</p>

<p>CoffeeScript always has the notion of at least one environment we do not control: A global environment in which many useful things are bound such as libraries full of standard functions. So when you invoke <code>((x) -&gt; x)(1)</code> in the REPL, its full environment is going to look like this: <code>{x: 1, '..': </code><em>global environment</em><code>}</code>. When you use CoffeeScript to compile physical files for use in node or web applications, CoffeeScript does something interesting: It wraps your code in an invisible function, like this:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">(</code><code class="o">-&gt;</code>
  <code class="p">((</code><code class="n">x</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">x</code><code class="p">)(</code>1<code class="p">)</code>
  <code class="p">)()</code>
</pre></div>

</div>

<p>The effect of this is to insert a new, empty environment in between the global environment and your own functions: <code>{x: 1, '..': {'..': </code><em>global environment</em><code>}}</code>. As we&rsquo;ll see when we discuss mutable state, this helps to prevent programmers from accidentally changing the global state that is shared by code in every file.</p>

<div class="page-break" />
<h3 id="summary">Summary</h3>

<div class="tip sidebarish">
  <hr />
  <h4 id="functions"><img class="sidebar-image" alt="tip" src="images/leanpub_tip.png" />Functions</h4>

  <ul>
    <li>Functions are values that can be part of expressions, returned from other functions, and so forth.</li>
    <li>Functions are <em>reference values</em>.</li>
    <li>Functions are applied to arguments.</li>
    <li>The arguments are passed by sharing, which is also called &ldquo;pass by value.&rdquo;</li>
    <li>Function bodies have zero or more expressions.</li>
    <li>Function application evaluates to the value of the last expression evaluated or <code>undedfined</code>.</li>
    <li>Function application creates a scope. Scopes are nested and free variable references closed over.</li>
    <li>Variables can shadow variables in an enclosing scope.</li>
  </ul>

  <hr />
</div>

<h2 id="more-functions">Slurp: More About Functions and Scope</h2>

<div class="image-with-caption">
  <p><img src="images/diplomatico.jpg" alt="Cafe Diplomatico in Toronto's Little Italy" />
  <p>Cafe Diplomatico in Toronto's Little Italy</p>
</div>

<div class="page-break" />
<h3 id="let-me-show-you-what-to-do">Let Me Show You What To Do</h3>

<h4 id="let">let</h4>

<p>Up to now, all we&rsquo;ve really seen are <em>anonymous functions</em>, functions that don&rsquo;t have a name. This feels very different from programming in most other languages, where  the focus is on naming functions, methods, and procedures. Naming things is a critical part of programming, but all we&rsquo;ve seen so far is how to name arguments.</p>

<p>There are other ways to name things in CoffeeScript, but before we learn some of those, let&rsquo;s see how to use what we already have to name things. Let&rsquo;s revisit a very simple example:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">(</code><code class="n">diameter</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="n">diameter</code> <code class="o">*</code> 3<code class="p">.</code>14159265
</pre></div>

</div>

<p>What is this &ldquo;3.14159265&rdquo; number? <a href="https://en.wikipedia.org/wiki/Pi">Pi</a>, obviously. We&rsquo;d like to name it so that we can write something like:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">(</code><code class="n">diameter</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="n">diameter</code> <code class="o">*</code> <code class="n">Pi</code>
</pre></div>

</div>

<p>In order to bind <code>3.14159265</code> to the name <code>Pi</code>, we&rsquo;ll need a function with a parameter of <code>Pi</code> and an argument of <code>3.14159265</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">((</code><code class="n">Pi</code><code class="p">)</code> <code class="o">-&gt;</code>
  ???
<code class="p">)(</code>3<code class="p">.</code>14159265<code class="p">)</code>
</pre></div>

</div>

<p>What do we put inside our new function that binds <code>3.14159265</code> to the name <code>Pi</code> when evaluated? Our circumference function, of course:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">((</code><code class="n">Pi</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="p">(</code><code class="n">diameter</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="n">diameter</code> <code class="o">*</code> <code class="n">Pi</code>
<code class="p">)(</code>3<code class="p">.</code>14159265<code class="p">)</code>
</pre></div>

</div>

<p>This expression, when evaluated, returns a function that calculates circumferences. It differs from our original in that it names the constant Pi. Let&rsquo;s test it:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">((</code><code class="n">Pi</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="p">(</code><code class="n">diameter</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="n">diameter</code> <code class="o">*</code> <code class="n">Pi</code>
<code class="p">)(</code>3<code class="p">.</code>14159265<code class="p">)(</code>2<code class="p">)</code>
  #<code class="p">=</code><code class="o">&gt;</code> 6<code class="p">.</code>2831853
</pre></div>

</div>

<p>That works! We can bind anything we want and use it in a function by wrapping the function in another function that is immediately invoked with the value we want to bind. This &ldquo;functional programming pattern&rdquo; was popularized in the Lisp programming language more than 50 years ago, where it is called <a href="http://jtra.cz/stuff/lisp/sclr/let.html"><code>let</code></a>.<sup id="fnref-let"><a href="#fn-let" rel="footnote">11</a></sup> Although CoffeeScript doesn&rsquo;t have a <code>let</code> keyword, when we discuss this programming pattern we will call it <code>let</code>.</p>

<p><code>let</code> works,<sup id="fnref-letrec"><a href="#fn-letrec" rel="footnote">12</a></sup> but only a masochist would write programs this way in CoffeeScript. Besides all the extra characters, it suffers from a fundamental semantic problem: there is a big visual distance between the name <code>Pi</code> and the value <code>3.14159265</code> we bind to it. They should be closer. Is there another way?</p>

<p>Yes.</p>

<h4 id="do">do</h4>

<p>CoffeeScript programmers often wish to create a new environment and bind some values to names within it as <code>let</code> does. To make this easier to read and write, CoffeeScript provides some <em>syntactic sugar</em> called <code>do</code>.<sup id="fnref-ssugar"><a href="#fn-ssugar" rel="footnote">13</a></sup></p>

<div class="image-with-caption">
  <p><img src="images/sugarservice.jpg" alt="Italians seem to prefer espresso with plenty of sugar, while North Americans often drink it without" />
  <p>Italians seem to prefer espresso with plenty of sugar, while North Americans often drink it without</p>
</div>

<p>This is what our example looks like using <code>do</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">do</code> <code class="p">(</code><code class="n">Pi</code> <code class="p">=</code> 3<code class="p">.</code>14159265<code class="p">)</code> <code class="o">-&gt;</code>
  <code class="p">(</code><code class="n">diameter</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="n">diameter</code> <code class="o">*</code> <code class="n">Pi</code>
</pre></div>

</div>

<p>Much, MUCH cleaner.</p>

<p>If you need to create more than one binding, you separate them with commas:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">do</code> <code class="p">(</code><code class="n">republican</code> <code class="p">=</code> <code class="s">&#39;Romney&#39;</code><code class="p">,</code> <code class="n">democrat</code> <code class="p">=</code> <code class="s">&#39;Obama&#39;</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="n">democrat</code>
</pre></div>

</div>

<div class="exercise sidebarish">
  <hr />
  <p><img class="sidebar-image" alt="exercise" src="images/leanpub_exercise.png" />The value on the right side can be any expression. Try this for yourself:</p>

  <div class="code-block">
<div class="highlight"><pre><code class="nx">do</code> <code class="p">(</code><code class="nv">Pi = </code><code class="mf">3.14159265</code><code class="p">,</code> <code class="nv">diameter = </code><code class="nf">(radius) -&gt;</code> <code class="nx">radius</code> <code class="o">*</code> <code class="mi">2</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="nf">(radius) -&gt;</code>
    <code class="nx">diameter</code><code class="p">(</code><code class="nx">radius</code><code class="p">)</code> <code class="o">*</code> <code class="nx">Pi</code>
</pre></div>
  
</div>

  <hr />
</div>

<p>Did you try the example above? Did you notice what we slipped in? Yes, obviously, the value of a binding can be any expression. But notice also that we can invoke a function on any expression evaluating to a function, including a variable that looks up a binding in the environment.</p>

<div class="aside sidebarish">
  <hr />
  <p>Dozens of pages into the book, we&rsquo;re finally calling a function the way you&rsquo;ll see functions being called in most production code. Sheesh.</p>

  <hr />
</div>

<div class="page-break" />
<h3 id="a-simple-question">A Simple Question</h3>

<p>Both of the following produce the exact same result:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">do</code> <code class="p">(</code><code class="n">Pi</code> <code class="p">=</code> 3<code class="p">.</code>14159265<code class="p">)</code> <code class="o">-&gt;</code>
  <code class="p">(</code><code class="n">diameter</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="n">diameter</code> <code class="o">*</code> <code class="n">Pi</code>
</pre></div>

</div>

<p>And:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">(</code><code class="n">diameter</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="n">do</code> <code class="p">(</code><code class="n">Pi</code> <code class="p">=</code> 3<code class="p">.</code>14159265<code class="p">)</code> <code class="o">-&gt;</code>
    <code class="n">diameter</code> <code class="o">*</code> <code class="n">Pi</code>
</pre></div>

</div>

<p>Why do we habitually prefer the former?</p>

<p>To understand this, we&rsquo;re going to take a simple step towards more complex, state-full programs by introducing sequences of expressions. If we had no other tools, we could evaluate a series of expressions with some legerdemain like this:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">do</code> <code class="p">(</code><code class="n">ignore1</code> <code class="p">=</code> <code class="n">foo</code><code class="p">(),</code>
    <code class="n">ignore2</code> <code class="p">=</code> <code class="n">bar</code><code class="p">(),</code>
    <code class="n">ignore3</code> <code class="p">=</code> <code class="n">blitz</code><code class="p">(),</code>
    <code class="n">value</code> <code class="p">=</code> <code class="n">bash</code><code class="p">())</code> <code class="o">-&gt;</code>
  <code class="n">bash</code>
</pre></div>

</div>

<p>Or perhaps like this:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">do</code> <code class="p">(</code><code class="n">ignore</code> <code class="p">=</code> <code class="p">[</code><code class="n">foo</code><code class="p">(),</code>  <code class="n">bar</code><code class="p">(),</code> <code class="n">blitz</code><code class="p">()],</code> <code class="n">value</code> <code class="p">=</code> <code class="n">bash</code><code class="p">())</code> <code class="o">-&gt;</code>
  <code class="n">bash</code>
</pre></div>

</div>

<p>Or even this:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">[</code>
  <code class="n">foo</code><code class="p">()</code>
  <code class="n">bar</code><code class="p">()</code>
  <code class="n">blitz</code><code class="p">()</code> <code class="p">]</code> <code class="n">and</code> <code class="n">bash</code><code class="p">()</code>
</pre></div>

</div>

<p>Any of these would evaluate <code>foo()</code>, <code>bar()</code>, <code>blitz()</code>, and then return the value of <code>bash()</code> (whatever they might be).</p>

<div class="exercise sidebarish">
  <hr />
  <p><img class="sidebar-image" alt="exercise" src="images/leanpub_exercise.png" />Why doesn&rsquo;t <code>foo() and bar() and blitz() and bash()</code> work reliably?</p>

  <hr />
</div>

<p>But let&rsquo;s learn another handy CoffeeScript feature, again because it helps us focus on what is actually going on. Whenever you want to work with the body of a function, you can always have it evaluate a simple sequence of one or more expressions by indenting them. The value of the body is the value of the final expression.</p>

<p>So in that case, we can write something like:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">do</code> <code class="o">-&gt;</code>
  <code class="n">foo</code><code class="p">()</code>
  <code class="n">bar</code><code class="p">()</code>
  <code class="n">blitz</code><code class="p">()</code>
  <code class="n">bash</code><code class="p">()</code>
</pre></div>

</div>

<p>Anywhere a simple expression is allowed, you could use a <code>do</code> with a sequence. This doesn&rsquo;t come up as much as you might think, because many of the places you want to do this, CoffeeScript already lets you indent and include more than one expression. For example, in a function body:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">(</code><code class="n">foo</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="n">bar</code><code class="p">(</code><code class="n">foo</code><code class="p">)</code>
  <code class="n">bash</code><code class="p">(</code><code class="n">foo</code><code class="p">)</code>
  <code class="n">foo</code><code class="p">(</code><code class="s">&#39;blitz&#39;</code><code class="p">)</code>
</pre></div>

</div>

<p>So back to our question. Here&rsquo;s a test framework:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">do</code> <code class="p">(</code><code class="n">circumference</code> <code class="p">=</code> <code class="n">do</code> <code class="p">(</code><code class="n">Pi</code> <code class="p">=</code> 3<code class="p">.</code>14159265<code class="p">)</code> <code class="o">-&gt;</code>
                      <code class="p">(</code><code class="n">diameter</code><code class="p">)</code> <code class="o">-&gt;</code>
                        <code class="n">diameter</code> <code class="o">*</code> <code class="n">Pi</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="n">circumference</code><code class="p">(</code>1<code class="p">)</code>
  <code class="n">circumference</code><code class="p">(</code>2<code class="p">)</code>
  <code class="n">circumference</code><code class="p">(</code>3<code class="p">)</code>
  <code class="n">circumference</code><code class="p">(</code>4<code class="p">)</code>
  <code class="n">circumference</code><code class="p">(</code>5<code class="p">)</code>
  <code class="n">circumference</code><code class="p">(</code>6<code class="p">)</code>
  <code class="n">circumference</code><code class="p">(</code>7<code class="p">)</code>
  <code class="n">circumference</code><code class="p">(</code>8<code class="p">)</code>
  <code class="n">circumference</code><code class="p">(</code>9<code class="p">)</code>
  <code class="n">circumference</code><code class="p">(</code>10<code class="p">)</code>
    #<code class="p">=</code><code class="o">&gt;</code> 31<code class="p">.</code>4159265
</pre></div>

</div>

<p>Let&rsquo;s think about how many functions we are invoking. When this is first invoked, We invoke the outer <code>do (circumference = (...) -&gt;</code>. As part of doing that, we invoke <code>do (Pi = 3.14159265) -&gt;</code> and bind the result to <code>circumference</code>. Then every time we invoke <code>circumference</code>, we invoke <code>(diameter) -&gt;</code>. All together, twelve.</p>

<p>But with:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">do</code> <code class="p">(</code><code class="n">circumference</code> <code class="p">=</code> <code class="p">(</code><code class="n">diameter</code><code class="p">)</code> <code class="o">-&gt;</code>
                      <code class="n">do</code> <code class="p">(</code><code class="n">Pi</code> <code class="p">=</code> 3<code class="p">.</code>14159265<code class="p">)</code> <code class="o">-&gt;</code>
                        <code class="n">diameter</code> <code class="o">*</code> <code class="n">Pi</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="n">circumference</code><code class="p">(</code>1<code class="p">)</code>
  <code class="n">circumference</code><code class="p">(</code>2<code class="p">)</code>
  <code class="n">circumference</code><code class="p">(</code>3<code class="p">)</code>
  <code class="n">circumference</code><code class="p">(</code>4<code class="p">)</code>
  <code class="n">circumference</code><code class="p">(</code>5<code class="p">)</code>
  <code class="n">circumference</code><code class="p">(</code>6<code class="p">)</code>
  <code class="n">circumference</code><code class="p">(</code>7<code class="p">)</code>
  <code class="n">circumference</code><code class="p">(</code>8<code class="p">)</code>
  <code class="n">circumference</code><code class="p">(</code>9<code class="p">)</code>
  <code class="n">circumference</code><code class="p">(</code>10<code class="p">)</code>
    #<code class="p">=</code><code class="o">&gt;</code> 31<code class="p">.</code>4159265
</pre></div>

</div>

<p>What happens? There&rsquo;s one outer <code>do (circumference = (...) -&gt;</code>, same as before. And then every time we invoke <code>circumference</code>, we also invoke <code>do (Pi = 3.14159265) -&gt;</code>, so we have a total of twenty-one function invocations. This is nearly twice as expensive.</p>

<div class="page-break" />
<h3 id="making-things-easy">Making Things Easy</h3>

<p>In <em>CoffeeScript Ristretto</em>, we are focusing on CoffeeScript&rsquo;s <em>semantics</em>, the meaning of CoffeeScript programs. As we go along, we&rsquo;re learning just enough CoffeeScript to understand the next concept simply and directly.</p>

<p>CoffeeScript actually supports a number of syntactic conveniences for making programs extremely readable, by which we mean, making them communicate their intent without asking the programmer to struggle in a <a href="https://en.wikipedia.org/wiki/Turing_tarpit">Turing Tarpit</a>, no matter how elegant.</p>

<h4 id="if-i-were-a-rich-man">if i were a rich man</h4>

<p>For example, it is possible to implement boolean logic using functions, by carefully combining the Identity (<code>(x) -&gt; x</code>), Kestrel (<code>(x) -&gt; (y) -&gt; x</code>), and Vireo (<code>(x) -&gt; (y) -&gt; (z) -&gt; z(x(y))</code>) functions using a clever trick. It look something like this:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">do</code> <code class="p">(</code><code class="n">I</code> <code class="p">=</code> <code class="p">((</code><code class="n">x</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">x</code><code class="p">),</code>
    <code class="n">K</code> <code class="p">=</code> <code class="p">((</code><code class="n">x</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="p">(</code><code class="n">y</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">x</code><code class="p">),</code>
    <code class="n">V</code> <code class="p">=</code> <code class="p">((</code><code class="n">x</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="p">(</code><code class="n">y</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="p">(</code><code class="n">z</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">z</code><code class="p">(</code><code class="n">x</code><code class="p">(</code><code class="n">y</code><code class="p">)))</code>
<code class="p">)</code> <code class="o">-&gt;</code>
  <code class="n">do</code> <code class="p">(</code><code class="n">t</code> <code class="p">=</code> <code class="n">K</code><code class="p">,</code> <code class="n">f</code> <code class="p">=</code> <code class="n">K</code><code class="p">(</code><code class="n">I</code><code class="p">))</code> <code class="o">-&gt;</code>
    # <code class="p">...</code>
    # <code class="n">implement</code> <code class="n">logical</code> <code class="n">operators</code> <code class="n">here</code>
    # <code class="p">...</code>
</pre></div>

</div>

<div class="aside sidebarish">
  <hr />
  <p>Did you notice that I slipped a new language feature in, one that allegedly allows a programmer to communicate their intent? Comments in CoffeeScript are signalled by a <code>#</code> and continue to the end of the line, much like <code>//</code> in C++ or JavaScript, and exactly like <code>#</code> in Ruby. If you have ever used <code>C</code> to make a comment line in FORTRAN, you are a <a href="http://www.pbm.com/~lindahl/real.programmers.html" title="Real Programmers Don't Use Pascal">real programmer</a> and ought not to be fooling around with a quiche-eater&rsquo;s language.</p>

  <hr />
</div>

<p>This is extraordinarily fascinating computer science stuff, but you can read about that <a href="http://www.amzn.com/0192801422?tag=raganwald001-20" title="To Mock a Mockingbird">elsewhere</a>. CoffeeScript supplies <code>true</code>, <code>false</code>, <code>and</code>, <code>or</code>, and <code>not</code> so you don&rsquo;t need to roll your own out of functions. But while we&rsquo;re talking about logic, CoffeeScript also supplies conditional branches of execution, and we&rsquo;ll use those in examples to come.</p>

<p>The syntax is remarkably simple. Here&rsquo;s a <a href="http://coffeescript.org/#conditionals">conditional expression</a>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">if</code> <code class="n">d</code> <code class="o">&lt;</code> 32 <code class="n">then</code> <code class="s">&#39;freezing&#39;</code> <code class="k">else</code> <code class="s">&#39;warm&#39;</code>
</pre></div>

</div>

<p>Since it&rsquo;s an expression, you can put it in parentheses and stick it anywhere you like, including inside another conditional:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">(</code><code class="n">d</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="k">if</code> <code class="n">d</code> <code class="o">&lt;</code> 32 <code class="n">then</code> <code class="s">&#39;solid&#39;</code> <code class="k">else</code> <code class="k">if</code> <code class="n">d</code> <code class="o">&lt;</code> 212 <code class="n">then</code> <code class="s">&#39;liquid&#39;</code> <code class="k">else</code> <code class="s">&#39;gas&#39;</code>
</pre></div>

</div>

<p>Like function bodies, there is an indented form that can be more readable:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">(</code><code class="n">d</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="k">if</code> <code class="n">d</code> <code class="o">&lt;</code> 32
    <code class="s">&#39;solid&#39;</code>
  <code class="k">else</code>
    <code class="k">if</code> <code class="n">d</code> <code class="o">&lt;</code> 212
      <code class="s">&#39;liquid&#39;</code>
    <code class="k">else</code>
      <code class="s">&#39;gas&#39;</code>
</pre></div>

</div>

<p>And the indented lines can have multiple expressions should you so desire:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">if</code> <code class="n">frobbish</code>?
  <code class="n">alert</code><code class="p">(</code>&quot;<code class="n">Frobbish</code> <code class="n">value</code><code class="p">:</code> #<code class="p">{</code><code class="n">frobbish</code><code class="p">}</code>&quot;<code class="p">)</code>
  <code class="n">snarglivate</code><code class="p">(</code><code class="n">frobbish</code><code class="p">)</code>
  <code class="n">frobbish</code>
</pre></div>

</div>

<div class="page-break" />
<div class="page-break" />
<h3 id="summary-1">Summary</h3>

<div class="tip sidebarish">
  <hr />
  <h4 id="more-about-functions-and-scope"><img class="sidebar-image" alt="tip" src="images/leanpub_tip.png" />More About Functions And Scope</h4>

  <ul>
    <li><code>let</code> is an idiom where we create a function and call it immediately in order to bind values to names.</li>
    <li>CoffeeScript uses <code>do</code> as syntactic sugar for <code>let</code>.</li>
    <li>CoffeeScript&rsquo;s comments are signalled with <code>#</code>.</li>
    <li>CoffeeScript has <code>if</code>, <code>then</code>, <code>'else</code> and boolean logic.</li>
  </ul>

  <hr />
</div>

<div class="page-break" />
<h4 id="interlude-1">interlude&hellip;</h4>

<div class="image-with-caption">
  <p><img src="images/mirage.jpg" alt="A beautiful espresso machine" />
  <p>A beautiful espresso machine</p>
</div>

<p><a href="http://www.ineedcoffee.com/07/ristretto-rant/">Michael Allen Smith</a> on Ristretto:</p>

<blockquote>
  <p>&ldquo;It must have been 1996. I was living in South Tampa at the time and the area finally got a great coffee house. The place was Jet City Espresso. Don&rsquo;t go looking for it. It is no longer there. As the name implies, the owner Jessica was from Seattle and shared her coffee knowledge with her customers. After ordering numerous americanos and espressos, Jessica thought it was time I tried a ristretto. I expected the short pull of the espresso shot would result in a more bitter flavor. To my delight the shot was actually a sweeter and more intense version of her espresso blend.&rdquo;</p>
</blockquote>

<div class="page-break" />
<h2 id="poco">References, Identity, Arrays, and Objects</h2>

<h4 id="a-simple-question-1">a simple question</h4>

<p>Consider this code:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">do</code> <code class="p">(</code><code class="n">x</code> <code class="p">=</code> <code class="s">&#39;June 14, 1962&#39;</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="n">do</code> <code class="p">(</code><code class="n">y</code> <code class="p">=</code> <code class="n">x</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="n">x</code> <code class="n">is</code> <code class="n">y</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code>
</pre></div>

</div>

<p>This makes obvious sense, because we know that strings are a value type, so no matter what expression you use to derive the value &lsquo;June 14, 1962&rsquo;, you are going to get a string with the exact same identity.</p>

<p>But what about this code?</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">do</code> <code class="p">(</code><code class="n">x</code> <code class="p">=</code> <code class="p">[</code>2012<code class="p">,</code> 6<code class="p">,</code> 14<code class="p">])</code> <code class="o">-&gt;</code>
    <code class="n">do</code> <code class="p">(</code><code class="n">y</code> <code class="p">=</code> <code class="n">x</code><code class="p">)</code> <code class="o">-&gt;</code>
      <code class="n">x</code> <code class="n">is</code> <code class="n">y</code>
    #<code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code>
</pre></div>

</div>

<p>Also true, even though we know that every time we evaluate an expression such as <code>[2012, 6, 14]</code>, we get a new array with a new identity. So what is happening in our environments?</p>

<h4 id="arguments-and-references">arguments and references</h4>

<p>In our discussion of <a href="#closures">closures</a>, we said that environments bind values (like <code>[2012, 6, 14]</code>) to names (like <code>x</code> and <code>y</code>), and that when we use these names as expressions, the name evaluates as the value.</p>

<p>What this means is that when we write something like <code>do (y = x) -&gt;</code>, the name <code>x</code> is looked up in the current environment, and its value is a specific array that was created when the expression <code>[2012, 6, 14]</code> was first evaluated. We then bind <em>that exact same value</em> to the name <code>y</code> in a new environment, and thus <code>x</code> and <code>y</code> are both bound to the exact same value, which is identical to itself.</p>

<p>The same thing happens with binding a variable through a more conventional means of applying a function to arguments:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">do</code> <code class="p">(</code><code class="n">x</code> <code class="p">=</code> <code class="p">[</code>2012<code class="p">,</code> 6<code class="p">,</code> 14<code class="p">])</code> <code class="o">-&gt;</code>
  <code class="p">((</code><code class="n">y</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="n">x</code> <code class="n">is</code> <code class="n">y</code><code class="p">)(</code><code class="n">x</code><code class="p">)</code>
    #<code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code>
</pre></div>

</div>

<p><code>x</code> and <code>y</code> both end up bound to the exact same array, not two different arrays that look the same to our eyes.</p>

<div class="page-break" />
<h3 id="arguments-and-arrays">arguments and arrays</h3>

<p>CoffeeScript provides two different kinds of containers for values. We&rsquo;ve met one already, the array. Let&rsquo;s see how it treats values and identities. For starters, we&rsquo;ll learn how to extract a value from an array. We&rsquo;ll start with a function that makes a new value with a unique identity every time we call it. We already know that every function we create is unique, so that&rsquo;s what we&rsquo;ll use:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">do</code> <code class="p">(</code><code class="n">unique</code> <code class="p">=</code> <code class="p">(</code><code class="o">-&gt;</code> <code class="o">-&gt;</code><code class="p">))</code> <code class="o">-&gt;</code>

  <code class="n">unique</code><code class="p">()</code>
    # <code class="p">=</code><code class="o">&gt;</code> <code class="p">[</code><code class="n">Function</code><code class="p">]</code>
  <code class="n">unique</code><code class="p">()</code> <code class="n">is</code> <code class="n">unique</code><code class="p">()</code>
    # <code class="n">false</code>
</pre></div>

</div>

<p>Let&rsquo;s verify that what we said about references applies to functions as well as arrays:</p>

<div class="code-block">
<div class="highlight"><pre>  <code class="n">do</code> <code class="p">(</code><code class="n">x</code> <code class="p">=</code> <code class="n">unique</code><code class="p">())</code> <code class="o">-&gt;</code>
    <code class="n">do</code> <code class="p">(</code><code class="n">y</code> <code class="p">=</code> <code class="n">x</code><code class="p">)</code> <code class="o">-&gt;</code>
      <code class="n">x</code> <code class="n">is</code> <code class="n">y</code>
    #<code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code>
</pre></div>

</div>

<p>Ok. So what about things <em>inside</em> arrays? We know how to create an array with something inside it:</p>

<div class="code-block">
<div class="highlight"><pre>  <code class="p">[</code> <code class="n">unique</code><code class="p">()</code> <code class="p">]</code>
    #<code class="p">=</code><code class="o">&gt;</code> <code class="p">[</code> <code class="p">[</code><code class="n">Function</code><code class="p">]</code> <code class="p">]</code>
</pre></div>

</div>

<p>That&rsquo;s an array with one of our unique functions in it. How do we get something <em>out</em> of it?</p>

<div class="code-block">
<div class="highlight"><pre>  <code class="n">do</code> <code class="p">(</code><code class="n">a</code> <code class="p">=</code> <code class="p">[</code> <code class="s">&#39;hello&#39;</code> <code class="p">])</code> <code class="o">-&gt;</code>
    <code class="n">a</code><code class="p">[</code>0<code class="p">]</code>
    #<code class="p">=</code><code class="o">&gt;</code> <code class="s">&#39;hello&#39;</code>
</pre></div>

</div>

<p>Cool, arrays work a lot like arrays in other languages and are zero-based. The trouble with this example is that strings are value types in CoffeeScript, so we have no idea whether <code>a[0]</code> always gives us the same value back like looking up a name in an environment, or whether it does some magic that tries to give us a new value.</p>

<p>We need to put a reference type into an array. If we get the same thing back, we know that the array stores a reference to whatever you put into it. If you get something different back, you know that arrays store copies of things.<sup id="fnref-hunh"><a href="#fn-hunh" rel="footnote">14</a></sup></p>

<p>Let&rsquo;s test it:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">do</code> <code class="p">(</code><code class="n">unique</code> <code class="p">=</code> <code class="p">(</code><code class="o">-&gt;</code> <code class="o">-&gt;</code><code class="p">))</code> <code class="o">-&gt;</code>
  <code class="n">do</code> <code class="p">(</code><code class="n">x</code> <code class="p">=</code> <code class="n">unique</code><code class="p">())</code> <code class="o">-&gt;</code>
    <code class="n">do</code> <code class="p">(</code><code class="n">a</code> <code class="p">=</code> <code class="p">[</code> <code class="n">x</code> <code class="p">])</code> <code class="o">-&gt;</code>
      <code class="n">a</code><code class="p">[</code>0<code class="p">]</code> <code class="n">is</code> <code class="n">x</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code>
</pre></div>

</div>

<p>If we get a value out of an array using the <code>[]</code> suffix, it&rsquo;s the exact same value with the same identity. Question: Does that apply to other locations in the array? Yes:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">do</code> <code class="p">(</code><code class="n">unique</code> <code class="p">=</code> <code class="p">(</code><code class="o">-&gt;</code> <code class="o">-&gt;</code><code class="p">))</code> <code class="o">-&gt;</code>
  <code class="n">do</code> <code class="p">(</code><code class="n">x</code> <code class="p">=</code> <code class="n">unique</code><code class="p">(),</code> <code class="n">y</code> <code class="p">=</code> <code class="n">unique</code><code class="p">(),</code> <code class="n">z</code> <code class="p">=</code> <code class="n">unique</code><code class="p">())</code> <code class="o">-&gt;</code>
    <code class="n">do</code> <code class="p">(</code><code class="n">a</code> <code class="p">=</code> <code class="p">[</code> <code class="n">x</code><code class="p">,</code> <code class="n">y</code><code class="p">,</code> <code class="n">z</code> <code class="p">])</code> <code class="o">-&gt;</code>
      <code class="n">a</code><code class="p">[</code>0<code class="p">]</code> <code class="n">is</code> <code class="n">x</code> <code class="n">and</code> <code class="n">a</code><code class="p">[</code>1<code class="p">]</code> <code class="n">is</code> <code class="n">y</code> <code class="n">and</code> <code class="n">a</code><code class="p">[</code>2<code class="p">]</code> <code class="n">is</code> <code class="n">z</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code>
</pre></div>

</div>

<div class="page-break" />
<h3 id="references-and-objects">references and objects</h3>

<p>CoffeeScript also provides objects. The word &ldquo;object&rdquo; is loaded in programming circles, due to the widespread use of the term &ldquo;object-oriented programming&rdquo; that was coined by Alan Kay but has since come to mean many, many things to many different people.</p>

<p>In CoffeeScript, Objects<sup id="fnref-poco"><a href="#fn-poco" rel="footnote">15</a></sup> are values that can store other values by name (including functions). The most common syntax for creating an object is simple:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">{</code> <code class="n">year</code><code class="p">:</code> 2012<code class="p">,</code> <code class="n">month</code><code class="p">:</code> 6<code class="p">,</code> <code class="n">day</code><code class="p">:</code> 14 <code class="p">}</code>
</pre></div>

</div>

<p>Two objects created this way have differing identities, just like arrays:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">{</code> <code class="n">year</code><code class="p">:</code> 2012<code class="p">,</code> <code class="n">month</code><code class="p">:</code> 6<code class="p">,</code> <code class="n">day</code><code class="p">:</code> 14 <code class="p">}</code> <code class="n">is</code> <code class="p">{</code> <code class="n">year</code><code class="p">:</code> 2012<code class="p">,</code> <code class="n">month</code><code class="p">:</code> 6<code class="p">,</code> <code class="n">day</code><code class="p">:</code> 14 <code class="p">}</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="n">false</code>
</pre></div>

</div>

<p>Objects use <code>[]</code> to access the values by name, using a string:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">{</code> <code class="n">year</code><code class="p">:</code> 2012<code class="p">,</code> <code class="n">month</code><code class="p">:</code> 6<code class="p">,</code> <code class="n">day</code><code class="p">:</code> 14 <code class="p">}[</code><code class="s">&#39;day&#39;</code><code class="p">]</code>
  #<code class="p">=</code><code class="o">&gt;</code> 14
</pre></div>

</div>

<p>Values contained within an object work just like values contained within an array:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">do</code> <code class="p">(</code><code class="n">unique</code> <code class="p">=</code> <code class="p">(</code><code class="o">-&gt;</code> <code class="o">-&gt;</code><code class="p">))</code> <code class="o">-&gt;</code>
  <code class="n">do</code> <code class="p">(</code><code class="n">x</code> <code class="p">=</code> <code class="n">unique</code><code class="p">(),</code> <code class="n">y</code> <code class="p">=</code> <code class="n">unique</code><code class="p">(),</code> <code class="n">z</code> <code class="p">=</code> <code class="n">unique</code><code class="p">())</code> <code class="o">-&gt;</code>
    <code class="n">do</code> <code class="p">(</code><code class="n">o</code> <code class="p">=</code> <code class="p">{</code> <code class="n">a</code><code class="p">:</code> <code class="n">x</code><code class="p">,</code> <code class="n">b</code><code class="p">:</code> <code class="n">y</code><code class="p">,</code> <code class="n">c</code><code class="p">:</code> <code class="n">z</code> <code class="p">})</code> <code class="o">-&gt;</code>
      <code class="n">o</code><code class="p">[</code><code class="s">&#39;a&#39;</code><code class="p">]</code> <code class="n">is</code> <code class="n">x</code> <code class="n">and</code> <code class="n">o</code><code class="p">[</code><code class="s">&#39;b&#39;</code><code class="p">]</code> <code class="n">is</code> <code class="n">y</code> <code class="n">and</code> <code class="n">o</code><code class="p">[</code><code class="s">&#39;c&#39;</code><code class="p">]</code> <code class="n">is</code> <code class="n">z</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code>
</pre></div>

</div>

<p>Names needn&rsquo;t be alphanumeric strings. For anything else, enclose the label in quotes:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">{</code> <code class="s">&#39;first name&#39;</code><code class="p">:</code> <code class="s">&#39;reginald&#39;</code><code class="p">,</code> <code class="s">&#39;last name&#39;</code><code class="p">:</code> <code class="s">&#39;lewis&#39;</code> <code class="p">}[</code><code class="s">&#39;first name&#39;</code><code class="p">]</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="s">&#39;reginald&#39;</code>
</pre></div>

</div>

<p>If the name is an alphanumeric string conforming to the same rules as names of variables, there&rsquo;s a simplified syntax for accessing the values:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">{</code> <code class="n">year</code><code class="p">:</code> 2012<code class="p">,</code> <code class="n">month</code><code class="p">:</code> 6<code class="p">,</code> <code class="n">day</code><code class="p">:</code> 14 <code class="p">}[</code><code class="s">&#39;day&#39;</code><code class="p">]</code> <code class="n">is</code>
    <code class="p">{</code> <code class="n">year</code><code class="p">:</code> 2012<code class="p">,</code> <code class="n">month</code><code class="p">:</code> 6<code class="p">,</code> <code class="n">day</code><code class="p">:</code> 14 <code class="p">}.</code><code class="n">day</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code>
</pre></div>

</div>

<p>All containers can contain any value, including functions or other containers:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">do</code> <code class="p">(</code> <code class="n">Mathematics</code> <code class="p">=</code> <code class="p">{</code> <code class="nb">abs</code><code class="p">:</code> <code class="p">(</code><code class="n">a</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="k">if</code> <code class="n">a</code> <code class="o">&lt;</code> 0 <code class="n">then</code> <code class="o">-</code><code class="n">a</code> <code class="k">else</code> <code class="n">a</code> <code class="p">})</code> <code class="o">-&gt;</code>
  <code class="n">Mathematics</code><code class="p">.</code><code class="nb">abs</code><code class="p">(</code><code class="o">-</code>5<code class="p">)</code>
  #<code class="p">=</code><code class="o">&gt;</code> 5
</pre></div>

</div>

<p>Funny we should mention <code>Mathematics</code>. If you recall, CoffeeScript provides a global environment that contains some existing object that have handy functions you can use. One of them is called <code>Math</code>, and it contains functions for <code>abs</code>, <code>max</code>, <code>min</code>, and many others. Since it is always available, you can use it in any environment provided you don&rsquo;t shadow <code>Math</code>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">Math</code><code class="p">.</code><code class="nb">abs</code><code class="p">(</code><code class="o">-</code>5<code class="p">)</code>
  #<code class="p">=</code><code class="o">&gt;</code> 5
</pre></div>

</div>

<h2 id="mutable">Stir the Espresso: Objects, Mutation, and State</h2>

<div class="image-with-caption">
  <p><img src="images/coffee-spoons.jpg" alt="Life measured out by coffee spoons" />
  <p>Life measured out by coffee spoons</p>
</div>

<p>So far, we have discussed what many call &ldquo;pure functional&rdquo; programming, where every expression is necessarily <a href="https://en.wikipedia.org/wiki/Idempotence">idempotent</a>, because we have no way of changing state within a program using the tools we have examined.</p>

<p>It&rsquo;s time to change <em>everything</em>.</p>

<div class="page-break" />
<h3 id="reassignment-and-mutation">Reassignment and Mutation</h3>

<p>Like most imperative programming languages, CoffeeScript allows you to re-assign the value of variables. The syntax is familiar to users of most popular languages:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">do</code> <code class="p">(</code><code class="n">age</code> <code class="p">=</code> 49<code class="p">)</code> <code class="o">-&gt;</code>
  <code class="n">age</code> <code class="p">=</code> 50
  <code class="n">age</code>
  #<code class="p">=</code><code class="o">&gt;</code> 50
</pre></div>

</div>

<div class="aside sidebarish">
  <hr />
  <p>In CoffeeScript, nearly everything is an expression, including statements that assign a value to a variable, so we could just as easily write <code>do (age = 49) -&gt; age = 50</code>.</p>

  <hr />
</div>

<p>We took the time to carefully examine what happens with bindings in environments. Let&rsquo;s take the time to fully explore what happens with reassigning values to variables. The key is to understand that we are rebinding a different value to the same name in the same environment.</p>

<p>So let&rsquo;s consider what happens with a shadowed variable:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">do</code> <code class="p">(</code><code class="n">age</code> <code class="p">=</code> 49<code class="p">)</code> <code class="o">-&gt;</code>
  <code class="n">do</code> <code class="p">(</code><code class="n">age</code> <code class="p">=</code> 50<code class="p">)</code> <code class="o">-&gt;</code>
    # <code class="n">yadda</code> <code class="n">yadda</code>
  <code class="n">age</code>
  #<code class="p">=</code><code class="o">&gt;</code> 49
</pre></div>

</div>

<p>Binding <code>50</code> to age in the inner environment does not change <code>age</code> in the outer environment because the binding of <code>age</code> in the inner environment shadows the binding of <code>age</code> in the outer environment. We go from:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">{</code><code class="n">age</code><code class="p">:</code> 49<code class="p">,</code> <code class="s">&#39;..&#39;</code><code class="p">:</code> <code class="k">global</code><code class="o">-</code><code class="n">environment</code><code class="p">}</code>
</pre></div>

</div>

<p>To:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">{</code><code class="n">age</code><code class="p">:</code> 50<code class="p">,</code> <code class="s">&#39;..&#39;</code><code class="p">:</code> <code class="p">{</code><code class="n">age</code><code class="p">:</code> 49<code class="p">,</code> <code class="s">&#39;..&#39;</code><code class="p">:</code> <code class="k">global</code><code class="o">-</code><code class="n">environment</code><code class="p">}}</code>
</pre></div>

</div>

<p>Then back to:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">{</code><code class="n">age</code><code class="p">:</code> 49<code class="p">,</code> <code class="s">&#39;..&#39;</code><code class="p">:</code> <code class="k">global</code><code class="o">-</code><code class="n">environment</code><code class="p">}</code>
</pre></div>

</div>

<p>However, if we don&rsquo;t shadow <code>age</code>, reassigning it in a nested environment changes the original:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">do</code> <code class="p">(</code><code class="n">age</code> <code class="p">=</code> 49<code class="p">)</code> <code class="o">-&gt;</code>
  <code class="n">do</code> <code class="p">(</code><code class="n">height</code> <code class="p">=</code> 1<code class="p">.</code>85<code class="p">)</code> <code class="o">-&gt;</code>
    <code class="n">age</code> <code class="p">=</code> 50
  <code class="n">age</code>
  #<code class="p">=</code><code class="o">&gt;</code> 50
</pre></div>

</div>

<p>Like evaluating variable labels, when a binding is rebound, CoffeeScript searches for the binding in the current environment and then each ancestor in turn until it finds one. It then rebinds the name in that environment.</p>

<h4 id="mutation-and-aliases">mutation and aliases</h4>

<p>Now that we can reassign things, there&rsquo;s another important factor to consider: Some values can <em>mutate</em>. Their identities stay the same, but not their structure. Specifically, arrays and objects can mutate. Recall that you can access a value from within an array or an object using <code>[]</code>. You can reassign a value using <code>[]</code> as well:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">do</code> <code class="p">(</code><code class="n">oneTwoThree</code> <code class="p">=</code> <code class="p">[</code>1<code class="p">,</code> 2<code class="p">,</code> 3<code class="p">])</code> <code class="o">-&gt;</code>
  <code class="n">oneTwoThree</code><code class="p">[</code>0<code class="p">]</code> <code class="p">=</code> <code class="s">&#39;one&#39;</code>
  <code class="n">oneTwoThree</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="p">[</code> <code class="s">&#39;one&#39;</code><code class="p">,</code> 2<code class="p">,</code> 3 <code class="p">]</code>
</pre></div>

</div>

<p>You can even add a value:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">do</code> <code class="p">(</code><code class="n">oneTwoThree</code> <code class="p">=</code> <code class="p">[</code>1<code class="p">,</code> 2<code class="p">,</code> 3<code class="p">])</code> <code class="o">-&gt;</code>
  <code class="n">oneTwoThree</code><code class="p">[</code>3<code class="p">]</code> <code class="p">=</code> <code class="s">&#39;four&#39;</code>
  <code class="n">oneTwoThree</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="p">[</code> 1<code class="p">,</code> 2<code class="p">,</code> 3<code class="p">,</code> <code class="s">&#39;four&#39;</code> <code class="p">]</code>
</pre></div>

</div>

<p>You can do the same thing with both syntaxes for accessing objects:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">do</code> <code class="p">(</code><code class="n">name</code> <code class="p">=</code> <code class="p">{</code><code class="n">firstName</code><code class="p">:</code> <code class="s">&#39;Leonard&#39;</code><code class="p">,</code> <code class="n">lastName</code><code class="p">:</code> <code class="s">&#39;Braithwaite&#39;</code><code class="p">})</code> <code class="o">-&gt;</code>
  <code class="n">name</code><code class="p">.</code><code class="n">middleName</code> <code class="p">=</code> <code class="s">&#39;Austin&#39;</code>
  <code class="n">name</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="p">{</code> <code class="n">firstName</code><code class="p">:</code> <code class="s">&#39;Leonard&#39;</code><code class="p">,</code>
  #     <code class="n">lastName</code><code class="p">:</code> <code class="s">&#39;Braithwaite&#39;</code><code class="p">,</code>
  #     <code class="n">middleName</code><code class="p">:</code> <code class="s">&#39;Austin&#39;</code> <code class="p">}</code>
</pre></div>

</div>

<p>We have established that CoffeeScript&rsquo;s semantics allow for two different bindings to refer to the same value. For example:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">do</code> <code class="p">(</code><code class="n">allHallowsEve</code> <code class="p">=</code> <code class="p">[</code>2012<code class="p">,</code> 10<code class="p">,</code> 31<code class="p">])</code> <code class="o">-&gt;</code>
  <code class="n">halloween</code> <code class="p">=</code> <code class="n">allHallowsEve</code>  
</pre></div>

</div>

<p>Both <code>halloween</code> and <code>allHallowsEve</code> are bound to the same array value within the local environment. And also:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">do</code> <code class="p">(</code><code class="n">allHallowsEve</code> <code class="p">=</code> <code class="p">[</code>2012<code class="p">,</code> 10<code class="p">,</code> 31<code class="p">])</code> <code class="o">-&gt;</code>
  <code class="n">do</code> <code class="p">(</code><code class="n">allHallowsEve</code><code class="p">)</code> <code class="o">-&gt;</code>
    # <code class="p">...</code>
</pre></div>

</div>

<p>Hello, what&rsquo;s this? What does <code>do (allHallowsEve) -&gt;</code> mean? Well, when you put a name in the argument list for <code>do -&gt;</code> but you don&rsquo;t supply a value, CoffeeScript assumes you are deliberately trying to shadow a variable. It acts as if you&rsquo;d written:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">((</code><code class="n">allHallowsEve</code><code class="p">)</code> <code class="o">-&gt;</code>
  # <code class="p">...</code>
<code class="p">)(</code><code class="n">allHallowsEve</code><code class="p">)</code>
</pre></div>

</div>

<p>There are two nested environments, and each one binds the name <code>allHallowsEve</code> to the exact same array value. In each of these examples, we have created two <em>aliases</em> for the same value. Before we could reassign things, the most important point about this is that the identities were the same, because they were the same value.</p>

<p>This is vital. Consider what we already know about shadowing:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">do</code> <code class="p">(</code><code class="n">allHallowsEve</code> <code class="p">=</code> <code class="p">[</code>2012<code class="p">,</code> 10<code class="p">,</code> 31<code class="p">])</code> <code class="o">-&gt;</code>
  <code class="n">do</code> <code class="p">(</code><code class="n">allHallowsEve</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="n">allHallowsEve</code> <code class="p">=</code> <code class="p">[</code>2013<code class="p">,</code> 10<code class="p">,</code> 31<code class="p">]</code>
  <code class="n">allHallowsEve</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="p">[</code> 2012<code class="p">,</code> 10<code class="p">,</code> 31 <code class="p">]</code>
</pre></div>

</div>

<p>The outer value of <code>allHallowsEve</code> was not changed because all we did was rebind the name <code>allHallowsEve</code> within the inner environment. However, what happens if we <em>mutate</em> the value in the inner environment?</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">do</code> <code class="p">(</code><code class="n">allHallowsEve</code> <code class="p">=</code> <code class="p">[</code>2012<code class="p">,</code> 10<code class="p">,</code> 31<code class="p">])</code> <code class="o">-&gt;</code>
  <code class="n">do</code> <code class="p">(</code><code class="n">allHallowsEve</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="n">allHallowsEve</code><code class="p">[</code>0<code class="p">]</code> <code class="p">=</code> 2013
  <code class="n">allHallowsEve</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="p">[</code> 2013<code class="p">,</code> 10<code class="p">,</code> 31 <code class="p">]</code>
</pre></div>

</div>

<p>This is different. We haven&rsquo;t rebound the inner name to a different variable, we&rsquo;ve mutated the value that both bindings share.</p>

<p>The same thing is true whenever you have multiple aliases to the same value:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">do</code> <code class="p">(</code><code class="n">greatUncle</code> <code class="p">=</code> <code class="n">undefined</code><code class="p">,</code> <code class="n">grandMother</code> <code class="p">=</code> <code class="n">undefined</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="n">greatUncle</code> <code class="p">=</code> <code class="p">{</code><code class="n">firstName</code><code class="p">:</code> <code class="s">&#39;Leonard&#39;</code><code class="p">,</code> <code class="n">lastName</code><code class="p">:</code> <code class="s">&#39;Braithwaite&#39;</code><code class="p">}</code>
  <code class="n">grandMother</code> <code class="p">=</code> <code class="n">greatUncle</code>
  <code class="n">grandMother</code><code class="p">[</code><code class="s">&#39;firstName&#39;</code><code class="p">]</code> <code class="p">=</code> <code class="s">&#39;Lois&#39;</code>
  <code class="n">grandMother</code><code class="p">[</code><code class="s">&#39;lastName&#39;</code><code class="p">]</code> <code class="p">=</code> <code class="s">&#39;Barzey&#39;</code>
  <code class="n">greatUncle</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="p">{</code> <code class="n">firstName</code><code class="p">:</code> <code class="s">&#39;Lois&#39;</code><code class="p">,</code> <code class="n">lastName</code><code class="p">:</code> <code class="s">&#39;Barzey&#39;</code> <code class="p">}</code>
</pre></div>

</div>

<p>This example uses the <a href="#letrec"><code>letrec</code></a> pattern for declaring bindings. Now that we&rsquo;ve finished with mutation and aliases, let&rsquo;s have a look at it.</p>

<h4 id="letrec">letrec</h4>

<p>One way to exploit reassignment is to &ldquo;declare&rdquo; your bindings with <code>do</code> and bind them to something temporarily, and then rebind them inline, like so:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">do</code> <code class="p">(</code><code class="n">identity</code> <code class="p">=</code> <code class="n">undefined</code><code class="p">,</code> <code class="n">kestrel</code> <code class="p">=</code> <code class="n">undefined</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="n">identity</code> <code class="p">=</code> <code class="p">(</code><code class="n">x</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">x</code>
  <code class="n">kestrel</code> <code class="p">=</code> <code class="p">(</code><code class="n">x</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="p">(</code><code class="n">y</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">x</code>
</pre></div>

</div>

<p>This pattern is called <code>letrec</code> after the Lisp special form. Recall that <a href="#let"><code>let</code></a> looks like this in CoffeeScript:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">do</code> <code class="p">(</code><code class="n">identity</code> <code class="p">=</code> <code class="p">((</code><code class="n">x</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">x</code><code class="p">),</code> <code class="n">kestrel</code> <code class="p">=</code> <code class="p">(</code><code class="n">x</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="p">(</code><code class="n">y</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">x</code><code class="p">)</code> <code class="o">-&gt;</code>
</pre></div>

</div>

<p>To see how <code>letrec</code> differs from <code>let</code>, consider writing a recursive function<sup id="fnref-y"><a href="#fn-y" rel="footnote">16</a></sup> like <code>pow</code>. <code>pow</code> takes two arguments, <code>n</code> and <code>p</code>, and returns <code>n</code> raised to the <code>p</code><sup>th</sup> power. For simplicity, we&rsquo;ll assume that <code>p</code> is an integer.</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">do</code> <code class="p">(</code><code class="n">pow</code> <code class="p">=</code> <code class="n">undefined</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="n">pow</code> <code class="p">=</code> <code class="p">(</code><code class="n">n</code><code class="p">,</code> <code class="n">p</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="k">if</code> <code class="n">p</code> <code class="o">&lt;</code> 0
      1<code class="o">/</code><code class="n">pow</code><code class="p">(</code><code class="n">n</code><code class="p">,</code> <code class="o">-</code><code class="n">p</code><code class="p">)</code>
    <code class="k">else</code> <code class="k">if</code> <code class="n">p</code> <code class="n">is</code> 0
      1
    <code class="k">else</code> <code class="k">if</code> <code class="n">p</code> <code class="n">is</code> 1
      <code class="n">n</code>
    <code class="k">else</code>
      <code class="n">do</code> <code class="p">(</code><code class="n">half</code> <code class="p">=</code> <code class="n">pow</code><code class="p">(</code><code class="n">n</code><code class="p">,</code> <code class="n">Math</code><code class="p">.</code><code class="nb">floor</code><code class="p">(</code><code class="n">p</code><code class="o">/</code>2<code class="p">)),</code> <code class="n">remainder</code> <code class="p">=</code> <code class="n">pow</code><code class="p">(</code><code class="n">n</code><code class="p">,</code> <code class="n">p</code> <code class="c">% 2)) -&gt;</code>
        <code class="n">half</code> <code class="o">*</code> <code class="n">half</code> <code class="o">*</code> <code class="n">remainder</code>
</pre></div>

</div>

<p>In order for <code>pow</code> to call itself, <code>pow</code> must be bound in the environment in which <code>pow</code> is defined. This wouldn&rsquo;t work if we tried to bind <code>pow</code> in the <code>do</code> itself. Here&rsquo;s a misguided attempt to create a recursive function using <code>let</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">do</code> <code class="p">(</code><code class="n">odd</code> <code class="p">=</code> <code class="p">(</code><code class="n">n</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="k">if</code> <code class="n">n</code> <code class="n">is</code> 0 <code class="n">then</code> <code class="n">false</code> <code class="k">else</code> <code class="n">not</code> <code class="n">odd</code><code class="p">(</code><code class="n">n</code><code class="o">-</code>1<code class="p">))</code> <code class="o">-&gt;</code>
  <code class="n">odd</code><code class="p">(</code>5<code class="p">)</code>
</pre></div>

</div>

<p>To see why this doesn&rsquo;t work, recall that this is equivalent to writing:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">((</code><code class="n">odd</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="n">odd</code><code class="p">(</code>5<code class="p">)</code>
<code class="p">)(</code> <code class="p">(</code><code class="n">n</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="k">if</code> <code class="n">n</code> <code class="n">is</code> 0 <code class="n">then</code> <code class="n">false</code> <code class="k">else</code> <code class="n">not</code> <code class="n">odd</code><code class="p">(</code><code class="n">n</code><code class="o">-</code>1<code class="p">)</code> <code class="p">)</code>
</pre></div>

</div>

<p>The expression <code>(n) -&gt; if n is 0 then false else not odd(n-1)</code> is evaluated in the parent environment, where <code>odd</code> hasn&rsquo;t been bound yet. Whereas, if we wrote <code>odd</code> with <code>letrec</code>, it would look like this:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">do</code> <code class="p">(</code><code class="n">odd</code> <code class="p">=</code> <code class="n">undefined</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="n">odd</code> <code class="p">=</code> <code class="p">(</code><code class="n">n</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="k">if</code> <code class="n">n</code> <code class="n">is</code> 0 <code class="n">then</code> <code class="n">false</code> <code class="k">else</code> <code class="n">not</code> <code class="n">odd</code><code class="p">(</code><code class="n">n</code><code class="o">-</code>1<code class="p">)</code>
  <code class="n">odd</code><code class="p">(</code>5<code class="p">)</code>
</pre></div>

</div>

<p>Which is equivalent to:  </p>

<div class="code-block">
<div class="highlight"><pre><code class="p">((</code><code class="n">odd</code><code class="p">)</code> <code class="o">-&gt;</code>  
  <code class="n">odd</code> <code class="p">=</code> <code class="p">(</code><code class="n">n</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="k">if</code> <code class="n">n</code> <code class="n">is</code> 0 <code class="n">then</code> <code class="n">false</code> <code class="k">else</code> <code class="n">not</code> <code class="n">odd</code><code class="p">(</code><code class="n">n</code><code class="o">-</code>1<code class="p">)</code>
  <code class="n">odd</code><code class="p">(</code>5<code class="p">)</code>
<code class="p">)(</code> <code class="n">undefined</code> <code class="p">)</code>
</pre></div>

</div>

<p>Now the <code>odd</code> function is bound in an environment that has a binding for the name <code>odd</code>. <code>letrec</code> also allows you to make expressions that depend upon each other, recursively or otherwise, such as:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">do</code> <code class="p">(</code><code class="n">I</code> <code class="p">=</code> <code class="n">undefined</code><code class="p">,</code> <code class="n">K</code> <code class="p">=</code> <code class="n">undefined</code><code class="p">,</code> <code class="n">T</code> <code class="p">=</code> <code class="n">undefined</code><code class="p">,</code> <code class="n">F</code> <code class="p">=</code> <code class="n">undefined</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="n">I</code> <code class="p">=</code> <code class="p">(</code><code class="n">x</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">x</code>
  <code class="n">K</code> <code class="p">=</code> <code class="p">(</code><code class="n">x</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="p">(</code><code class="n">y</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">x</code>
  <code class="n">T</code> <code class="p">=</code> <code class="n">K</code>
  <code class="n">F</code> <code class="p">=</code> <code class="n">K</code><code class="p">(</code><code class="n">I</code><code class="p">)</code>
</pre></div>

</div>

<h4 id="takeaway">takeaway</h4>

<div class="tip sidebarish">
  <hr />
  <p><img class="sidebar-image" alt="tip" src="images/leanpub_tip.png" />CoffeeScript permits the reassignment of new values to existing bindings, as well as the reassignment and assignment of new values to elements of containers such as arrays and objects. Mutating existing objects has special implications when two bindings are aliases of the same value.</p>

  <p>The <code>letrec</code> pattern allows us to bind interdependent and recursive expressions.</p>

  <hr />
</div>

<div class="page-break" />
<h3 id="normal-variables">Normal Variables</h3>

<p>Now that we&rsquo;ve discussed reassignment, it&rsquo;s time to discuss <em>assignment</em>.</p>

<div class="aside sidebarish">
  <hr />
  <p>It sounds odd to say we&rsquo;ve reassigned things without assigning them. Up to now, we&rsquo;ve <em>bound</em> values to names through arguments, and <code>do</code>, which is really syntactic sugar for the <code>let</code> pattern.</p>

  <hr />
</div>

<p>In CoffeeScript, the syntax for assignment is identical to the syntax for reassignment:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">birthday</code> <code class="p">=</code> <code class="p">{</code> <code class="n">year</code><code class="p">:</code> 1962<code class="p">,</code> <code class="n">month</code><code class="p">:</code> 6<code class="p">,</code> <code class="n">day</code><code class="p">:</code> 14 <code class="p">}</code>
</pre></div>

</div>

<p>The difference comes when there is no value bound to the name <code>birthday</code> in any of the user-defined environments. In that case, CoffeeScript creates one in the current function&rsquo;s environment. The current function is any of the following:</p>

<ol class="numeric">
  <li>A function created with an arrow operator (<code>-&gt;</code> that we&rsquo;ve seen, and <code>=&gt;</code> that we&rsquo;ll see when we look at objects <a href="#methods">in more detail</a>).</li>
  <li>A function created with the <code>do</code> syntax.</li>
  <li>When compiling CoffeeScript in files, an empty <code>do -&gt;</code> is invisibly created to enclose the entire file.</li>
</ol>

<p>One good consequence of this feature is that you can dispense with all of the nested <code>do (...) -&gt;</code> expressions you&rsquo;ve seen so far if you wish. You can boldly write things like:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">identity</code> <code class="p">=</code> <code class="p">(</code><code class="n">x</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">x</code>
<code class="n">kestrel</code> <code class="p">=</code> <code class="p">(</code><code class="n">x</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="p">(</code><code class="n">y</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">x</code>
<code class="n">truth</code> <code class="p">=</code> <code class="n">kestrel</code>
<code class="n">falsehood</code> <code class="p">=</code> <code class="n">kestrel</code><code class="p">(</code><code class="n">identity</code><code class="p">)</code>
</pre></div>

</div>

<p>You can also do your assignments wherever you like in a function, not just at the top. Some feel this makes code more readable by putting variable definitions closer to their use.</p>

<p>There are two unfortunate consequences. The first is that a misspelling creates a new binding rather than resulting in an error:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">do</code> <code class="p">(</code><code class="n">age</code> <code class="p">=</code> 49<code class="p">)</code> <code class="o">-&gt;</code>
  # <code class="p">...</code>
  <code class="n">agee</code> <code class="p">=</code> 50
  # <code class="p">...</code>
  <code class="n">age</code>
  #<code class="p">=</code><code class="o">&gt;</code> 49<code class="p">,</code> <code class="n">not</code> 50
</pre></div>

</div>

<p>The second is that you may accidentally alias an existing variable if you are not careful. If you&rsquo;re in the habit of creating a lot of your variables with assignments rather than with <code>do</code>, you must be careful to scan the source of all of your function&rsquo;s parents to ensure you haven&rsquo;t accidentally reused the name of an existing binding.<sup id="fnref-worse"><a href="#fn-worse" rel="footnote">17</a></sup></p>

<div class="aside sidebarish">
  <hr />
  <p>CoffeeScript calls creating new bindings with assignment &ldquo;normal ,&rdquo; because it&rsquo;s how most programmers normally create bindings. Just remember that if anyone criticizes CoffeeScript for being loose with scoping and aliases, you can always show them how to use <code>do</code> to emulate <code>let</code> and <code>letrec</code>.</p>

  <hr />
</div>

<h4 id="un-do">un-do</h4>

<p>So, should we use <code>do</code> to bind variables or should we use &ldquo;normal&rdquo; variables? This is a very interesting question. Using <code>do</code> has a certain number of technical benefits. Then again, Jeremy Ashkenas, CoffeeScript&rsquo;s creator, only uses <code>do</code> when it&rsquo;s necessary, and most CoffeeScript programmers follow his lead. It hasn&rsquo;t done them any harm.</p>

<p>So here&rsquo;s what we suggest:</p>

<p>When writing new software, use Normal variables as much as possible. If and when you find there&rsquo;s a scoping problem, you can refactor to <code>do</code>, meaning, you can change a normal variable into a variable bound with <code>do</code> to solve the problem.</p>

<p>Programming philosophy is a little outside of the scope of this book, but there is a general principle worth knowing: A good programmer is familiar with many design patterns, idioms, and constructions. However, the good programmer does not attempt to design them into every piece of code from the outset. Instead, the good programmer proceeds along a simple, direct, and clear path until difficulties arise. Then, and only then, does the good programmer refactor to a pattern. In the end, the code is simple where it does not solve a difficult or edge case, and uses a technique or idiom where there is a problem that needed solving.</p>

<p><code>do</code> is a good pattern to know and deeply understand, but it is generally sufficient to write with normal variables. If you see a lot of <code>do</code> in this book, that is because we are writing to be excruciatingly clear, not to construct software that is easy to read and maintain in a team setting.</p>

<div class="page-break" />
<h3 id="comprehensions">Comprehensions</h3>

<div class="image-with-caption">
  <p><img src="images/cupping.jpg" alt="Cupping Grinds" />
  <p>Cupping Grinds</p>
</div>

<p>If you&rsquo;re the type of person who can &ldquo;Write Lisp in any language,&rdquo; you could set about writing entire CoffeeScript programs using <code>let</code> and <code>letrec</code> patterns such that you don&rsquo;t have <em>any</em> normal variables. But being a CoffeeScript programmer, you will no doubt embrace normal variables. As you dive into CoffeeScript, you&rsquo;ll discover many helpful features that aren&rsquo;t &ldquo;Lisp-y.&rdquo; Eschewing them is to cut against CoffeeScript&rsquo;s grain. One of those features is the <a href="http://coffeescript.org/#loops">comprehension</a>, a mechanism for working with collections that was popularized by Python.</p>

<p>Here&rsquo;s a sample comprehension:</p>

<div class="code-block">
<div class="highlight"><pre>	<code class="n">names</code> <code class="p">=</code> <code class="p">[</code><code class="s">&#39;algernon&#39;</code><code class="p">,</code> <code class="s">&#39;sabine&#39;</code><code class="p">,</code> <code class="s">&#39;rupert&#39;</code><code class="p">,</code> <code class="s">&#39;theodora&#39;</code><code class="p">]</code>

&quot;<code class="n">Hello</code> #<code class="p">{</code><code class="n">yourName</code><code class="p">}</code>&quot; <code class="k">for</code> <code class="n">yourName</code> <code class="n">in</code> <code class="n">names</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="p">[</code> <code class="s">&#39;Hello algernon&#39;</code><code class="p">,</code>
  #     <code class="s">&#39;Hello sabine&#39;</code><code class="p">,</code>
  #     <code class="s">&#39;Hello rupert&#39;</code><code class="p">,</code>
  #     <code class="s">&#39;Hello theodora&#39;</code> <code class="p">]</code>
</pre></div>

</div>

<p>An alternate syntax for the same thing that supports multiple expressions is:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">for</code> <code class="n">yourName</code> <code class="n">in</code> <code class="n">names</code>
  &quot;<code class="n">Hello</code> #<code class="p">{</code><code class="n">yourName</code><code class="p">}</code>&quot;
  #<code class="p">=</code><code class="o">&gt;</code> <code class="p">[</code> <code class="s">&#39;Hello algernon&#39;</code><code class="p">,</code>
  #     <code class="s">&#39;Hello sabine&#39;</code><code class="p">,</code>
  #     <code class="s">&#39;Hello rupert&#39;</code><code class="p">,</code>
  #     <code class="s">&#39;Hello theodora&#39;</code> <code class="p">]</code>
</pre></div>

</div>

<p>Here&rsquo;s a question: There&rsquo;s a variable reference <code>yourName</code> in this code. Is it somehow bound to a new environment in the comprehension? Or is it a &ldquo;normal variable&rdquo; that is either bound in the current function&rsquo;s environment or in a parent function&rsquo;s environment?</p>

<p>Let&rsquo;s try it and see:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">yourName</code> <code class="p">=</code> <code class="s">&#39;clyde&#39;</code>
&quot;<code class="n">Hello</code> #<code class="p">{</code><code class="n">yourName</code><code class="p">}</code>&quot; <code class="k">for</code> <code class="n">yourName</code> <code class="n">in</code> <code class="n">names</code>
<code class="n">yourName</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="s">&#39;theodora&#39;</code>
</pre></div>

</div>

<p>It&rsquo;s a normal variable. If it was somehow &lsquo;local&rsquo; to the comprehension, <code>yourName</code> would still be <code>clyde</code> as the comprehension&rsquo;s binding would shadow the current environment&rsquo;s binding. This is usually fine, as creating a new environment for every comprehension could have performance implications.</p>

<p>However, there are two times you don&rsquo;t want that to happen. First, you might want <code>yourName</code> to shadow the existing <code>yourName</code> binding. You can use <code>do</code> to fix that:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">yourName</code> <code class="p">=</code> <code class="s">&#39;clyde&#39;</code>
<code class="n">do</code> <code class="p">(</code><code class="n">yourName</code><code class="p">)</code> <code class="o">-&gt;</code>
  &quot;<code class="n">Hello</code> #<code class="p">{</code><code class="n">yourName</code><code class="p">}</code>&quot; <code class="k">for</code> <code class="n">yourName</code> <code class="n">in</code> <code class="n">names</code>
<code class="n">yourName</code>
  #<code class="p">=</code><code class="o">&gt;</code> `<code class="n">clyde</code>`
</pre></div>

</div>

<p>Recall that when you put a name in the argument list for <code>do -&gt;</code> but you don&rsquo;t supply a value, CoffeeScript assumes you are deliberately trying to shadow a variable. It acts as if you&rsquo;d written:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">yourName</code> <code class="p">=</code> <code class="s">&#39;clyde&#39;</code>
<code class="p">((</code><code class="n">yourName</code><code class="p">)</code> <code class="o">-&gt;</code>
  &quot;<code class="n">Hello</code> #<code class="p">{</code><code class="n">yourName</code><code class="p">}</code>&quot; <code class="k">for</code> <code class="n">yourName</code> <code class="n">in</code> <code class="n">names</code>
<code class="p">)(</code><code class="n">yourName</code><code class="p">)</code>
<code class="n">yourName</code>
  #<code class="p">=</code><code class="o">&gt;</code> `<code class="n">clyde</code>`
</pre></div>

</div>

<p>So technically, the inner <code>yourName</code> will be bound to the same value as the outer <code>yourName</code> initially, but as the comprehension is evaluated, that value will be overwritten in the inner environment but not the outer environment.</p>

<h4 id="preventing-a-subtle-comprehensions-bug">preventing a subtle comprehensions bug</h4>

<p>Consider this variation of the above comprehension:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">for</code> <code class="n">myName</code> <code class="n">in</code> <code class="n">names</code>
  <code class="p">(</code><code class="n">yourName</code><code class="p">)</code> <code class="o">-&gt;</code> &quot;<code class="n">Hello</code> #<code class="p">{</code><code class="n">yourName</code><code class="p">},</code> <code class="n">my</code> <code class="n">name</code> <code class="n">is</code> #<code class="p">{</code><code class="n">myName</code><code class="p">}</code>&quot;
</pre></div>

</div>

<p>Now what we want is four functions, each of which can generate a sentence like &ldquo;Hello reader, my name is rupert&rdquo;. We can test that with a comprehension:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">fn</code><code class="p">(</code><code class="s">&#39;reader&#39;</code><code class="p">)</code> <code class="k">for</code> <code class="n">fn</code> <code class="n">in</code> <code class="k">for</code> <code class="n">myName</code> <code class="n">in</code> <code class="n">names</code>
  <code class="p">(</code><code class="n">yourName</code><code class="p">)</code> <code class="o">-&gt;</code> &quot;<code class="n">Hello</code> #<code class="p">{</code><code class="n">yourName</code><code class="p">},</code> <code class="n">my</code> <code class="n">name</code> <code class="n">is</code> #<code class="p">{</code><code class="n">myName</code><code class="p">}</code>&quot;
      #<code class="p">=</code><code class="o">&gt;</code> <code class="p">[</code> <code class="s">&#39;Hello reader, my name is theodora&#39;</code><code class="p">,</code>
      #     <code class="s">&#39;Hello reader, my name is theodora&#39;</code><code class="p">,</code>
      #     <code class="s">&#39;Hello reader, my name is theodora&#39;</code><code class="p">,</code>
      #     <code class="s">&#39;Hello reader, my name is theodora&#39;</code> <code class="p">]</code>
</pre></div>

</div>

<p>WTF!?</p>

<p>If we consider our model for binding, we&rsquo;ll quickly discover the problem. Each of the functions we generate has a closure that consists of a function and a local environment. <code>yourName</code> is bound in its local environment, but <code>myName</code> is bound in the comprehension&rsquo;s environment. At the time each closure was created, <code>myName</code> was bound to one of the four names, but at the time the closures are evaluated, <code>myName</code> is bound to the last of the four names.</p>

<p>Each of the four closures has its own local environment, but they <em>share</em> a parent environment, which means they share the exact same binding for <code>myName</code>. We can fix it using the &ldquo;shadow&rdquo; syntax for <code>do</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">fn</code><code class="p">(</code><code class="s">&#39;reader&#39;</code><code class="p">)</code> <code class="k">for</code> <code class="n">fn</code> <code class="n">in</code> <code class="k">for</code> <code class="n">myName</code> <code class="n">in</code> <code class="n">names</code>
  <code class="n">do</code> <code class="p">(</code><code class="n">myName</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="p">(</code><code class="n">yourName</code><code class="p">)</code> <code class="o">-&gt;</code> &quot;<code class="n">Hello</code> #<code class="p">{</code><code class="n">yourName</code><code class="p">},</code> <code class="n">my</code> <code class="n">name</code> <code class="n">is</code> #<code class="p">{</code><code class="n">myName</code><code class="p">}</code>&quot;
  #<code class="p">=</code><code class="o">&gt;</code> <code class="p">[</code> <code class="s">&#39;Hello reader, my name is algernon&#39;</code><code class="p">,</code>
  #     <code class="s">&#39;Hello reader, my name is sabine&#39;</code><code class="p">,</code>
  #     <code class="s">&#39;Hello reader, my name is rupert&#39;</code><code class="p">,</code>
  #     <code class="s">&#39;Hello reader, my name is theodora&#39;</code> <code class="p">]</code>
</pre></div>

</div>

<p>Now, each time we create a function we&rsquo;re first creating its own environment and binding <code>myName</code> there, shadowing the comprehension&rsquo;s binding of <code>myName</code>. Thus, the comprehension&rsquo;s changes to <code>myName</code> don&rsquo;t change each closure&rsquo;s binding.</p>

<h4 id="takeaway-1">takeaway</h4>

<div class="tip sidebarish">
  <hr />
  <p><img class="sidebar-image" alt="tip" src="images/leanpub_tip.png" /><a href="http://coffeescript.org/#loops">Comprehensions</a> are extraordinarily useful for working with collections, but their loop variables are normal variables and may require special care to obtain the desired results. Also worth noting: Comprehensions may be the <em>only</em> place where <code>let</code> or <code>do</code> is <em>necessary</em> in CoffeeScript. Every other case can probably be handled with appropriate use of normal variables.</p>

  <hr />
</div>

<div class="page-break" />
<h3 id="encapsulation">Encapsulating State with Closures</h3>

<blockquote>
  <p>OOP to me means only messaging, local retention and protection and hiding of state-process, and extreme late-binding of all things.&ndash;<a href="http://userpage.fu-berlin.de/~ram/pub/pub_jf47ht81Ht/doc_kay_oop_en">Alan Kay</a></p>
</blockquote>

<p>We&rsquo;re going to look at encapsulation using CoffeeScript&rsquo;s functions and objects. We&rsquo;re not going to call it object-oriented programming, mind you, because that would start a long debate. This is just plain encapsulation<sup id="fnref-encapsulation"><a href="#fn-encapsulation" rel="footnote">18</a></sup>, with a dash of information-hiding.</p>

<h4 id="what-is-hiding-of-state-process-and-why-does-it-matter">what is hiding of state-process, and why does it matter?</h4>

<blockquote>
  <p>In computer science, information hiding is the principle of segregation of the design decisions in a computer program that are most likely to change, thus protecting other parts of the program from extensive modification if the design decision is changed. The protection involves providing a stable interface which protects the remainder of the program from the implementation (the details that are most likely to change).</p>
</blockquote>

<blockquote>
  <p>Written another way, information hiding is the ability to prevent certain aspects of a class or software component from being accessible to its clients, using either programming language features (like private variables) or an explicit exporting policy.</p>
</blockquote>

<blockquote>
  <p>&ndash;<a href="https://en.wikipedia.org/wiki/Information_hiding" title="Information hiding">Wikipedia</a></p>
</blockquote>

<p>Consider a <a href="https://en.wikipedia.org/wiki/Stack_" title="data_structure">stack</a> data structure. There are three basic operations: Pushing a value onto the top (<code>push</code>), popping a value off the top (<code>pop</code>), and testing to see whether the stack is empty or not (<code>isEmpty</code>). These three operations are the stable interface.</p>

<p>Many stacks have an array for holding the contents of the stack. This is relatively stable. You could substitute a linked list, but in CoffeeScript, the array is highly efficient. You might need an index, you might not. You could grow and shrink the array, or you could allocate a fixed size and use an index to keep track of how much of the array is in use. The design choices for keeping track of the head of the list are often driven by performance considerations.</p>

<p>If you expose the implementation detail such as whether there is an index, sooner or later some programmer is going to find an advantage in using the index directly. For example, she may need to know the size of a stack. The ideal choice would be to add a <code>size</code> function that continues to hide the implementation. But she&rsquo;s in a hurry, so she reads the <code>index</code> directly. Now her code is coupled to the existence of an index, so if we wish to change the implementation to grow and shrink the array, we will break her code.</p>

<p>The way to avoid this is to hide the array and index from other code and only expose the operations we have deemed stable. If and when someone needs to know the size of the stack, we&rsquo;ll add a <code>size</code> function and expose it as well.</p>

<p>Hiding information (or &ldquo;state&rdquo;) is the design principle that allows us to limit the coupling between components of software.</p>

<h4 id="hiding-state">how do we hide state using coffeescript?</h4>

<p>We&rsquo;ve been introduced to CoffeeScript&rsquo;s objects, and it&rsquo;s fairly easy to see that objects can be used to model what other programming languages call (variously) records, structs, frames, or what-have-you. And given that their elements are mutable, they can clearly model state.</p>

<p>Given an object that holds our state (an array and an index<sup id="fnref-length"><a href="#fn-length" rel="footnote">19</a></sup>), we can easily implement our three operations as functions. Bundling the functions with the state does not require any special &ldquo;magic&rdquo; features. CoffeeScript objects can have elements of any type, including functions:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">stack</code> <code class="p">=</code> <code class="n">do</code> <code class="p">(</code><code class="n">obj</code> <code class="p">=</code> <code class="n">undefined</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="n">obj</code> <code class="p">=</code>
    <code class="n">array</code><code class="p">:</code> <code class="p">[]</code>
    <code class="n">index</code><code class="p">:</code> <code class="o">-</code>1
    <code class="n">push</code><code class="p">:</code> <code class="p">(</code><code class="n">value</code><code class="p">)</code> <code class="o">-&gt;</code>
      <code class="n">obj</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">obj</code><code class="p">.</code><code class="n">index</code> <code class="o">+</code><code class="p">=</code> 1<code class="p">]</code> <code class="p">=</code> <code class="n">value</code>
    <code class="n">pop</code><code class="p">:</code> <code class="o">-&gt;</code>
      <code class="n">do</code> <code class="p">(</code><code class="n">value</code> <code class="p">=</code> <code class="n">obj</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">obj</code><code class="p">.</code><code class="n">index</code><code class="p">])</code> <code class="o">-&gt;</code>
        <code class="n">obj</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">obj</code><code class="p">.</code><code class="n">index</code><code class="p">]</code> <code class="p">=</code> <code class="n">undefined</code>
        <code class="n">obj</code><code class="p">.</code><code class="n">index</code> <code class="o">-</code><code class="p">=</code> 1 <code class="k">if</code> <code class="n">obj</code><code class="p">.</code><code class="n">index</code> <code class="o">&gt;</code><code class="p">=</code> 0
        <code class="n">value</code>
    <code class="n">isEmpty</code><code class="p">:</code> <code class="o">-&gt;</code>
      <code class="n">obj</code><code class="p">.</code><code class="n">index</code> <code class="o">&lt;</code> 0

<code class="n">stack</code><code class="p">.</code><code class="n">isEmpty</code><code class="p">()</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code>
<code class="n">stack</code><code class="p">.</code><code class="n">push</code><code class="p">(</code><code class="s">&#39;hello&#39;</code><code class="p">)</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="s">&#39;hello&#39;</code>
<code class="n">stack</code><code class="p">.</code><code class="n">push</code><code class="p">(</code><code class="s">&#39;CoffeeScript&#39;</code><code class="p">)</code>
 #<code class="p">=</code><code class="o">&gt;</code> <code class="s">&#39;CoffeeScript&#39;</code>
<code class="n">stack</code><code class="p">.</code><code class="n">isEmpty</code><code class="p">()</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="n">false</code>
<code class="n">stack</code><code class="p">.</code><code class="n">pop</code><code class="p">()</code>
 #<code class="p">=</code><code class="o">&gt;</code> <code class="s">&#39;CoffeeScript&#39;</code>
<code class="n">stack</code><code class="p">.</code><code class="n">pop</code><code class="p">()</code>
 #<code class="p">=</code><code class="o">&gt;</code> <code class="s">&#39;hello&#39;</code>
<code class="n">stack</code><code class="p">.</code><code class="n">isEmpty</code><code class="p">()</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code>
</pre></div>

</div>

<h4 id="method-ology">method-ology</h4>

<p>In this text, we lurch from talking about functions belong to an object to methods. Other languages may separate methods from functions very strictly, but in CoffeeScript every method is a function but not all functions are methods.</p>

<p>The view taken in this book is that a function is a method of an object if it belongs to that object and interacts with that object in some way. So the functions implementing the operations on the queue are all absolutely methods of the queue.</p>

<p>But these wouldn&rsquo;t be methods. Although they belong to an object, they don&rsquo;t interact with it:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">{</code>
  <code class="n">min</code><code class="p">:</code> <code class="p">(</code><code class="n">x</code><code class="p">,</code> <code class="n">y</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="k">if</code> <code class="n">x</code> <code class="o">&lt;</code> <code class="n">y</code> <code class="n">then</code> <code class="n">x</code> <code class="k">else</code> <code class="n">y</code>
  <code class="n">max</code><code class="p">:</code> <code class="p">(</code><code class="n">x</code><code class="p">,</code> <code class="n">y</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="k">if</code> <code class="n">x</code> <code class="o">&gt;</code> <code class="n">y</code> <code class="n">then</code> <code class="n">x</code> <code class="k">else</code> <code class="n">y</code>
<code class="p">}</code>
</pre></div>

</div>

<h4 id="hiding-state">hiding state</h4>

<p>Our stack does bundle functions with data, but it doesn&rsquo;t hide its state. &ldquo;Foreign&rdquo; code could interfere with its array or index. So how do we hide these? We already have a closure, let&rsquo;s use it:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">stack</code> <code class="p">=</code> <code class="n">do</code> <code class="p">(</code><code class="n">array</code> <code class="p">=</code> <code class="p">[],</code> <code class="n">index</code> <code class="p">=</code> <code class="o">-</code>1<code class="p">)</code> <code class="o">-&gt;</code>
  <code class="n">push</code><code class="p">:</code> <code class="p">(</code><code class="n">value</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="n">array</code><code class="p">[</code><code class="n">index</code> <code class="o">+</code><code class="p">=</code> 1<code class="p">]</code> <code class="p">=</code> <code class="n">value</code>
  <code class="n">pop</code><code class="p">:</code> <code class="o">-&gt;</code>
    <code class="n">do</code> <code class="p">(</code><code class="n">value</code> <code class="p">=</code> <code class="n">array</code><code class="p">[</code><code class="n">index</code><code class="p">])</code> <code class="o">-&gt;</code>
      <code class="n">array</code><code class="p">[</code><code class="n">index</code><code class="p">]</code> <code class="p">=</code> <code class="n">undefined</code>
      <code class="n">index</code> <code class="o">-</code><code class="p">=</code> 1 <code class="k">if</code> <code class="n">index</code> <code class="o">&gt;</code><code class="p">=</code> 0
      <code class="n">value</code>
  <code class="n">isEmpty</code><code class="p">:</code> <code class="o">-&gt;</code>
    <code class="n">index</code> <code class="o">&lt;</code> 0

<code class="n">stack</code><code class="p">.</code><code class="n">isEmpty</code><code class="p">()</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code>
<code class="n">stack</code><code class="p">.</code><code class="n">push</code><code class="p">(</code><code class="s">&#39;hello&#39;</code><code class="p">)</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="s">&#39;hello&#39;</code>
<code class="n">stack</code><code class="p">.</code><code class="n">push</code><code class="p">(</code><code class="s">&#39;CoffeeScript&#39;</code><code class="p">)</code>
 #<code class="p">=</code><code class="o">&gt;</code> <code class="s">&#39;CoffeeScript&#39;</code>
<code class="n">stack</code><code class="p">.</code><code class="n">isEmpty</code><code class="p">()</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="n">false</code>
<code class="n">stack</code><code class="p">.</code><code class="n">pop</code><code class="p">()</code>
 #<code class="p">=</code><code class="o">&gt;</code> <code class="s">&#39;CoffeeScript&#39;</code>
<code class="n">stack</code><code class="p">.</code><code class="n">pop</code><code class="p">()</code>
 #<code class="p">=</code><code class="o">&gt;</code> <code class="s">&#39;hello&#39;</code>
<code class="n">stack</code><code class="p">.</code><code class="n">isEmpty</code><code class="p">()</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code>
</pre></div>

</div>

<div class="image-with-caption">
  <p><img src="images/coffee-trees-1200.jpg" alt="Coffee DOES grow on trees" />
  <p>Coffee DOES grow on trees</p>
</div>

<p>We don&rsquo;t want to repeat this code every time we want a stack, so let&rsquo;s make ourselves a &ldquo;stack maker:&rdquo;</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">StackMaker</code> <code class="p">=</code> <code class="o">-&gt;</code>
  <code class="n">do</code> <code class="p">(</code><code class="n">array</code> <code class="p">=</code> <code class="p">[],</code> <code class="n">index</code> <code class="p">=</code> <code class="o">-</code>1<code class="p">)</code> <code class="o">-&gt;</code>
    <code class="n">push</code><code class="p">:</code> <code class="p">(</code><code class="n">value</code><code class="p">)</code> <code class="o">-&gt;</code>
      <code class="n">array</code><code class="p">[</code><code class="n">index</code> <code class="o">+</code><code class="p">=</code> 1<code class="p">]</code> <code class="p">=</code> <code class="n">value</code>
    <code class="n">pop</code><code class="p">:</code> <code class="o">-&gt;</code>
      <code class="n">do</code> <code class="p">(</code><code class="n">value</code> <code class="p">=</code> <code class="n">array</code><code class="p">[</code><code class="n">index</code><code class="p">])</code> <code class="o">-&gt;</code>
        <code class="n">array</code><code class="p">[</code><code class="n">index</code><code class="p">]</code> <code class="p">=</code> <code class="n">undefined</code>
        <code class="n">index</code> <code class="o">-</code><code class="p">=</code> 1 <code class="k">if</code> <code class="n">index</code> <code class="o">&gt;</code><code class="p">=</code> 0
        <code class="n">value</code>
    <code class="n">isEmpty</code><code class="p">:</code> <code class="o">-&gt;</code>
      <code class="n">index</code> <code class="o">&lt;</code> 0

<code class="n">stack</code> <code class="p">=</code> <code class="n">StackMaker</code><code class="p">()</code>
</pre></div>

</div>

<p>Now we can make stacks freely, and we&rsquo;ve hidden their internal data elements. We have methods and encapsulation, and we&rsquo;ve built them out of CoffeeScript&rsquo;s fundamental functions and objects. In <a href="#methods">Instances and Classes</a>, we&rsquo;ll look at CoffeeScript&rsquo;s support for class-oriented programming and some of the idioms that functions bring to the party.</p>

<div class="aside sidebarish">
  <hr />
  <h4 id="is-encapsulation-object-oriented">is encapsulation &ldquo;object-oriented?&rdquo;</h4>

  <p>We&rsquo;ve built something with hidden internal state and &ldquo;methods,&rdquo; all without needing special <code>def</code> or <code>private</code> keywords. Mind you, we haven&rsquo;t included all sorts of complicated mechanisms to support inheritance, mixins, and other opportunities for debating the nature of the One True Object-Oriented Style on the Internet.</p>

  <p>Then again, the key lesson experienced programmers repeat (although it often falls on deaf ears) is, <a href="http://www.c2.com/cgi/wiki?CompositionInsteadOfInheritance">Composition instead of Inheritance</a>. So maybe we aren&rsquo;t missing much.</p>

  <hr />
</div>

<div class="page-break" />
<h3 id="composition">Composition and Extension</h3>

<h4 id="composition">composition</h4>

<p>A deeply fundamental practice is to build components out of smaller components. The choice of how to divide a component into smaller components is called <em>factoring</em>, after the operation in number theory <sup id="fnref-refactoring"><a href="#fn-refactoring" rel="footnote">20</a></sup>. </p>

<p>The simplest and easiest way to build components out of smaller components in CoffeeScript is also the most obvious: Each component is a value, and the components can be put together into a single object or encapsulated with a closure.</p>

<p>Here&rsquo;s an abstract &ldquo;model&rdquo; that supports undo and redo composed from a pair of stacks (see <a href="#encapsulation">Encapsulating State</a>) and a Plain Old CoffeeScript Object:</p>

<div class="code-block">
<div class="highlight"><pre><code class="c"># helper function</code>
<code class="n">shallowCopy</code> <code class="p">=</code> <code class="p">(</code><code class="nb">source</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="k">do</code> <code class="p">(</code><code class="n">dest</code> <code class="p">=</code> <code class="p">{},</code> <code class="n">key</code> <code class="p">=</code> <code class="n">undefined</code><code class="p">,</code> <code class="n">value</code> <code class="p">=</code> <code class="n">undefined</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="n">dest</code><code class="p">[</code><code class="n">key</code><code class="p">]</code> <code class="p">=</code> <code class="n">value</code> <code class="k">for</code> <code class="n">own</code> <code class="n">key</code><code class="p">,</code> <code class="n">value</code> <code class="n">of</code> <code class="nb">source</code>
    <code class="n">dest</code>

<code class="c"># our model maker</code>
<code class="n">ModelMaker</code> <code class="p">=</code> <code class="p">(</code><code class="n">initialAttributes</code> <code class="p">=</code> <code class="p">{})</code> <code class="o">-&gt;</code>
  <code class="k">do</code> <code class="p">(</code><code class="n">attributes</code> <code class="p">=</code> <code class="n">shallowCopy</code><code class="p">(</code><code class="n">initialAttributes</code><code class="p">),</code> 
      <code class="n">undoStack</code> <code class="p">=</code> <code class="n">StackMaker</code><code class="p">(),</code> 
      <code class="n">redoStack</code> <code class="p">=</code> <code class="n">StackMaker</code><code class="p">(),</code>
      <code class="n">obj</code> <code class="p">=</code> <code class="n">undefined</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="n">obj</code> <code class="p">=</code> <code class="p">{</code>
      <code class="k">set</code><code class="p">:</code> <code class="p">(</code><code class="n">attrsToSet</code> <code class="p">=</code> <code class="p">{})</code> <code class="o">-&gt;</code>
        <code class="n">undoStack</code><code class="p">.</code><code class="n">push</code><code class="p">(</code><code class="n">shallowCopy</code><code class="p">(</code><code class="n">attributes</code><code class="p">))</code>
        <code class="n">redoStack</code> <code class="p">=</code> <code class="n">StackMaker</code><code class="p">()</code> <code class="n">unless</code> <code class="n">redoStack</code><code class="p">.</code><code class="n">isEmpty</code><code class="p">()</code>
        <code class="n">attributes</code><code class="p">[</code><code class="n">key</code><code class="p">]</code> <code class="p">=</code> <code class="n">value</code> <code class="k">for</code> <code class="n">own</code> <code class="n">key</code><code class="p">,</code> <code class="n">value</code> <code class="n">of</code> <code class="n">attrsToSet</code>
        <code class="n">obj</code>
      <code class="n">undo</code><code class="p">:</code> <code class="o">-&gt;</code>
        <code class="n">unless</code> <code class="n">undoStack</code><code class="p">.</code><code class="n">isEmpty</code><code class="p">()</code>
          <code class="n">redoStack</code><code class="p">.</code><code class="n">push</code><code class="p">(</code><code class="n">shallowCopy</code><code class="p">(</code><code class="n">attributes</code><code class="p">))</code>
          <code class="n">attributes</code> <code class="p">=</code> <code class="n">undoStack</code><code class="p">.</code><code class="n">pop</code><code class="p">()</code>
        <code class="n">obj</code>
      <code class="n">redo</code><code class="p">:</code> <code class="o">-&gt;</code>
        <code class="n">unless</code> <code class="n">redoStack</code><code class="p">.</code><code class="n">isEmpty</code><code class="p">()</code>
          <code class="n">undoStack</code><code class="p">.</code><code class="n">push</code><code class="p">(</code><code class="n">shallowCopy</code><code class="p">(</code><code class="n">attributes</code><code class="p">))</code>
          <code class="n">attributes</code> <code class="p">=</code> <code class="n">redoStack</code><code class="p">.</code><code class="n">pop</code><code class="p">()</code>
        <code class="n">obj</code>
      <code class="k">get</code><code class="p">:</code> <code class="p">(</code><code class="n">key</code><code class="p">)</code> <code class="o">-&gt;</code>
        <code class="n">attributes</code><code class="p">(</code><code class="n">key</code><code class="p">)</code>
      <code class="n">has</code><code class="p">:</code> <code class="p">(</code><code class="n">key</code><code class="p">)</code> <code class="o">-&gt;</code>
        <code class="n">attributes</code><code class="p">.</code><code class="n">hasOwnProperty</code><code class="p">(</code><code class="n">key</code><code class="p">)</code>
      <code class="n">attributes</code><code class="p">:</code> <code class="o">-&gt;</code>
        <code class="n">shallowCopy</code><code class="p">(</code><code class="n">attributes</code><code class="p">)</code>
    <code class="p">}</code>
    <code class="n">obj</code>
</pre></div>

</div>

<p>The techniques used for encapsulation work well with composition. In this case, we have a &ldquo;model&rdquo; that hides its attribute store as well as its implementation that is composed of of an undo stack and redo stack.</p>

<h4 id="extensible">extension</h4>

<p>Another practice that many people consider fundamental is to <em>extend</em> an implementation. Meaning, they wish to define a new data structure in terms of adding new operations and semantics to an existing data structure.</p>

<p>Consider a <a href="http://duckduckgo.com/Queue_" title="data_structure">queue</a>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">QueueMaker</code> <code class="p">=</code> <code class="o">-&gt;</code>
  <code class="n">do</code> <code class="p">(</code><code class="n">array</code> <code class="p">=</code> <code class="p">[],</code> <code class="n">head</code> <code class="p">=</code> 0<code class="p">,</code> <code class="n">tail</code> <code class="p">=</code> <code class="o">-</code>1<code class="p">)</code> <code class="o">-&gt;</code>
    <code class="n">pushTail</code><code class="p">:</code> <code class="p">(</code><code class="n">value</code><code class="p">)</code> <code class="o">-&gt;</code>
      <code class="n">array</code><code class="p">[</code><code class="n">tail</code> <code class="o">+</code><code class="p">=</code> 1<code class="p">]</code> <code class="p">=</code> <code class="n">value</code>
    <code class="n">pullHead</code><code class="p">:</code> <code class="o">-&gt;</code>
      <code class="k">if</code> <code class="n">tail</code> <code class="o">&gt;</code><code class="p">=</code> <code class="n">head</code>
        <code class="n">do</code> <code class="p">(</code><code class="n">value</code> <code class="p">=</code> <code class="n">array</code><code class="p">[</code><code class="n">head</code><code class="p">])</code> <code class="o">-&gt;</code>
          <code class="n">array</code><code class="p">[</code><code class="n">head</code><code class="p">]</code> <code class="p">=</code> <code class="n">undefined</code>
          <code class="n">head</code> <code class="o">+</code><code class="p">=</code> 1
          <code class="n">value</code>
    <code class="n">isEmpty</code><code class="p">:</code> <code class="o">-&gt;</code>
      <code class="n">tail</code> <code class="o">&lt;</code> <code class="n">head</code>
</pre></div>

</div>

<p>Now we wish to create a <a href="https://en.wikipedia.org/wiki/Double-ended_queue" title="Double-ended queue">deque</a> by adding <code>pullTail</code> and <code>pushHead</code> operations to our queue.<sup id="fnref-wasa"><a href="#fn-wasa" rel="footnote">21</a></sup> Unfortunately, encapsulation prevents us from adding operations that interact with the hidden data structures.</p>

<p>This isn&rsquo;t really surprising: The entire point of encapsulation is to create an opaque data structure that can only be manipulated through its public interface. The design goals of encapsulation and extension are always going to exist in tension.</p>

<p>Let&rsquo;s &ldquo;de-encapsulate&rdquo; our queue:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">QueueMaker</code> <code class="p">=</code> <code class="o">-&gt;</code>
  <code class="n">do</code> <code class="p">(</code><code class="n">queue</code> <code class="p">=</code> <code class="n">undefined</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="n">queue</code> <code class="p">=</code> 
      <code class="n">array</code><code class="p">:</code> <code class="p">[]</code>
      <code class="n">head</code><code class="p">:</code> 0
      <code class="n">tail</code><code class="p">:</code> <code class="o">-</code>1
      <code class="n">pushTail</code><code class="p">:</code> <code class="p">(</code><code class="n">value</code><code class="p">)</code> <code class="o">-&gt;</code>
        <code class="n">queue</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">queue</code><code class="p">.</code><code class="n">tail</code> <code class="o">+</code><code class="p">=</code> 1<code class="p">]</code> <code class="p">=</code> <code class="n">value</code>
      <code class="n">pullHead</code><code class="p">:</code> <code class="o">-&gt;</code>
        <code class="n">unless</code> <code class="n">queue</code><code class="p">.</code><code class="n">isEmpty</code><code class="p">()</code>
          <code class="n">do</code> <code class="p">(</code><code class="n">value</code> <code class="p">=</code> <code class="n">queue</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">queue</code><code class="p">.</code><code class="n">head</code><code class="p">])</code> <code class="o">-&gt;</code>
            <code class="n">queue</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">queue</code><code class="p">.</code><code class="n">head</code><code class="p">]</code> <code class="p">=</code> <code class="n">undefined</code>
            <code class="n">queue</code><code class="p">.</code><code class="n">head</code> <code class="o">+</code><code class="p">=</code> 1
            <code class="n">value</code>
      <code class="n">isEmpty</code><code class="p">:</code> <code class="o">-&gt;</code>
        <code class="n">queue</code><code class="p">.</code><code class="n">tail</code> <code class="o">&lt;</code> <code class="n">queue</code><code class="p">.</code><code class="n">head</code>
</pre></div>

</div>

<p>Now we can extend a queue into a deque, with a little help from a helper function <code>extend</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="c"># helper function</code>
<code class="n">extend</code> <code class="p">=</code> <code class="p">(</code><code class="n">object</code><code class="p">,</code> <code class="n">extensions</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="n">object</code><code class="p">[</code><code class="n">key</code><code class="p">]</code> <code class="p">=</code> <code class="n">value</code> <code class="k">for</code> <code class="n">key</code><code class="p">,</code> <code class="n">value</code> <code class="n">of</code> <code class="n">extensions</code>
  <code class="n">object</code>

<code class="c"># a deque maker</code>
<code class="n">DequeMaker</code> <code class="p">=</code> <code class="o">-&gt;</code>
  <code class="k">do</code> <code class="p">(</code><code class="n">deque</code> <code class="p">=</code> <code class="n">QueueMaker</code><code class="p">())</code> <code class="o">-&gt;</code>
    <code class="n">extend</code><code class="p">(</code><code class="n">deque</code><code class="p">,</code>
      <code class="nb">size</code><code class="p">:</code> <code class="o">-&gt;</code>
        <code class="n">deque</code><code class="p">.</code><code class="n">tail</code> <code class="o">-</code> <code class="n">deque</code><code class="p">.</code><code class="n">head</code> <code class="o">+</code> 1
      <code class="n">pullTail</code><code class="p">:</code> <code class="o">-&gt;</code>
        <code class="n">unless</code> <code class="n">deque</code><code class="p">.</code><code class="n">isEmpty</code><code class="p">()</code>
          <code class="k">do</code> <code class="p">(</code><code class="n">value</code> <code class="p">=</code> <code class="n">deque</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">deque</code><code class="p">.</code><code class="n">tail</code><code class="p">])</code> <code class="o">-&gt;</code>
            <code class="n">deque</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">deque</code><code class="p">.</code><code class="n">tail</code><code class="p">]</code> <code class="p">=</code> <code class="n">undefined</code>
            <code class="n">deque</code><code class="p">.</code><code class="n">tail</code> <code class="o">-=</code> 1
            <code class="n">value</code>
      <code class="n">pushHead</code><code class="p">:</code> <code class="k">do</code> <code class="p">(</code><code class="n">INCREMENT</code> <code class="p">=</code> 4<code class="p">)</code> <code class="o">-&gt;</code>
        <code class="p">(</code><code class="n">value</code><code class="p">)</code> <code class="o">-&gt;</code>
          <code class="k">if</code> <code class="n">deque</code><code class="p">.</code><code class="n">head</code> <code class="n">is</code> 0
            <code class="k">for</code> <code class="n">i</code> <code class="n">in</code> <code class="p">[</code><code class="n">deque</code><code class="p">.</code><code class="n">tail</code><code class="p">..</code><code class="n">deque</code><code class="p">.</code><code class="n">head</code><code class="p">]</code>
              <code class="n">deque</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">i</code> <code class="o">+</code> <code class="n">INCREMENT</code><code class="p">]</code> <code class="p">=</code> <code class="n">deque</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">i</code><code class="p">]</code>
            <code class="n">deque</code><code class="p">.</code><code class="n">tail</code> <code class="o">+=</code> <code class="n">INCREMENT</code>
            <code class="n">deque</code><code class="p">.</code><code class="n">head</code> <code class="o">+=</code> <code class="n">INCREMENT</code>
          <code class="n">deque</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">deque</code><code class="p">.</code><code class="n">head</code> <code class="o">-=</code> 1<code class="p">]</code> <code class="p">=</code> <code class="n">value</code>
    <code class="p">)</code>
</pre></div>

</div>

<p>Presto, we have reuse through extension, at the cost of encapsulation.</p>

<div class="tip sidebarish">
  <hr />
  <p><img class="sidebar-image" alt="tip" src="images/leanpub_tip.png" />Encapsulation and Extension exist in a natural state of tension. A program with elaborate encapsulation resists breakage but can also be difficult to refactor in other ways. Be mindful of when it&rsquo;s best to Compose and when it&rsquo;s best to Extend.</p>

  <hr />
</div>

<div class="page-break" />
<h3 id="this">This and That</h3>

<p>Let&rsquo;s take another look at <a href="#extensible">extensible objects</a>. Here&rsquo;s a Queue:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">QueueMaker</code> <code class="p">=</code> <code class="o">-&gt;</code>
  <code class="n">do</code> <code class="p">(</code><code class="n">queue</code> <code class="p">=</code> <code class="n">undefined</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="n">queue</code> <code class="p">=</code> 
      <code class="n">array</code><code class="p">:</code> <code class="p">[]</code>
      <code class="n">head</code><code class="p">:</code> 0
      <code class="n">tail</code><code class="p">:</code> <code class="o">-</code>1
      <code class="n">pushTail</code><code class="p">:</code> <code class="p">(</code><code class="n">value</code><code class="p">)</code> <code class="o">-&gt;</code>
        <code class="n">queue</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">queue</code><code class="p">.</code><code class="n">tail</code> <code class="o">+</code><code class="p">=</code> 1<code class="p">]</code> <code class="p">=</code> <code class="n">value</code>
      <code class="n">pullHead</code><code class="p">:</code> <code class="n">do</code> <code class="p">(</code><code class="n">value</code> <code class="p">=</code> <code class="n">undefined</code><code class="p">)</code> <code class="o">-&gt;</code>
                  <code class="o">-&gt;</code>
                    <code class="n">unless</code> <code class="n">queue</code><code class="p">.</code><code class="n">isEmpty</code><code class="p">()</code>
                      <code class="n">value</code> <code class="p">=</code> <code class="n">queue</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">queue</code><code class="p">.</code><code class="n">head</code><code class="p">]</code>
                      <code class="n">queue</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">queue</code><code class="p">.</code><code class="n">head</code><code class="p">]</code> <code class="p">=</code> <code class="n">undefined</code>
                      <code class="n">queue</code><code class="p">.</code><code class="n">head</code> <code class="o">+</code><code class="p">=</code> 1
                      <code class="n">value</code>
      <code class="n">isEmpty</code><code class="p">:</code> <code class="o">-&gt;</code>
        <code class="n">queue</code><code class="p">.</code><code class="n">tail</code> <code class="o">&lt;</code> <code class="n">queue</code><code class="p">.</code><code class="n">head</code>

<code class="n">queue</code> <code class="p">=</code> <code class="n">QueueMaker</code><code class="p">()</code>
<code class="n">queue</code><code class="p">.</code><code class="n">pushTail</code><code class="p">(</code><code class="s">&#39;Hello&#39;</code><code class="p">)</code>
<code class="n">queue</code><code class="p">.</code><code class="n">pushTail</code><code class="p">(</code><code class="s">&#39;CoffeeScript&#39;</code><code class="p">)</code>
</pre></div>

</div>

<p>Let&rsquo;s make a copy of our queue using a handy <code>extend</code> function and a comprehension to make sure we copy the array properly:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">extend</code> <code class="p">=</code> <code class="p">(</code><code class="n">object</code><code class="p">,</code> <code class="n">extensions</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="n">object</code><code class="p">[</code><code class="n">key</code><code class="p">]</code> <code class="p">=</code> <code class="n">value</code> <code class="k">for</code> <code class="n">key</code><code class="p">,</code> <code class="n">value</code> <code class="n">of</code> <code class="n">extensions</code>
  <code class="n">object</code>

<code class="n">copyOfQueue</code> <code class="p">=</code> <code class="n">extend</code><code class="p">({},</code> <code class="n">queue</code><code class="p">)</code>
<code class="n">copyOfQueue</code><code class="p">.</code><code class="n">array</code> <code class="p">=</code> <code class="p">(</code><code class="n">element</code> <code class="k">for</code> <code class="n">element</code> <code class="n">in</code> <code class="n">queue</code><code class="p">.</code><code class="n">array</code><code class="p">)</code>

<code class="n">queue</code> <code class="n">isnt</code> <code class="n">copyOfQueue</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code>
</pre></div>

</div>

<p>And start playing with our copies:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">copyOfQueue</code><code class="p">.</code><code class="n">pullHead</code><code class="p">()</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="s">&#39;Hello&#39;</code>
  
<code class="n">queue</code><code class="p">.</code><code class="n">pullHead</code><code class="p">()</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="s">&#39;CoffeeScript&#39;</code>
</pre></div>

</div>

<p>What!? Even though we carefully made a copy of the array to prevent aliasing, it seems that our two queues behave like aliases of each other. The problem is that while we&rsquo;ve carefully copied our array and other elements over, the closures all share the same environment, and therefore the functions in <code>copyOfQueue</code> all operate on the first queue.</p>

<div class="aside sidebarish">
  <hr />
  <p>This is a general issue with closures. Closures couple functions to environments, and that makes them very elegant in the small, and very handy for making opaque data structures. Alas, their strength in the small is their weakness in the large. When you&rsquo;re trying to make reusable components, this coupling is sometimes a hindrance.</p>

  <hr />
</div>

<p>Let&rsquo;s take an impossibly optimistic flight of fancy:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">AmnesiacQueueMaker</code> <code class="p">=</code> <code class="o">-&gt;</code>
  <code class="n">array</code><code class="p">:</code> <code class="p">[]</code>
  <code class="n">head</code><code class="p">:</code> 0
  <code class="n">tail</code><code class="p">:</code> <code class="o">-</code>1
  <code class="n">pushTail</code><code class="p">:</code> <code class="p">(</code><code class="n">myself</code><code class="p">,</code> <code class="n">value</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="n">myself</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">myself</code><code class="p">.</code><code class="n">tail</code> <code class="o">+</code><code class="p">=</code> 1<code class="p">]</code> <code class="p">=</code> <code class="n">value</code>
  <code class="n">pullHead</code><code class="p">:</code> <code class="n">do</code> <code class="p">(</code><code class="n">value</code> <code class="p">=</code> <code class="n">undefined</code><code class="p">)</code> <code class="o">-&gt;</code>
              <code class="p">(</code><code class="n">myself</code><code class="p">)</code> <code class="o">-&gt;</code>
                <code class="n">unless</code> <code class="n">myself</code><code class="p">.</code><code class="n">isEmpty</code><code class="p">(</code><code class="n">myself</code><code class="p">)</code>
                  <code class="n">value</code> <code class="p">=</code> <code class="n">myself</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">myself</code><code class="p">.</code><code class="n">head</code><code class="p">]</code>
                  <code class="n">myself</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">myself</code><code class="p">.</code><code class="n">head</code><code class="p">]</code> <code class="p">=</code> <code class="n">undefined</code>
                  <code class="n">myself</code><code class="p">.</code><code class="n">head</code> <code class="o">+</code><code class="p">=</code> 1
                  <code class="n">value</code>
  <code class="n">isEmpty</code><code class="p">:</code> <code class="p">(</code><code class="n">myself</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="n">myself</code><code class="p">.</code><code class="n">tail</code> <code class="o">&lt;</code> <code class="n">myself</code><code class="p">.</code><code class="n">head</code>

<code class="n">queueWithAmnesia</code> <code class="p">=</code> <code class="n">AmnesiacQueueMaker</code><code class="p">()</code>
<code class="n">queueWithAmnesia</code><code class="p">.</code><code class="n">pushTail</code><code class="p">(</code><code class="n">queueWithAmnesia</code><code class="p">,</code> <code class="s">&#39;Hello&#39;</code><code class="p">)</code>
<code class="n">queueWithAmnesia</code><code class="p">.</code><code class="n">pushTail</code><code class="p">(</code><code class="n">queueWithAmnesia</code><code class="p">,</code> <code class="s">&#39;CoffeeScript&#39;</code><code class="p">)</code>
</pre></div>

</div>

<p>The <code>AmnesiacQueueMaker</code> makes queues with amnesia: They don&rsquo;t know who they are, so every time we invoke one of their functions, we have to tell them who they are. You can work out the implications for copying queues as a thought experiment: We don&rsquo;t have to worry about environments, because every function operates on the queue you pass in.</p>

<p>The killer drawback, of course, is making sure we are always passing the correct queue in every time we invoke a function. What to do?</p>

<h4 id="whats-all-this">what&rsquo;s all <code>this</code>?</h4>

<p>Any time we must do the same repetitive thing over and over and over again, we industrial humans try to build a machine to do it for us. CoffeeScript is one such machine:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">BanksQueueMaker</code> <code class="p">=</code> <code class="o">-&gt;</code>
  <code class="n">array</code><code class="p">:</code> <code class="p">[]</code>
  <code class="n">head</code><code class="p">:</code> 0
  <code class="n">tail</code><code class="p">:</code> <code class="o">-</code>1
  <code class="n">pushTail</code><code class="p">:</code> <code class="p">(</code><code class="n">value</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="n">this</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">this</code><code class="p">.</code><code class="n">tail</code> <code class="o">+</code><code class="p">=</code> 1<code class="p">]</code> <code class="p">=</code> <code class="n">value</code>
  <code class="n">pullHead</code><code class="p">:</code> <code class="n">do</code> <code class="p">(</code><code class="n">value</code> <code class="p">=</code> <code class="n">undefined</code><code class="p">)</code> <code class="o">-&gt;</code>
              <code class="o">-&gt;</code>
                <code class="n">unless</code> <code class="n">this</code><code class="p">.</code><code class="n">isEmpty</code><code class="p">()</code>
                  <code class="n">value</code> <code class="p">=</code> <code class="n">this</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">this</code><code class="p">.</code><code class="n">head</code><code class="p">]</code>
                  <code class="n">this</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">this</code><code class="p">.</code><code class="n">head</code><code class="p">]</code> <code class="p">=</code> <code class="n">undefined</code>
                  <code class="n">this</code><code class="p">.</code><code class="n">head</code> <code class="o">+</code><code class="p">=</code> 1
                  <code class="n">value</code>
  <code class="n">isEmpty</code><code class="p">:</code> <code class="o">-&gt;</code>
    <code class="n">this</code><code class="p">.</code><code class="n">tail</code> <code class="o">&lt;</code> <code class="n">this</code><code class="p">.</code><code class="n">head</code>

<code class="n">banksQueue</code> <code class="p">=</code> <code class="n">BanksQueueMaker</code><code class="p">()</code>
<code class="n">banksQueue</code><code class="p">.</code><code class="n">pushTail</code><code class="p">(</code><code class="s">&#39;Hello&#39;</code><code class="p">)</code>
<code class="n">banksQueue</code><code class="p">.</code><code class="n">pushTail</code><code class="p">(</code><code class="s">&#39;CoffeeScript&#39;</code><code class="p">)</code> 
</pre></div>

</div>

<p>Every time you invoke a function that is a member of an object, CoffeeScript binds that object to the name <code>this</code> in the environment of the function just as if it was an argument.<sup id="fnref-this"><a href="#fn-this" rel="footnote">22</a></sup> Now we can easily make copies:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">copyOfQueue</code> <code class="p">=</code> <code class="n">extend</code><code class="p">({},</code> <code class="n">banksQueue</code><code class="p">)</code>
<code class="n">copyOfQueue</code><code class="p">.</code><code class="n">array</code> <code class="p">=</code> <code class="p">(</code><code class="n">element</code> <code class="k">for</code> <code class="n">element</code> <code class="n">in</code> <code class="n">banksQueue</code><code class="p">.</code><code class="n">array</code><code class="p">)</code>

<code class="n">copyOfQueue</code><code class="p">.</code><code class="n">pullHead</code><code class="p">()</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="s">&#39;Hello&#39;</code>
  
<code class="n">banksQueue</code><code class="p">.</code><code class="n">pullHead</code><code class="p">()</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="s">&#39;Hello&#39;</code>
</pre></div>

</div>

<p>Presto, we now have a way to copy arrays. By getting rid of the closure and taking advantage of <code>this</code>, we have functions that are more easily portable between objects, and the code is simpler as well.</p>

<div class="tip sidebarish">
  <hr />
  <p><img class="sidebar-image" alt="tip" src="images/leanpub_tip.png" />Closures tightly couple functions to the environments where they are created limiting their flexibility. Using <code>this</code> alleviates the coupling. Copying objects is but one example of where that flexibility is needed.</p>

  <hr />
</div>

<h4 id="fat-arrows-are-the-cure-for-obese-idioms">fat arrows are the cure for obese idioms</h4>

<p>Wait a second! Let&rsquo;s flip back <a href="#extensible" title="extension">a few pages</a> and look at the code for a Queue:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">QueueMaker</code> <code class="p">=</code> <code class="o">-&gt;</code>
  <code class="n">do</code> <code class="p">(</code><code class="n">queue</code> <code class="p">=</code> <code class="n">undefined</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="n">queue</code> <code class="p">=</code> 
      <code class="n">array</code><code class="p">:</code> <code class="p">[]</code>
      <code class="n">head</code><code class="p">:</code> 0
      <code class="n">tail</code><code class="p">:</code> <code class="o">-</code>1
      <code class="n">pushTail</code><code class="p">:</code> <code class="p">(</code><code class="n">value</code><code class="p">)</code> <code class="o">-&gt;</code>
        <code class="n">queue</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">queue</code><code class="p">.</code><code class="n">tail</code> <code class="o">+</code><code class="p">=</code> 1<code class="p">]</code> <code class="p">=</code> <code class="n">value</code>
      <code class="n">pullHead</code><code class="p">:</code> <code class="o">-&gt;</code>
        <code class="n">unless</code> <code class="n">queue</code><code class="p">.</code><code class="n">isEmpty</code><code class="p">()</code>
          <code class="n">do</code> <code class="p">(</code><code class="n">value</code> <code class="p">=</code> <code class="n">queue</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">queue</code><code class="p">.</code><code class="n">head</code><code class="p">])</code> <code class="o">-&gt;</code>
            <code class="n">queue</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">queue</code><code class="p">.</code><code class="n">head</code><code class="p">]</code> <code class="p">=</code> <code class="n">undefined</code>
            <code class="n">queue</code><code class="p">.</code><code class="n">head</code> <code class="o">+</code><code class="p">=</code> 1
            <code class="n">value</code>
      <code class="n">isEmpty</code><code class="p">:</code> <code class="o">-&gt;</code>
        <code class="n">queue</code><code class="p">.</code><code class="n">tail</code> <code class="o">&lt;</code> <code class="n">queue</code><code class="p">.</code><code class="n">head</code>
</pre></div>

</div>

<p>Spot the difference? Here&rsquo;s the <code>pullHead</code> function we&rsquo;re using now:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">pullHead</code><code class="o">:</code> <code class="k">do</code> <code class="o">(</code><code class="n">value</code> <code class="o">=</code> <code class="kc">undefined</code><code class="o">)</code> <code class="o">-&gt;</code>
            <code class="o">-&gt;</code>
              <code class="n">unless</code> <code class="k">this</code><code class="o">.</code><code class="na">isEmpty</code><code class="o">()</code>
                <code class="n">value</code> <code class="o">=</code> <code class="k">this</code><code class="o">.</code><code class="na">array</code><code class="o">[</code><code class="k">this</code><code class="o">.</code><code class="na">head</code><code class="o">]</code>
                <code class="k">this</code><code class="o">.</code><code class="na">array</code><code class="o">[</code><code class="k">this</code><code class="o">.</code><code class="na">head</code><code class="o">]</code> <code class="o">=</code> <code class="kc">undefined</code>
                <code class="k">this</code><code class="o">.</code><code class="na">head</code> <code class="o">+=</code> <code class="mi">1</code>
                <code class="n">value</code>
</pre></div>

</div>

<p>Sneaky: The version of the <code>pullHead</code> function moves the <code>do</code> outside the function. Why? Let&rsquo;s rewrite it to look like the old version:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">pullHead</code><code class="p">:</code> <code class="o">-&gt;</code>
  <code class="n">unless</code> <code class="n">this</code><code class="p">.</code><code class="n">isEmpty</code><code class="p">()</code>
    <code class="n">do</code> <code class="p">(</code><code class="n">value</code> <code class="p">=</code> <code class="n">this</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">this</code><code class="p">.</code><code class="n">head</code><code class="p">])</code> <code class="o">-&gt;</code>
      <code class="n">this</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">this</code><code class="p">.</code><code class="n">head</code><code class="p">]</code> <code class="p">=</code> <code class="n">undefined</code>
      <code class="n">this</code><code class="p">.</code><code class="n">head</code> <code class="o">+</code><code class="p">=</code> 1
      <code class="n">value</code>
</pre></div>

</div>

<p>Notice that we have a function. We invoke it, and <code>this</code> is set to our object. Then, thanks to the <code>do</code>, we invoke another function inside that. The function invoked by the <code>do</code> keyword does not belong to our object, so <code>this</code> is not set to our object. Oops!</p>

<div class="aside sidebarish">
  <hr />
  <p>Interestingly, this showcases one of CoffeeScript&rsquo;s greatest strengths and weaknesses. Since everything&rsquo;s a function, we have a set of tools that interoperate on everything the exact same way. However, there are some ways that functions don&rsquo;t appear to do exactly what we think they&rsquo;ll do.</p>

  <p>For example, if you put a <code>return 'foo'</code> inside a <code>do</code>, you don&rsquo;t return from the function enclosing the do, you return from the <code>do</code> itself. And as we see, <code>this</code> gets set &ldquo;incorrectly.&rdquo; The Ruby programming language tries to solve this problem by having something&ndash;blocks&ndash;that look a lot like functions, but act more like syntax. The cost of that decision, of course, is that you have two different kinds of things that look similar but behave differently. (Make that five: Ruby has unbound methods, bound methods, procs, lambdas, and blocks.)</p>

  <hr />
</div>

<p>There are two solutions. The error-prone workaround is to write:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">pullHead</code><code class="p">:</code> <code class="o">-&gt;</code>
  <code class="n">unless</code> <code class="n">this</code><code class="p">.</code><code class="n">isEmpty</code><code class="p">()</code>
    <code class="n">do</code> <code class="p">(</code><code class="n">value</code> <code class="p">=</code> <code class="n">this</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">this</code><code class="p">.</code><code class="n">head</code><code class="p">],</code> <code class="n">that</code> <code class="p">=</code> <code class="n">this</code><code class="p">)</code> <code class="o">-&gt;</code>
      <code class="n">that</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">that</code><code class="p">.</code><code class="n">head</code><code class="p">]</code> <code class="p">=</code> <code class="n">undefined</code>
      <code class="n">that</code><code class="p">.</code><code class="n">head</code> <code class="o">+</code><code class="p">=</code> 1
      <code class="n">value</code>
</pre></div>

</div>

<p>Besides its lack of pulchritude, there are many opportunities to mistakingly write <code>this</code> when you meant to write <code>that</code>. Or <code>that</code> for <code>this</code>. Or something, especially when refactoring some code.</p>

<p>The better way is to force the function to have the <code>this</code> you want. CoffeeScript gives you the &ldquo;fat arrow&rdquo; or <code>=&gt;</code> for this purpose. Here it is:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">pullHead</code><code class="p">:</code> <code class="o">-&gt;</code>
  <code class="n">unless</code> <code class="n">this</code><code class="p">.</code><code class="n">isEmpty</code><code class="p">()</code>
    <code class="n">do</code> <code class="p">(</code><code class="n">value</code> <code class="p">=</code> <code class="n">this</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">this</code><code class="p">.</code><code class="n">head</code><code class="p">])</code> <code class="p">=</code><code class="o">&gt;</code>
      <code class="n">this</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">this</code><code class="p">.</code><code class="n">head</code><code class="p">]</code> <code class="p">=</code> <code class="n">undefined</code>
      <code class="n">this</code><code class="p">.</code><code class="n">head</code> <code class="o">+</code><code class="p">=</code> 1
      <code class="n">value</code>
</pre></div>

</div>

<p>The fat arrow says, &ldquo;Treat this function as if we did the <code>this</code> and <code>that</code> idiom, so that whenever I refer to <code>this</code>, I get the outer one.&rdquo; Which is exactly what we want if we don&rsquo;t care to rearrange our code.</p>

<div class="page-break" />
<h3 id="summary-2">Summary</h3>

<div class="tip sidebarish">
  <hr />
  <h4 id="objects-mutation-and-state"><img class="sidebar-image" alt="tip" src="images/leanpub_tip.png" />Objects, Mutation, and State</h4>

  <ul>
    <li>CoffeeScript permits reassignment/rebinding of variables.</li>
    <li>Arrays and Objects are mutable.</li>
    <li>References permit aliasing of reference types.</li>
    <li>The <code>letrec</code> pattern permits defining recursive or mutually dependent functions.</li>
    <li>&ldquo;Normal Case&rdquo; variables are automagically scoped.</li>
    <li>Comprehensions are convenient, but require care to avoid scoping bugs.</li>
    <li>State can be encapsulated/hidden with closures.</li>
    <li>Encapsulations can be aggregated with composition.</li>
    <li>Encapsulation resists extension.</li>
    <li>The automagic binding <code>this</code> facilitates sharing of functions.</li>
    <li>The fat arrow (<code>=&gt;</code>) is syntactic sugar for binding <code>this</code>.</li>
  </ul>

  <hr />
</div>

<h2 id="methods">Finish the Cup: Instances and Classes</h2>

<div class="image-with-caption">
  <p><img src="images/beans1.jpg" alt="Other languages call their objects &quot;beans,&quot; but serve extra-weak coffee in an attempt to be all things to all people" />
  <p>Other languages call their objects "beans," but serve extra-weak coffee in an attempt to be all things to all people</p>
</div>

<p>As discussed in <a href="#poco">References, Identity, Arrays, and Objects</a> and again in <a href="#encapsulation">Encapsulating State</a>, CoffeeScript objects are very simple, yet the combination of objects, functions, and closures can create powerful data structures. That being said, there are language features that cannot be implemented with Plain Old CoffeeScript Objects, functions, and closures<sup id="fnref-turing"><a href="#fn-turing" rel="footnote">23</a></sup>.</p>

<p>One of them is <em>inheritance</em>. In CoffeeScript, inheritance provides a cleaner, simpler mechanism for extending data structures, domain models, and anything else you represent as a bundle of state and operations.</p>

<div class="page-break" />
<h3 id="prototypes-are-simple-its-the-explanations-that-are-hard-to-understand">Prototypes are Simple, it&rsquo;s the Explanations that are Hard To Understand</h3>

<p>As you recall from our code for making objects <a href="#extensible">extensible</a>, we wrote a function that returned a Plain Old CoffeeScript Object. The colloquial term for this kind of function is a &ldquo;Factory Function.&rdquo;</p>

<p>Let&rsquo;s strip a function down to the very bare essentials:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">Ur</code> <code class="p">=</code> <code class="o">-&gt;</code>
</pre></div>

</div>

<p>This doesn&rsquo;t look like a factory function: It doesn&rsquo;t have an expression that yields a Plain Old CoffeeScript Object when the function is applied. Yet, there is a way to make an object out of it. Behold the power of the <code>new</code> keyword:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">new</code> <code class="n">Ur</code><code class="p">()</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="p">{}</code>
</pre></div>

</div>

<p>We got an object back! What can we find out about this object?</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">new</code> <code class="n">Ur</code><code class="p">()</code> <code class="n">is</code> <code class="n">new</code> <code class="n">Ur</code><code class="p">()</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="n">false</code>
</pre></div>

</div>

<p>Every time we call <code>new</code> with a function and get an object back, we get a unique object. We could call these &ldquo;Objects created with the <code>new</code> keyword,&rdquo; but this would be cumbersome. So we&rsquo;re going to call them <em>instances</em>. Instances of what? Instances of the function that creates them. So given <code>i = new Ur()</code>, we say that <code>i</code> is an instance of <code>Ur</code>.</p>

<p>For reasons that will be explained after we&rsquo;ve discussed prototypes, we also say that <code>Ur</code> is the <em>constructor</em> of <code>i</code>, and that <code>Ur</code> is a <em>constructor function</em>. Therefore, an instance is an object created by using the <code>new</code> keyword on a constructor function, and that function is the instance&rsquo;s constructor.</p>

<div class="aside sidebarish">
  <hr />
  <p>We are going to look at CoffeeScript&rsquo;s <code>class</code> keyword later, but it&rsquo;s worth noting that what CoffeeScript calls a constructor function does almost everything that people think of when they use the word &ldquo;class.&rdquo; It constructs instances, it defines their common behaviour, and it can be tested.</p>

  <hr />
</div>

<h4 id="prototypes">prototypes</h4>

<p>There&rsquo;s more. Here&rsquo;s something you may not know about functions:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">Ur</code><code class="p">.</code><code class="n">prototype</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="p">{}</code>
</pre></div>

</div>

<p>What&rsquo;s this prototype? Let&rsquo;s run our standard test:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">(</code><code class="o">-&gt;</code><code class="p">).</code><code class="n">prototype</code> <code class="n">is</code> <code class="p">(</code><code class="o">-&gt;</code><code class="p">).</code><code class="n">prototype</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="n">false</code>
</pre></div>

</div>

<p>Every function is initialized with its own unique <code>prototype</code>. What does it do? Let&rsquo;s try something:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">Ur</code><code class="p">.</code><code class="n">prototype</code><code class="p">.</code><code class="n">language</code> <code class="p">=</code> <code class="s">&#39;CoffeeScript&#39;</code>

<code class="n">continent</code> <code class="p">=</code> <code class="n">new</code> <code class="n">Ur</code><code class="p">()</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="p">{}</code>
<code class="n">continent</code><code class="p">.</code><code class="n">language</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="s">&#39;CoffeeScript&#39;</code>
</pre></div>

</div>

<p>That&rsquo;s very interesting! Instances seem to behave as if they had the same elements as their constructor&rsquo;s prototype. Let&rsquo;s try a few things:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">continent</code><code class="p">.</code><code class="n">language</code> <code class="p">=</code> <code class="s">&#39;JavaScript&#39;</code>
<code class="n">continent</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="p">{</code><code class="n">language</code><code class="p">:</code> <code class="s">&#39;JavaScript&#39;</code><code class="p">}</code>
<code class="n">continent</code><code class="p">.</code><code class="n">language</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="s">&#39;JavaScript&#39;</code>
<code class="n">Ur</code><code class="p">.</code><code class="n">prototype</code><code class="p">.</code><code class="n">language</code>
  <code class="s">&#39;CoffeeScript&#39;</code>
</pre></div>

</div>

<p>You can set elements of an instance, and they &ldquo;override&rdquo; the constructor&rsquo;s prototype, but they don&rsquo;t actually change the constructor&rsquo;s prototype. Let&rsquo;s make another instance and try something else.</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">another</code> <code class="p">=</code> <code class="n">new</code> <code class="n">Ur</code><code class="p">()</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="p">{}</code>
<code class="n">another</code><code class="p">.</code><code class="n">language</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="s">&#39;CoffeeScript&#39;</code>
</pre></div>

</div>

<p>New instances don&rsquo;t acquire any changes made to other instances. Makes sense. And:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">Ur</code><code class="p">.</code><code class="n">prototype</code><code class="p">.</code><code class="n">language</code> <code class="p">=</code> <code class="s">&#39;Sumerian&#39;</code>
<code class="n">another</code><code class="p">.</code><code class="n">language</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="s">&#39;Sumerian&#39;</code>
</pre></div>

</div>

<p>Even more interesting: Changing the constructor&rsquo;s prototype changes the behaviour of all of its instances. This strongly implies that there is a dynamic relationship between instances and their constructors, rather than some kind of mechanism that makes objects by copying.<sup id="fnref-dynamic"><a href="#fn-dynamic" rel="footnote">24</a></sup></p>

<p>Speaking of prototypes, here&rsquo;s something else that&rsquo;s very interesting:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">continent</code><code class="p">.</code><code class="n">constructor</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="p">[</code><code class="n">Function</code><code class="p">]</code>
  
<code class="n">continent</code><code class="p">.</code><code class="n">constructor</code> <code class="n">is</code> <code class="n">Ur</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code>
</pre></div>

</div>

<p>Every instance acquires a <code>constructor</code> element that is initialized to their constructor. This is true even for objects we don&rsquo;t create with <code>new</code> in our own code:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">{}.</code><code class="n">constructor</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="p">[</code><code class="n">Function</code><code class="p">:</code> <code class="n">Object</code><code class="p">]</code>
</pre></div>

</div>

<p>If that&rsquo;s true, what about prototypes? Do they have constructors?</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">Ur</code><code class="p">.</code><code class="n">prototype</code><code class="p">.</code><code class="n">constructor</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="p">[</code><code class="n">Function</code><code class="p">]</code>
<code class="n">Ur</code><code class="p">.</code><code class="n">prototype</code><code class="p">.</code><code class="n">constructor</code> <code class="n">is</code> <code class="n">Ur</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code>
</pre></div>

</div>

<p>Very interesting! We will take another look at the <code>constructor</code> element when we discuss <a href="#classextension">class extension</a>.</p>

<h4 id="revisiting-this-idea-of-queues">revisiting <code>this</code> idea of queues</h4>

<p>Let&rsquo;s rewrite our Queue to use <code>new</code> and <code>.prototype</code>, using <code>this</code> and <code>=&gt;</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">extend</code> <code class="p">=</code> <code class="p">(</code><code class="n">object</code><code class="p">,</code> <code class="n">extensions</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="n">object</code><code class="p">[</code><code class="n">key</code><code class="p">]</code> <code class="p">=</code> <code class="n">value</code> <code class="k">for</code> <code class="n">key</code><code class="p">,</code> <code class="n">value</code> <code class="n">of</code> <code class="n">extensions</code>
  <code class="n">object</code>

<code class="n">Queue</code> <code class="p">=</code> <code class="o">-&gt;</code>
  <code class="n">extend</code><code class="p">(</code><code class="n">this</code><code class="p">,</code> <code class="p">{</code>
    <code class="n">array</code><code class="p">:</code> <code class="p">[]</code>
    <code class="n">head</code><code class="p">:</code> 0
    <code class="n">tail</code><code class="p">:</code> <code class="o">-</code>1
  <code class="p">})</code>
  
<code class="n">extend</code><code class="p">(</code><code class="n">Queue</code><code class="p">.</code><code class="n">prototype</code><code class="p">,</code>
  <code class="n">pushTail</code><code class="p">:</code> <code class="p">(</code><code class="n">value</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="n">this</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">this</code><code class="p">.</code><code class="n">tail</code> <code class="o">+</code><code class="p">=</code> 1<code class="p">]</code> <code class="p">=</code> <code class="n">value</code>
  <code class="n">pullHead</code><code class="p">:</code> <code class="o">-&gt;</code>
    <code class="n">unless</code> <code class="n">this</code><code class="p">.</code><code class="n">isEmpty</code><code class="p">()</code>
      <code class="n">do</code> <code class="p">(</code><code class="n">value</code> <code class="p">=</code> <code class="n">this</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">this</code><code class="p">.</code><code class="n">head</code><code class="p">])</code> <code class="p">=</code><code class="o">&gt;</code>
        <code class="n">this</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">this</code><code class="p">.</code><code class="n">head</code><code class="p">]</code> <code class="p">=</code> <code class="n">undefined</code>
        <code class="n">this</code><code class="p">.</code><code class="n">head</code> <code class="o">+</code><code class="p">=</code> 1
        <code class="n">value</code>
  <code class="n">isEmpty</code><code class="p">:</code> <code class="o">-&gt;</code>
    <code class="n">this</code><code class="p">.</code><code class="n">tail</code> <code class="o">&lt;</code> <code class="n">this</code><code class="p">.</code><code class="n">head</code>
<code class="p">)</code>
</pre></div>

</div>

<p>You recall that when we first looked at <code>this</code>, we only covered the case where a function that belongs to an object is invoked. Now we see another case: When a function is invoked by the <code>new</code> operator, <code>this</code> is set to the new object being created. Thus, our code for <code>Queue</code> initializes the queue.</p>

<p>You can see why <code>this</code> is so handy in CoffeeScript: We wouldn&rsquo;t be able to define functions in the prototype that worked on the instance if CoffeeScript didn&rsquo;t give us an easy way to refer to the instance itself.</p>

<h4 id="objects-everywhere">objects everywhere?</h4>

<p>Now that you know about prototypes, it&rsquo;s time to acknowledge something that even small children know: Everything in CoffeeScript behaves like an object, everything in CoffeeScript behaves like an instance of a function, and therefore everything in CoffeeScript behaves as if it inherits some methods from its constructor&rsquo;s prototype and/or has some elements of its own.</p>

<p>For example:</p>

<div class="code-block">
<div class="highlight"><pre>3<code class="p">.</code>14159265<code class="p">.</code><code class="n">toPrecision</code><code class="p">(</code>5<code class="p">)</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="s">&#39;3.1415&#39;</code>
  
<code class="s">&#39;FORTRAN, SNOBOL, LISP, BASIC&#39;</code><code class="p">.</code><code class="n">split</code><code class="p">(</code><code class="s">&#39;, &#39;</code><code class="p">)</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="p">[</code> <code class="s">&#39;FORTRAN&#39;</code><code class="p">,</code>
  #     <code class="s">&#39;SNOBOL&#39;</code><code class="p">,</code>
  #     <code class="s">&#39;LISP&#39;</code><code class="p">,</code>
  #     <code class="s">&#39;BASIC&#39;</code> <code class="p">]</code>
  
<code class="p">[</code> <code class="s">&#39;FORTRAN&#39;</code><code class="p">,</code>
  <code class="s">&#39;SNOBOL&#39;</code><code class="p">,</code>
  <code class="s">&#39;LISP&#39;</code><code class="p">,</code>
  <code class="s">&#39;BASIC&#39;</code> <code class="p">].</code><code class="nb">length</code>
#<code class="p">=</code><code class="o">&gt;</code> 5
</pre></div>

</div>

<p>Functions themselves are instances, and they have methods. For example, we know that CoffeeScript treats the fat arrow as if you were using the <code>this</code> and <code>that</code> idiom. But if you didn&rsquo;t have a fat arrow and you didn&rsquo;t want to take a chance on getting the idiom wrong, you could take advantage of the fact that every function has a method <code>call</code>.</p>

<p>Call&rsquo;s first argument is a <em>context</em>: When you invoke <code>.call</code> on a function, it invoked the function, setting <code>this</code> to the context. It passes the remainder of the arguments to the function.</p>

<p>So, if we have:</p>

<div class="code-block">
<div class="highlight"><pre>  <code class="n">pullHead</code><code class="p">:</code> <code class="o">-&gt;</code>
    <code class="n">unless</code> <code class="n">this</code><code class="p">.</code><code class="n">isEmpty</code><code class="p">()</code>
      <code class="n">do</code> <code class="p">(</code><code class="n">value</code> <code class="p">=</code> <code class="n">this</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">this</code><code class="p">.</code><code class="n">head</code><code class="p">])</code> <code class="p">=</code><code class="o">&gt;</code>
        <code class="n">this</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">this</code><code class="p">.</code><code class="n">head</code><code class="p">]</code> <code class="p">=</code> <code class="n">undefined</code>
        <code class="n">this</code><code class="p">.</code><code class="n">head</code> <code class="o">+</code><code class="p">=</code> 1
        <code class="n">value</code>
</pre></div>

</div>

<p>We could also write it like this:</p>

<div class="code-block">
<div class="highlight"><pre>  <code class="n">pullHead</code><code class="p">:</code> <code class="o">-&gt;</code>
    <code class="n">unless</code> <code class="n">this</code><code class="p">.</code><code class="n">isEmpty</code><code class="p">()</code>
      <code class="p">((</code><code class="n">value</code><code class="p">)</code> <code class="o">-&gt;</code>
        <code class="n">this</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">this</code><code class="p">.</code><code class="n">head</code><code class="p">]</code> <code class="p">=</code> <code class="n">undefined</code>
        <code class="n">this</code><code class="p">.</code><code class="n">head</code> <code class="o">+</code><code class="p">=</code> 1
        <code class="n">value</code>
      <code class="p">).</code><code class="n">call</code><code class="p">(</code><code class="n">this</code><code class="p">,</code> <code class="n">this</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">this</code><code class="p">.</code><code class="n">head</code><code class="p">])</code>
</pre></div>

</div>

<p>It seems like are objects everywhere in CoffeeScript!</p>

<div class="page-break" />
<h4 id="impostors">impostors</h4>

<p>You may have noticed that we use &ldquo;weasel words&rdquo; to describe how everything in CoffeeScript <em>behaves like</em> an instance. Everything <em>behaves as if</em> it was created by a function with a prototype.</p>

<p>The full explanation is this: As you know, CoffeeScript has &ldquo;value types&rdquo; like <code>String</code>, <code>Number</code>, and <code>Boolean</code>. As noted in the first chapter, value types are also called <em>primitives</em>, and one consequence of the way CoffeeScript implements primitives is that they aren&rsquo;t objects. Which means they can be identical to other values of the same type with the same contents, but the consequence of certain design decisions is that value types don&rsquo;t actually have methods or constructors. They aren&rsquo;t instances of some constructor.</p>

<p>So. Value types don&rsquo;t have methods or constructors. And yet:</p>

<div class="code-block">
<div class="highlight"><pre>&quot;<code class="n">Spence</code> <code class="n">Olham</code>&quot;<code class="p">.</code><code class="n">split</code><code class="p">(</code><code class="s">&#39; &#39;</code><code class="p">)</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="p">[</code>&quot;<code class="n">Spence</code>&quot;<code class="p">,</code> &quot;<code class="n">Olham</code>&quot;<code class="p">]</code>
</pre></div>

</div>

<p>Somehow, when we write <code>"Spence Olham".split(' ')</code>, the string <code>"Spence Olham"</code> isn&rsquo;t an instance, it doesn&rsquo;t have methods, but it does a damn fine job of impersonating an instance of a <code>String</code> constructor. How does <code>"Spence Olham"</code> impersonate an instance?</p>

<p>CoffeeScript pulls some legerdemain. When you do something that treats a value like an object, CoffeeScript checks to see whether the value actually is an object. If the value is actually a primitive,<sup id="fnref-reminder"><a href="#fn-reminder" rel="footnote">25</a></sup> CoffeeScript temporarily makes an object that is a kinda-sorta copy of the primitive and that kinda-sorta copy has methods and you are temporarily fooled into thinking that <code>"Spence Olham"</code> has a <code>.split</code> method.</p>

<p>These kinda-sorta copies are called String <em>instances</em> as opposed to String <em>primitives</em>. And the instances have methods, while the primitives do not. How does CoffeeScript make an instance out of a primitive? With <code>new</code>, of course. Let&rsquo;s try it:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">new</code> <code class="n">String</code><code class="p">(</code>&quot;<code class="n">Spence</code> <code class="n">Olham</code>&quot;<code class="p">)</code>
  #<code class="p">=</code><code class="o">&gt;</code> &quot;<code class="n">Spence</code> <code class="n">Olham</code>&quot;
</pre></div>

</div>

<p>The string instance looks just like our string primitive. But does it behave like a  string primitive? Not entirely:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">new</code> <code class="n">String</code><code class="p">(</code>&quot;<code class="n">Spence</code> <code class="n">Olham</code>&quot;<code class="p">)</code> <code class="n">is</code> &quot;<code class="n">Spence</code> <code class="n">Olham</code>&quot;
  #<code class="p">=</code><code class="o">&gt;</code> <code class="n">false</code>
</pre></div>

</div>

<p>Aha! It&rsquo;s an object with its own identity, unlike string primitives that behave as if they have a canonical representation. If we didn&rsquo;t care about their identity, that wouldn&rsquo;t be a problem. But if we carelessly used a string instance where we thought we had a string primitive, we could run into a subtle bug:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">if</code> <code class="n">userName</code> <code class="n">is</code> &quot;<code class="n">Spence</code> <code class="n">Olham</code>&quot;
  <code class="n">getMarried</code><code class="p">()</code>
  <code class="n">goCamping</code><code class="p">()</code>
</pre></div>

</div>

<p>That code is not going to work as we expect should we accidentally bind <code>new String("Spence Olham")</code> to <code>userName</code> instead of the primitive <code>"Spence Olham"</code>.</p>

<p>This basic issue that instances have unique identities but primitives withthe same contents have the same identities&ndash;is true of all primitive types, including numbers and booleans: If you create an instance of anything with <code>new</code>, it gets its own identity.</p>

<p>There are more pitfalls to beware. Consider the truthiness of string, number and boolean primitives:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">if</code> <code class="s">&#39;&#39;</code> <code class="n">then</code> <code class="s">&#39;truthy&#39;</code> <code class="k">else</code> <code class="s">&#39;falsy&#39;</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="s">&#39;falsy&#39;</code>
<code class="k">if</code> 0 <code class="n">then</code> <code class="s">&#39;truthy&#39;</code> <code class="k">else</code> <code class="s">&#39;falsy&#39;</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="s">&#39;falsy&#39;</code>
<code class="k">if</code> <code class="n">false</code> <code class="n">then</code> <code class="s">&#39;truthy&#39;</code> <code class="k">else</code> <code class="s">&#39;falsy&#39;</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="s">&#39;falsy&#39;</code>
</pre></div>

</div>

<p>Compare this to their corresponding instances:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">if</code> <code class="n">new</code> <code class="n">String</code><code class="p">(</code><code class="s">&#39;&#39;</code><code class="p">)</code> <code class="n">then</code> <code class="s">&#39;truthy&#39;</code> <code class="k">else</code> <code class="s">&#39;falsy&#39;</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="s">&#39;truthy&#39;</code>
<code class="k">if</code> <code class="n">new</code> <code class="n">Number</code><code class="p">(</code>0<code class="p">)</code> <code class="n">then</code> <code class="s">&#39;truthy&#39;</code> <code class="k">else</code> <code class="s">&#39;falsy&#39;</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="s">&#39;truthy&#39;</code>
<code class="k">if</code> <code class="n">new</code> <code class="n">Boolean</code><code class="p">(</code><code class="n">false</code><code class="p">)</code> <code class="n">then</code> <code class="s">&#39;truthy&#39;</code> <code class="k">else</code> <code class="s">&#39;falsy&#39;</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="s">&#39;truthy&#39;</code>
</pre></div>

</div>

<p>Our notion of &ldquo;truthiness&rdquo; and &ldquo;falsiness&rdquo; is that all instances are truthy, even string, number, and boolean instances corresponding to primitives that are falsy.</p>

<p>There is one sure cure for &ldquo;CoffeeScript Impostor Syndrome.&rdquo; Just as <code>new PrimitiveType(...)</code> creates an instance that is an impostor of a primitive, <code>PrimitiveType(...)</code> creates an original, canonicalized primitive from a primitive or an instance of a primitive object.</p>

<p>For example:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">String</code><code class="p">(</code><code class="n">new</code> <code class="n">String</code><code class="p">(</code>&quot;<code class="n">Spence</code> <code class="n">Olham</code>&quot;<code class="p">))</code> <code class="n">is</code> &quot;<code class="n">Spence</code> <code class="n">Olham</code>&quot;
  #<code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code>
</pre></div>

</div>

<p>Getting clever, we can write this:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">original</code> <code class="p">=</code> <code class="p">(</code><code class="n">unknown</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="n">unknown</code><code class="p">.</code><code class="n">constructor</code><code class="p">(</code><code class="n">unknown</code><code class="p">)</code>
    
<code class="n">original</code><code class="p">(</code><code class="n">true</code><code class="p">)</code> <code class="n">is</code> <code class="n">true</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code>
<code class="n">original</code><code class="p">(</code><code class="n">new</code> <code class="n">Boolean</code><code class="p">(</code><code class="n">true</code><code class="p">)</code> <code class="n">is</code> <code class="n">true</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code>
</pre></div>

</div>

<p>Of course, <code>original</code> will not work for your own creations unless you take great care to emulate the same behaviour. But it does work for strings, numbers, and booleans.</p>

<div class="page-break" />
<h3 id="a-touch-of-class">A Touch of Class</h3>

<p>CoffeeScript has &ldquo;classes,&rdquo; for some definition of &ldquo;class.&rdquo; You&rsquo;ve met them already, they&rsquo;re constructors that are designed to work with the <code>new</code> keyword and have behaviour in their <code>.prototype</code> element. You can create one any time you like by:</p>

<ol class="numeric">
  <li>Writing the constructor so that it performs any initialization on <code>this</code>, and:</li>
  <li>Putting all of the method definitions in its prototype.</li>
</ol>

<p>This is simple enough, but there are some advantages to making it even simpler, so CoffeeScript does. Here&rsquo;s our queue again:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">class</code> <code class="n">Queue</code>
  <code class="n">constructor</code><code class="p">:</code> <code class="o">-&gt;</code>
    <code class="n">extend</code><code class="p">(</code><code class="n">this</code><code class="p">,</code>
      <code class="n">array</code><code class="p">:</code> <code class="p">[]</code>
      <code class="n">head</code><code class="p">:</code> 0
      <code class="n">tail</code><code class="p">:</code> <code class="o">-</code>1
    <code class="p">)</code>
  <code class="n">pushTail</code><code class="p">:</code> <code class="p">(</code><code class="n">value</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="n">this</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">this</code><code class="p">.</code><code class="n">tail</code> <code class="o">+</code><code class="p">=</code> 1<code class="p">]</code> <code class="p">=</code> <code class="n">value</code>
  <code class="n">pullHead</code><code class="p">:</code> <code class="o">-&gt;</code>
    <code class="n">unless</code> <code class="n">this</code><code class="p">.</code><code class="n">isEmpty</code><code class="p">()</code>
      <code class="n">do</code> <code class="p">(</code><code class="n">value</code> <code class="p">=</code> <code class="n">this</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">this</code><code class="p">.</code><code class="n">head</code><code class="p">])</code> <code class="p">=</code><code class="o">&gt;</code>
        <code class="n">this</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">this</code><code class="p">.</code><code class="n">head</code><code class="p">]</code> <code class="p">=</code> <code class="n">undefined</code>
        <code class="n">this</code><code class="p">.</code><code class="n">head</code> <code class="o">+</code><code class="p">=</code> 1
        <code class="n">value</code>
  <code class="n">isEmpty</code><code class="p">:</code> <code class="o">-&gt;</code>
    <code class="n">this</code><code class="p">.</code><code class="n">tail</code> <code class="o">&lt;</code> <code class="n">this</code><code class="p">.</code><code class="n">head</code>
    
<code class="n">q</code> <code class="p">=</code> <code class="n">new</code> <code class="n">Queue</code><code class="p">()</code>
<code class="n">q</code><code class="p">.</code><code class="n">pushTail</code><code class="p">(</code><code class="s">&#39;hello&#39;</code><code class="p">)</code>
<code class="n">q</code><code class="p">.</code><code class="n">pushTail</code><code class="p">(</code><code class="s">&#39;CoffeeScript&#39;</code><code class="p">)</code>
</pre></div>

</div>

<p>Behind the scenes, CoffeeScript acts as if you&rsquo;d written things out by hand, with several small but relevant details.</p>

<h4 id="the-constructor-method">the constructor method</h4>

<p>As you&rsquo;ve probably noticed, CoffeeScript turns what may look like a <code>constructor</code> method into the body of the <code>Queue</code> function. You recall that every object in CoffeeScript has a <code>constructor</code> element initialized to the function that created it. So it&rsquo;s natural that in the class statement, you use <code>constructor</code> to define the body of the function.</p>

<h4 id="scope">scope</h4>

<p>CoffeeScript wraps the entire class statement in a <code>do -&gt;</code> so that you can work with some normal variables if you need them.</p>

<p>Here&rsquo;s a gratuitous example:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">class</code> <code class="n">Queue</code>
  <code class="n">empty</code> <code class="p">=</code> <code class="s">&#39;UNUSED&#39;</code>
  <code class="n">constructor</code><code class="p">:</code> <code class="o">-&gt;</code>
    <code class="n">extend</code><code class="p">(</code><code class="n">this</code><code class="p">,</code>
      <code class="n">array</code><code class="p">:</code> <code class="p">[]</code>
      <code class="n">head</code><code class="p">:</code> 0
      <code class="n">tail</code><code class="p">:</code> <code class="o">-</code>1
    <code class="p">)</code>
  <code class="n">pushTail</code><code class="p">:</code> <code class="p">(</code><code class="n">value</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="n">this</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">this</code><code class="p">.</code><code class="n">tail</code> <code class="o">+</code><code class="p">=</code> 1<code class="p">]</code> <code class="p">=</code> <code class="n">value</code>
  <code class="n">pullHead</code><code class="p">:</code> <code class="o">-&gt;</code>
    <code class="n">unless</code> <code class="n">this</code><code class="p">.</code><code class="n">isEmpty</code><code class="p">()</code>
      <code class="n">do</code> <code class="p">(</code><code class="n">value</code> <code class="p">=</code> <code class="n">this</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">this</code><code class="p">.</code><code class="n">head</code><code class="p">])</code> <code class="p">=</code><code class="o">&gt;</code>
        <code class="n">this</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">this</code><code class="p">.</code><code class="n">head</code><code class="p">]</code> <code class="p">=</code> <code class="n">empty</code>
        <code class="n">this</code><code class="p">.</code><code class="n">head</code> <code class="o">+</code><code class="p">=</code> 1
        <code class="n">value</code>
  <code class="n">isEmpty</code><code class="p">:</code> <code class="o">-&gt;</code>
    <code class="n">this</code><code class="p">.</code><code class="n">tail</code> <code class="o">&lt;</code> <code class="n">this</code><code class="p">.</code><code class="n">head</code>
</pre></div>

</div>

<p>The value <code>'UNUSED'</code> is bound to the name <code>empty</code> within the class &ldquo;statement&rdquo; but not outside it (unless you are aliasing an <code>empty</code> variable). CoffeeScript allows this kind of thing but will get hissy if you try to get fancy and write something like:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">class</code> <code class="n">Queue</code>
  <code class="n">do</code> <code class="p">(</code><code class="n">empty</code> <code class="p">=</code> <code class="s">&#39;UNUSED&#39;</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="n">constructor</code><code class="p">:</code> <code class="o">-&gt;</code>
      <code class="n">extend</code><code class="p">(</code><code class="n">this</code><code class="p">,</code>
        <code class="n">array</code><code class="p">:</code> <code class="p">[]</code>
        <code class="n">head</code><code class="p">:</code> 0
        <code class="n">tail</code><code class="p">:</code> <code class="o">-</code>1
      <code class="p">)</code>
    # <code class="p">...</code>
</pre></div>

</div>

<p>That won&rsquo;t work, you can&rsquo;t wrap a <code>do</code> around the instance methods of the class.</p>

<h4 id="at-at-walkers">at-at walkers</h4>

<p>CoffeeScript, in what may be an homage to Ruby, provides an abbreviation for <code>this.</code>, you can preface any label with an <code>@</code> as a shortcut. This small detail could easily be ignored, except for the fact that there&rsquo;s one place where it&rsquo;s mandatory. With that teaser in place, let&rsquo;s discuss a use case.</p>

<p>Let&rsquo;s modify our Queue to count how many queues have been created:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">class</code> <code class="n">Queue</code>
  <code class="n">constructor</code><code class="p">:</code> <code class="o">-&gt;</code>
    <code class="n">Queue</code><code class="p">.</code><code class="n">queues</code> <code class="o">+</code><code class="p">=</code> 1
    <code class="n">extend</code><code class="p">(</code><code class="n">this</code><code class="p">,</code>
      <code class="n">array</code><code class="p">:</code> <code class="p">[]</code>
      <code class="n">head</code><code class="p">:</code> 0
      <code class="n">tail</code><code class="p">:</code> <code class="o">-</code>1
    <code class="p">)</code>
  # <code class="p">...</code>

<code class="n">Queue</code><code class="p">.</code><code class="n">queues</code> <code class="p">=</code> 0
</pre></div>

</div>

<p>To make this work properly, CoffeeScript has to wrap our code in a <code>do</code> so that the code in the constructor <em>always</em> refers to the correct function, even if we subsequently change the binding for <code>Queue</code> in the outer environment. CoffeeScript does this.</p>

<p>Assigning values to elements of the function outside of the <code>class</code> statement is awkward, so CoffeeScript lets us put <code>Queue.queues = 0</code> inside, anywhere we&rsquo;d like. The top is fine. But interestingly, CoffeeScript also sets the context of the body of the <code>class</code> statement to be the class itself. So we can write:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">class</code> <code class="n">Queue</code>
  <code class="n">this</code><code class="p">.</code><code class="n">queues</code> <code class="p">=</code> 0
  <code class="n">constructor</code><code class="p">:</code> <code class="o">-&gt;</code>
    <code class="n">Queue</code><code class="p">.</code><code class="n">queues</code> <code class="o">+</code><code class="p">=</code> 1
    <code class="n">extend</code><code class="p">(</code><code class="n">this</code><code class="p">,</code>
      <code class="n">array</code><code class="p">:</code> <code class="p">[]</code>
      <code class="n">head</code><code class="p">:</code> 0
      <code class="n">tail</code><code class="p">:</code> <code class="o">-</code>1
    <code class="p">)</code>
  # <code class="p">...</code>
</pre></div>

</div>

<p>And back to our shortcut. We can also write:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">class</code> <code class="n">Queue</code>
  <code class="p">@</code><code class="n">queues</code> <code class="p">=</code> 0
  <code class="n">constructor</code><code class="p">:</code> <code class="o">-&gt;</code>
    <code class="n">Queue</code><code class="p">.</code><code class="n">queues</code> <code class="o">+</code><code class="p">=</code> 1
    <code class="n">extend</code><code class="p">(</code><code class="n">this</code><code class="p">,</code>
      <code class="n">array</code><code class="p">:</code> <code class="p">[]</code>
      <code class="n">head</code><code class="p">:</code> 0
      <code class="n">tail</code><code class="p">:</code> <code class="o">-</code>1
    <code class="p">)</code>
  <code class="n">pushTail</code><code class="p">:</code> <code class="p">(</code><code class="n">value</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="p">@</code><code class="n">array</code><code class="p">[@</code><code class="n">tail</code> <code class="o">+</code><code class="p">=</code> 1<code class="p">]</code> <code class="p">=</code> <code class="n">value</code>
  <code class="n">pullHead</code><code class="p">:</code> <code class="o">-&gt;</code>
    <code class="n">unless</code> <code class="p">@</code><code class="n">isEmpty</code><code class="p">()</code>
      <code class="n">do</code> <code class="p">(</code><code class="n">value</code> <code class="p">=</code> <code class="p">@</code><code class="n">array</code><code class="p">[@</code><code class="n">head</code><code class="p">])</code> <code class="p">=</code><code class="o">&gt;</code>
        <code class="p">@</code><code class="n">array</code><code class="p">[@</code><code class="n">head</code><code class="p">]</code> <code class="p">=</code> <code class="n">undefined</code>
        <code class="p">@</code><code class="n">head</code> <code class="o">+</code><code class="p">=</code> 1
        <code class="n">value</code>
  <code class="n">isEmpty</code><code class="p">:</code> <code class="o">-&gt;</code>
    <code class="p">@</code><code class="n">tail</code> <code class="o">&lt;</code> <code class="p">@</code><code class="n">head</code>
</pre></div>

</div>

<p>Everything up to now has been a matter of taste. But should you wish, you can write:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">class</code> <code class="n">Queue</code>
  <code class="p">@</code><code class="n">queues</code><code class="p">:</code> 0
  # <code class="p">...</code>
</pre></div>

</div>

<p>Putting the <code>@</code> prefix (and not <code>this.</code>) on a label as part of the structure inside the class statement indicates that the element belongs to the constructor (or &ldquo;class&rdquo;) and not the prototype. Obviously, if you put functions in the constructor, you get constructor methods and not instance methods. For example:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">class</code> <code class="n">Queue</code>
  <code class="p">@</code><code class="n">queues</code><code class="p">:</code> 0
  <code class="p">@</code><code class="n">resetQueues</code><code class="p">:</code> <code class="o">-&gt;</code>
    <code class="p">@</code><code class="n">queues</code> <code class="p">=</code> 0
  # <code class="p">...</code>
</pre></div>

</div>

<p>We&rsquo;ve added a constructor method to reset the count.</p>

<div class="image-with-caption">
  <p><img src="images/types.jpg" alt="It seems there is Strong Typing in Coffeeland" />
  <p>It seems there is Strong Typing in Coffeeland</p>
</div>

<div class="tip sidebarish">
  <hr />
  <p><img class="sidebar-image" alt="tip" src="images/leanpub_tip.png" /><strong>Classes</strong></p>

  <p>CoffeeScript&rsquo;s <code>class</code> statement is a nice syntactic convenience over manually wiring everything up, and it may help avoid errors. Since most CoffeeScript programmers will use &ldquo;classes,&rdquo; it&rsquo;s wise to use the class statement when the underlying semantics are what you want. That way your code will communicate its intent clearly and be a little more resistant to small errors.</p>

  <hr />
</div>

<div class="page-break" />
<h3 id="object-methods">Object Methods</h3>

<p>An <em>instance method</em> is a function defined in the constructor&rsquo;s prototype. Every instance acquires this behaviour unless otherwise &ldquo;overridden.&rdquo; Instance methods usually have some interaction with the instance, such as references to <code>this</code> or to other methods that interact with the instance. A <em>constructor method</em> is a function belonging to the constructor itself.</p>

<p>There is a third kind of method, one that any object (obviously including all instances) can have. An <em>object method</em> is a function defined in the object itself. Object methods usually have some interaction with the object, such as references to <code>this</code> or to other methods that interact with the object.</p>

<p>Object methods are really easy to create with Plain Old CoffeeScript Objects, because they&rsquo;re the only kind of method you can use. Recall from <a href="#this">This and That</a>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">QueueMaker</code> <code class="p">=</code> <code class="o">-&gt;</code>
  <code class="n">array</code><code class="p">:</code> <code class="p">[]</code>
  <code class="n">head</code><code class="p">:</code> 0
  <code class="n">tail</code><code class="p">:</code> <code class="o">-</code>1
  <code class="n">pushTail</code><code class="p">:</code> <code class="p">(</code><code class="n">value</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="n">this</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">this</code><code class="p">.</code><code class="n">tail</code> <code class="o">+</code><code class="p">=</code> 1<code class="p">]</code> <code class="p">=</code> <code class="n">value</code>
  <code class="n">pullHead</code><code class="p">:</code> <code class="o">-&gt;</code>
    <code class="n">unless</code> <code class="n">this</code><code class="p">.</code><code class="n">isEmpty</code><code class="p">()</code>
      <code class="n">do</code> <code class="p">(</code><code class="n">value</code> <code class="p">=</code> <code class="n">this</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">this</code><code class="p">.</code><code class="n">head</code><code class="p">])</code> <code class="p">=</code><code class="o">&gt;</code>
        <code class="n">this</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">this</code><code class="p">.</code><code class="n">head</code><code class="p">]</code> <code class="p">=</code> <code class="n">undefined</code>
        <code class="n">this</code><code class="p">.</code><code class="n">head</code> <code class="o">+</code><code class="p">=</code> 1
        <code class="n">value</code>
  <code class="n">isEmpty</code><code class="p">:</code> <code class="o">-&gt;</code>
    <code class="n">this</code><code class="p">.</code><code class="n">tail</code> <code class="o">&lt;</code> <code class="n">this</code><code class="p">.</code><code class="n">head</code>
</pre></div>

</div>

<p><code>pushTail</code>, <code>pullHead</code>, and <code>isEmpty</code> are object methods. Also, from <a href="#hiding-state">encapsulation</a>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">stack</code> <code class="p">=</code> <code class="n">do</code> <code class="p">(</code><code class="n">obj</code> <code class="p">=</code> <code class="n">undefined</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="n">obj</code> <code class="p">=</code>
    <code class="n">array</code><code class="p">:</code> <code class="p">[]</code>
    <code class="n">index</code><code class="p">:</code> <code class="o">-</code>1
    <code class="n">push</code><code class="p">:</code> <code class="p">(</code><code class="n">value</code><code class="p">)</code> <code class="o">-&gt;</code>
      <code class="n">obj</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">obj</code><code class="p">.</code><code class="n">index</code> <code class="o">+</code><code class="p">=</code> 1<code class="p">]</code> <code class="p">=</code> <code class="n">value</code>
    <code class="n">pop</code><code class="p">:</code> <code class="o">-&gt;</code>
      <code class="n">do</code> <code class="p">(</code><code class="n">value</code> <code class="p">=</code> <code class="n">obj</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">obj</code><code class="p">.</code><code class="n">index</code><code class="p">])</code> <code class="o">-&gt;</code>
        <code class="n">obj</code><code class="p">.</code><code class="n">array</code><code class="p">[</code><code class="n">obj</code><code class="p">.</code><code class="n">index</code><code class="p">]</code> <code class="p">=</code> <code class="n">undefined</code>
        <code class="n">obj</code><code class="p">.</code><code class="n">index</code> <code class="o">-</code><code class="p">=</code> 1 <code class="k">if</code> <code class="n">obj</code><code class="p">.</code><code class="n">index</code> <code class="o">&gt;</code><code class="p">=</code> 0
        <code class="n">value</code>
    <code class="n">isEmpty</code><code class="p">:</code> <code class="o">-&gt;</code>
</pre></div>

</div>

<p>Although they don&rsquo;t refer to the object, <code>push</code>, <code>pop</code>, and <code>isEmpty</code> semantically interact with the opaque data structure represented by the object, so they are object methods too.</p>

<h4 id="object-methods-within-instances">object methods within instances</h4>

<p>Instances of constructors can have object methods as well. Typically, object methods are added in the constructor. Here&rsquo;s a gratuitous example, a widget model that has a read-only <code>id</code>. We&rsquo;re using the class statement, but it could just as easily be rolled by hand:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">class</code> <code class="n">WidgetModel</code>
  <code class="n">constructor</code><code class="p">:</code> <code class="p">(</code><code class="n">id</code><code class="p">,</code> <code class="n">attrs</code> <code class="p">=</code> <code class="p">{})</code> <code class="o">-&gt;</code>
    <code class="n">this</code><code class="p">[</code><code class="n">key</code><code class="p">]</code> <code class="p">=</code> <code class="n">value</code> <code class="k">for</code> <code class="n">key</code><code class="p">,</code> <code class="n">value</code> <code class="n">of</code> <code class="n">own</code> <code class="n">attrs</code>
    <code class="p">@</code><code class="n">id</code> <code class="p">=</code> <code class="o">-&gt;</code>
      <code class="n">id</code>
    <code class="n">this</code>
  <code class="n">set</code><code class="p">:</code> <code class="p">(</code><code class="n">attrs</code><code class="p">)</code> <code class="o">-&gt;</code>
    # <code class="p">...</code>
  <code class="n">get</code><code class="p">:</code> <code class="p">(</code><code class="n">key</code><code class="p">)</code> <code class="o">-&gt;</code>
    # <code class="p">...</code>
  <code class="n">has</code><code class="p">:</code> <code class="p">(</code><code class="n">key</code><code class="p">)</code> <code class="o">-&gt;</code>
    # <code class="p">...</code>
</pre></div>

</div>

<p><code>set</code>, <code>get</code>, and <code>has</code> are instance methods, but <code>id</code> is an object method: Each object has its own <code>id</code> closure, where <code>id</code> is bound to the id of the widget by the argument <code>id</code> in the constructor. The advantage of this approach is that instances can have different object methods, or object methods with their own closures as in this case. The disadvantage is that every object has its own methods, which uses up much more memory than instance methods, which are shared amongst all instances.</p>

<div class="page-break" />
<h3 id="canonicalization">Canonicalization</h3>

<p>Early in this book, we discussed how objects, arrays, and functions are <em>reference types</em>. When we create a new object, even if it has the same contents as some other object, it is a different value, as we can tell when we test its identity with <code>is</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">{</code> <code class="n">foo</code><code class="p">:</code> <code class="s">&#39;bar&#39;</code> <code class="p">}</code> <code class="n">is</code> <code class="p">{</code> <code class="n">foo</code><code class="p">:</code> <code class="s">&#39;bar&#39;</code> <code class="p">}</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="n">false</code>
</pre></div>

</div>

<p>Sometimes, this is not what you want. A non-trivial example is the <a href="https://en.wikipedia.org/wiki/Hashlife">HashLife</a> algorithm for computing the future of Conway&rsquo;s Game of Life. HashLife aggressively caches both patterns on the board and their futures, so that instead of iteratively simulating the cellular automaton a generation at a time, it executes in logarithmic time.</p>

<p>In order to take advantage of cached results, HashLife must <em>canonicalize</em> square patterns. Meaning, it must guarantee that if two square patterns have the same contents, they must be the same object and share the same identity. This ensures that updates are shared everywhere.</p>

<p>One way to make this work is to eschew having all the code create new objects with a constructor. Instead, the construction of new objects is delegated to a cache. When a function needs a new object, it asks the cache for it. If a matching object already exists, it is returned. If not, a new one is created and placed in the cache.</p>

<p>This is the algorithm used by <a href="http://recursiveuniver.se">recursiveuniver.se</a>, an experimental implementation of HashLife in CoffeeScript. The fully annotated source code for canonicalization is <a href="http://recursiveuniver.se/docs/canonicalization.html">online</a>, and it contains this method for the <code>Square.cache</code> object:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">for</code><code class="p">:</code> <code class="p">(</code><code class="n">quadrants</code><code class="p">,</code> <code class="n">creator</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="n">found</code> <code class="p">=</code> <code class="n">Square</code><code class="p">.</code><code class="n">cache</code><code class="p">.</code><code class="nb">find</code><code class="p">(</code><code class="n">quadrants</code><code class="p">)</code>
  <code class="k">if</code> <code class="n">found</code>
    <code class="n">found</code>
  <code class="k">else</code>
    <code class="p">{</code><code class="n">nw</code><code class="p">,</code> <code class="n">ne</code><code class="p">,</code> <code class="n">se</code><code class="p">,</code> <code class="n">sw</code><code class="p">}</code> <code class="p">=</code> <code class="n">quadrants</code>
    <code class="n">Square</code><code class="p">.</code><code class="n">cache</code><code class="p">.</code><code class="n">add</code> <code class="n">_for</code><code class="p">(</code><code class="n">quadrants</code><code class="p">,</code> <code class="n">creator</code><code class="p">)</code>
</pre></div>

</div>

<p>Instead of enjoying a stimulating digression explaining how that works, let&rsquo;s make our own. We&rsquo;re going to build a class for cards in a traditional deck. Without canonicalization, it looks like this:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">class</code> <code class="n">Card</code>
  <code class="n">ranks</code> <code class="p">=</code> <code class="p">[</code>2<code class="p">..</code>10<code class="p">].</code><code class="n">concat</code> <code class="p">[</code><code class="s">&#39;J&#39;</code><code class="p">,</code> <code class="s">&#39;Q&#39;</code><code class="p">,</code> <code class="s">&#39;K&#39;</code><code class="p">,</code> <code class="s">&#39;A&#39;</code><code class="p">]</code>
  <code class="n">suits</code> <code class="p">=</code> <code class="p">[</code><code class="s">&#39;C&#39;</code><code class="p">,</code> <code class="s">&#39;D&#39;</code><code class="p">,</code> <code class="s">&#39;H&#39;</code><code class="p">,</code> <code class="s">&#39;S&#39;</code><code class="p">]</code>
  <code class="n">constructor</code><code class="p">:</code> <code class="p">({@</code><code class="n">rank</code><code class="p">,</code> <code class="p">@</code><code class="n">suit</code><code class="p">})</code> <code class="o">-&gt;</code>
    <code class="n">throw</code> &quot;#<code class="p">{@</code><code class="n">rank</code><code class="p">}</code> <code class="n">is</code> <code class="n">a</code> <code class="n">bad</code> <code class="n">rank</code>&quot; <code class="n">unless</code> <code class="p">@</code><code class="n">rank</code> <code class="n">in</code> <code class="n">ranks</code>
    <code class="n">throw</code> &quot;#<code class="p">{@</code><code class="n">suit</code><code class="p">}</code> <code class="n">is</code> <code class="n">a</code> <code class="n">bad</code> <code class="n">suit</code>&quot; <code class="n">unless</code> <code class="p">@</code><code class="n">suit</code> <code class="n">in</code> <code class="n">suits</code>
  <code class="n">toString</code><code class="p">:</code> <code class="o">-&gt;</code>
    <code class="s">&#39;&#39;</code> <code class="o">+</code> <code class="p">@</code><code class="n">rank</code> <code class="o">+</code> <code class="p">@</code><code class="n">suit</code>
</pre></div>

</div>

<p>The instances are not canonicalized:</p>

<div class="code-block">
<div class="highlight"><pre> <code class="n">new</code> <code class="n">Card</code><code class="p">({</code><code class="n">rank</code><code class="p">:</code> 4<code class="p">,</code> <code class="n">suit</code><code class="p">:</code> <code class="s">&#39;S&#39;</code><code class="p">})</code> <code class="n">is</code> <code class="n">new</code> <code class="n">Card</code><code class="p">({</code><code class="n">rank</code><code class="p">:</code> 4<code class="p">,</code> <code class="n">suit</code><code class="p">:</code> <code class="s">&#39;S&#39;</code><code class="p">})</code>
   #<code class="p">=</code><code class="o">&gt;</code> <code class="n">false</code>
</pre></div>

</div>

<div class="tip sidebarish">
  <hr />
  <p><img class="sidebar-image" alt="tip" src="images/leanpub_tip.png" />If a constructor function explicitly returns a value, that&rsquo;s what is returned. Otherwise, the newly constructed object is returned. Unlike other functions and methods, the last evaluated value is not returned by default.</p>

  <hr />
</div>

<p>We can take advantage of that to canonicalize cards:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">class</code> <code class="n">Card</code>
  <code class="n">ranks</code> <code class="p">=</code> <code class="p">[</code>2<code class="p">..</code>10<code class="p">].</code><code class="n">concat</code> <code class="p">[</code><code class="s">&#39;J&#39;</code><code class="p">,</code> <code class="s">&#39;Q&#39;</code><code class="p">,</code> <code class="s">&#39;K&#39;</code><code class="p">,</code> <code class="s">&#39;A&#39;</code><code class="p">]</code>
  <code class="n">suits</code> <code class="p">=</code> <code class="p">[</code><code class="s">&#39;C&#39;</code><code class="p">,</code> <code class="s">&#39;D&#39;</code><code class="p">,</code> <code class="s">&#39;H&#39;</code><code class="p">,</code> <code class="s">&#39;S&#39;</code><code class="p">]</code>
  <code class="n">cache</code> <code class="p">=</code> <code class="p">{}</code>
  <code class="n">constructor</code><code class="p">:</code> <code class="p">({@</code><code class="n">rank</code><code class="p">,</code> <code class="p">@</code><code class="n">suit</code><code class="p">})</code> <code class="o">-&gt;</code>
    <code class="n">throw</code> &quot;#<code class="p">{@</code><code class="n">rank</code><code class="p">}</code> <code class="n">is</code> <code class="n">a</code> <code class="n">bad</code> <code class="n">rank</code>&quot; <code class="n">unless</code> <code class="p">@</code><code class="n">rank</code> <code class="n">in</code> <code class="n">ranks</code>
    <code class="n">throw</code> &quot;#<code class="p">{@</code><code class="n">suit</code><code class="p">}</code> <code class="n">is</code> <code class="n">a</code> <code class="n">bad</code> <code class="n">suit</code>&quot; <code class="n">unless</code> <code class="p">@</code><code class="n">suit</code> <code class="n">in</code> <code class="n">suits</code>
    <code class="k">return</code> <code class="n">cache</code><code class="p">[@</code><code class="n">toString</code><code class="p">()]</code> <code class="n">or</code><code class="p">=</code> <code class="n">this</code>
  <code class="n">toString</code><code class="p">:</code> <code class="o">-&gt;</code>
    <code class="s">&#39;&#39;</code> <code class="o">+</code> <code class="p">@</code><code class="n">rank</code> <code class="o">+</code> <code class="p">@</code><code class="n">suit</code>
</pre></div>

</div>

<p>Now the instances are canonicalized:</p>

<div class="code-block">
<div class="highlight"><pre> <code class="n">new</code> <code class="n">Card</code><code class="p">({</code><code class="n">rank</code><code class="p">:</code> 4<code class="p">,</code> <code class="n">suit</code><code class="p">:</code> <code class="s">&#39;S&#39;</code><code class="p">})</code> <code class="n">is</code> <code class="n">new</code> <code class="n">Card</code><code class="p">({</code><code class="n">rank</code><code class="p">:</code> 4<code class="p">,</code> <code class="n">suit</code><code class="p">:</code> <code class="s">&#39;S&#39;</code><code class="p">})</code>
   #<code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code>
</pre></div>

</div>

<p>Wonderful!</p>

<h4 id="caveats">caveats</h4>

<p>Using techniques like this to canonicalize instances of a class has many drawbacks and takes careful consideration before use. First, while this code illustrates the possibilities inherent in having a constructor return a different object, it is wasteful in that it creates an object only to throw it away if it is already in the cache.</p>

<p>If there are a tractable number of possible instances of a class (such as cards in a deck), it may be more practical to enumerate them all in advance rather than lazily create them, and/or to use a factory method to retried them rather than changing the behaviour of the constructor.</p>

<p>More serious is that the engine that executes CoffeeScript programs does not support weak references.<sup id="fnref-wr"><a href="#fn-wr" rel="footnote">26</a></sup> As a result, if you wish to perform cache eviction for memory management purposes, you will have to implement your own reference management scheme. This may be non-trivial.</p>

<p>If you have many, many possible instances, your cache can end up holding onto what some programmers call <em>zombie objects</em>: Objects that are not in use anywhere in your program except the cache. If they are never accessed again, the memory they take up will never be released for reuse. An early version of the HashLife implementation did not clear objects from the cache. Some computations would consume as much as 700MB of data for the cache before the virtual machine was unable to continue. Most of that memory was consumed by zombie objects.</p>

<p>All that being said, canonicalization is sometimes the appropriate path forward, and even if it isn&rsquo;t, it serves to illustrate the possibilities latent in writing constructors that return objects explicitly.</p>

<div class="page-break" />
<h3 id="this-section-needs-no-title">This Section Needs No Title</h3>

<p>CoffeeScript is fundamentally an object-oriented language in the sense that Alan Kay first described object orientation. His vision was of software constructed from entities that communicate with message passing, with the system being extremely dynamic (what he described as &ldquo;extreme late-binding&rdquo;). However, words and phrases are only useful when both writer and reader share a common understanding, and for many people the words &ldquo;object-oriented&rdquo; carry with them a great deal of baggage related to constructing ontologies of domain entities.</p>

<p>The word &ldquo;Inheritance&rdquo; also means many different things to many different people. Some people take it extremely seriously, tugging thoughtfully on their long white beards as they ponder things like Strict Liskov Equivalence. We will avoid this term as well.</p>

<p>What we <em>will</em> discuss is extension. In <a href="#classextension">the next section</a>, we&rsquo;re going to show how functions that create instances can extend each other through their prototypes. Since we just finished looking at the class statement, we&rsquo;ll start by chaining two classes together, and then generalize extension so that you can use it with any two functions that create instances.</p>

<p>We&rsquo;ll finish by looking at the excellent support CoffeeScript provides so that you can accomplish all of this with a single keyword.</p>

<div class="page-break" />
<h3 id="classextension">Extending Classes</h3>

<p>You recall from <a href="#extensible">Composition and Extension</a> that we extended a Plain Old CoffeeScript Queue to create a Plain Old CoffeeScript Deque. But what if we have decided to use CoffeeScript&rsquo;s prototypes and class statements instead of Plain Old CoffeeScript Objects? How do we extend a queue into a deque?</p>

<p>Here&rsquo;s our <code>Queue</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">class</code> <code class="n">Queue</code>
  <code class="n">constructor</code><code class="p">:</code> <code class="o">-&gt;</code>
    <code class="p">@</code><code class="n">array</code> <code class="p">=</code> <code class="p">[]</code>
    <code class="p">@</code><code class="n">head</code>  <code class="p">=</code> 0
    <code class="p">@</code><code class="n">tail</code>  <code class="p">=</code> <code class="o">-</code>1
  <code class="n">pushTail</code><code class="p">:</code> <code class="p">(</code><code class="n">value</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="p">@</code><code class="n">array</code><code class="p">[@</code><code class="n">tail</code> <code class="o">+</code><code class="p">=</code> 1<code class="p">]</code> <code class="p">=</code> <code class="n">value</code>
  <code class="n">pullHead</code><code class="p">:</code> <code class="o">-&gt;</code>
    <code class="n">unless</code> <code class="p">@</code><code class="n">isEmpty</code><code class="p">()</code>
      <code class="n">do</code> <code class="p">(</code><code class="n">value</code> <code class="p">=</code> <code class="p">@</code><code class="n">array</code><code class="p">[@</code><code class="n">head</code><code class="p">])</code> <code class="p">=</code><code class="o">&gt;</code>
        <code class="p">@</code><code class="n">array</code><code class="p">[@</code><code class="n">head</code><code class="p">]</code> <code class="p">=</code> <code class="n">undefined</code>
        <code class="p">@</code><code class="n">head</code> <code class="o">+</code><code class="p">=</code> 1
        <code class="n">value</code>
  <code class="n">isEmpty</code><code class="p">:</code> <code class="o">-&gt;</code>
    <code class="p">@</code><code class="n">tail</code> <code class="o">&lt;</code> <code class="p">@</code><code class="n">head</code>
</pre></div>

</div>

<p>And our <code>Deque</code> before we wire things together:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">class</code> <code class="n">Deque</code>
  <code class="nb">size</code><code class="p">:</code> <code class="o">-&gt;</code>
    <code class="p">@</code><code class="n">tail</code> <code class="o">-</code> <code class="p">@</code><code class="n">head</code> <code class="o">+</code> 1
  <code class="n">pullTail</code><code class="p">:</code> <code class="o">-&gt;</code>
    <code class="n">unless</code> <code class="p">@</code><code class="n">isEmpty</code><code class="p">()</code>
      <code class="n">do</code> <code class="p">(</code><code class="n">value</code> <code class="p">=</code> <code class="p">@</code><code class="n">array</code><code class="p">[@</code><code class="n">tail</code><code class="p">])</code> <code class="p">=</code><code class="o">&gt;</code>
        <code class="p">@</code><code class="n">array</code><code class="p">[@</code><code class="n">tail</code><code class="p">]</code> <code class="p">=</code> <code class="n">undefined</code>
        <code class="p">@</code><code class="n">tail</code> <code class="o">-</code><code class="p">=</code> 1
        <code class="n">value</code>
  <code class="n">INCREMENT</code> <code class="p">=</code> 4
  <code class="n">pushHead</code><code class="p">:</code> <code class="p">(</code><code class="n">value</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="k">if</code> <code class="p">@</code><code class="n">head</code> <code class="n">is</code> 0
      <code class="k">for</code> <code class="nb">i</code> <code class="n">in</code> <code class="p">[@</code><code class="n">tail</code><code class="p">..@</code><code class="n">head</code><code class="p">]</code>
        <code class="p">@</code><code class="n">array</code><code class="p">[</code><code class="nb">i</code> <code class="o">+</code> <code class="n">INCREMENT</code><code class="p">]</code> <code class="p">=</code> <code class="p">@</code><code class="n">array</code><code class="p">[</code><code class="nb">i</code><code class="p">]</code>
      <code class="p">@</code><code class="n">tail</code> <code class="o">+</code><code class="p">=</code> <code class="n">INCREMENT</code>
      <code class="p">@</code><code class="n">head</code> <code class="o">+</code><code class="p">=</code> <code class="n">INCREMENT</code>
    <code class="p">@</code><code class="n">array</code><code class="p">[@</code><code class="n">head</code> <code class="o">-</code><code class="p">=</code> 1<code class="p">]</code> <code class="p">=</code> <code class="n">value</code>
</pre></div>

</div>

<p>So what do we want from dequeues?</p>

<ol class="numeric">
  <li>A <code>Deque</code> function that initializes a deque when invoked with <code>new</code></li>
  <li><code>Deque.prototype</code> must have all the behaviour of a deque and all the behaviour of a queue.</li>
</ol>

<p>Hmmm. So, should we copy everything from <code>Queue.prototype</code> into <code>Deque.prototype</code>? No, there&rsquo;s a better idea. Prototypes are objects, right? Why must they be Plain Old CoffeeScript Objects? Can&rsquo;t a prototype be an <em>instance</em>?</p>

<p>Yes they can. Imagine that <code>Deque.prototype</code> was a proxy for an instance of <code>Queue</code>. It would, of course, have all of a queue&rsquo;s behaviour through <code>Queue.prototype</code>. We don&rsquo;t want it to be an <em>actual</em> instance, mind you. It probably doesn&rsquo;t matter with a queue, but some of the things we might work with might make things awkward if we make random instances. A database connection comes to mind, we may not want to create one just for the convenience of having access to its behaviour.</p>

<p>Here&rsquo;s such a proxy:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">QueueProxy</code> <code class="p">=</code> <code class="o">-&gt;</code>

<code class="n">QueueProxy</code><code class="p">.</code><code class="n">prototype</code> <code class="p">=</code> <code class="n">Queue</code><code class="p">.</code><code class="n">prototype</code>
</pre></div>

</div>

<p>Our <code>QueueProxy</code> isn&rsquo;t actually a <code>Queue</code>, but its <code>prototype</code> is an alias of <code>Queue.prototype</code>. Thus, it can pick up <code>Queue</code>&rsquo;s behaviour. We want to use it for our <code>Deque</code>&rsquo;s prototype. Let&rsquo;s insert that code in our class:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">class</code> <code class="n">Deque</code>
  <code class="n">QueueProxy</code> <code class="p">=</code> <code class="o">-&gt;</code>
  <code class="n">QueueProxy</code><code class="p">.</code><code class="n">prototype</code> <code class="p">=</code> <code class="n">Queue</code><code class="p">.</code><code class="n">prototype</code>
  <code class="n">Deque</code><code class="p">.</code><code class="n">prototype</code> <code class="p">=</code> <code class="n">new</code> <code class="n">QueueProxy</code><code class="p">()</code>
  <code class="nb">size</code><code class="p">:</code> <code class="o">-&gt;</code>
    <code class="p">@</code><code class="n">tail</code> <code class="o">-</code> <code class="p">@</code><code class="n">head</code> <code class="o">+</code> 1
  # <code class="p">...</code>
</pre></div>

</div>

<p>Before we rush off to try this, we&rsquo;re missing something. How are we going to initialize our deques? We&rsquo;d better call <code>Queue</code>&rsquo;s constructor:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">constructor</code><code class="p">:</code> <code class="o">-&gt;</code>
  <code class="n">Queue</code><code class="p">.</code><code class="n">prototype</code><code class="p">.</code><code class="n">constructor</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">this</code><code class="p">)</code>
</pre></div>

</div>

<p>Here&rsquo;s what we have so far:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">class</code> <code class="n">Deque</code>
  <code class="n">QueueProxy</code> <code class="p">=</code> <code class="o">-&gt;</code>
  <code class="n">QueueProxy</code><code class="p">.</code><code class="n">prototype</code> <code class="p">=</code> <code class="n">Queue</code><code class="p">.</code><code class="n">prototype</code>
  <code class="p">@</code><code class="n">prototype</code> <code class="p">=</code> <code class="n">new</code> <code class="n">QueueProxy</code><code class="p">()</code>
  <code class="n">constructor</code><code class="p">:</code> <code class="o">-&gt;</code>
    <code class="n">Queue</code><code class="p">.</code><code class="n">prototype</code><code class="p">.</code><code class="n">constructor</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">this</code><code class="p">)</code>
  # <code class="p">...</code>
</pre></div>

</div>

<p>And it seems to work:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">d</code> <code class="p">=</code> <code class="n">new</code> <code class="n">Deque</code><code class="p">()</code>
<code class="n">d</code><code class="p">.</code><code class="n">pushTail</code><code class="p">(</code><code class="s">&#39;Hello&#39;</code><code class="p">)</code>
<code class="n">d</code><code class="p">.</code><code class="n">pushTail</code><code class="p">(</code><code class="s">&#39;CoffeeScript&#39;</code><code class="p">)</code>
<code class="n">d</code><code class="p">.</code><code class="n">pushTail</code><code class="p">(</code><code class="s">&#39;!&#39;</code><code class="p">)</code>
<code class="n">d</code><code class="p">.</code><code class="n">pullHead</code><code class="p">()</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="s">&#39;Hello&#39;</code>
<code class="n">d</code><code class="p">.</code><code class="n">pullTail</code><code class="p">()</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="s">&#39;!&#39;</code>
<code class="n">d</code><code class="p">.</code><code class="n">pullHead</code><code class="p">()</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="s">&#39;CoffeeScript&#39;</code>
</pre></div>

</div>

<p>Wonderful!</p>

<h4 id="getting-the-constructor-element-right">getting the constructor element right</h4>

<p>How about some of the other things we&rsquo;ve come to expect from instances?</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">d</code><code class="p">.</code><code class="n">constructor</code> <code class="n">is</code> <code class="n">Deque</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="n">false</code>
</pre></div>

</div>

<p>Oops! Messing around with Dequeue&rsquo;s prototype broke this important equivalence. Luckily for us, the <code>constructor</code> property is mutable for objects we create. So, let&rsquo;s make a small change to <code>QueueProxy</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">class</code> <code class="n">Deque</code>
  <code class="n">QueueProxy</code> <code class="p">=</code> <code class="o">-&gt;</code>
    <code class="p">@</code><code class="n">constructor</code> <code class="p">=</code> <code class="n">Deque</code>
    <code class="n">this</code>
  <code class="n">QueueProxy</code><code class="p">.</code><code class="n">prototype</code> <code class="p">=</code> <code class="n">Queue</code><code class="p">.</code><code class="n">prototype</code>
  <code class="p">@</code><code class="n">prototype</code> <code class="p">=</code> <code class="n">new</code> <code class="n">QueueProxy</code><code class="p">();</code>
  # <code class="p">...</code>
</pre></div>

</div>

<p>Now it works:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">d</code><code class="p">.</code><code class="n">constructor</code> <code class="n">is</code> <code class="n">Deque</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code>
</pre></div>

</div>

<p>The <code>QueueProxy</code> function now sets the <code>constructor</code> for every instance of a <code>QueueProxy</code> (hopefully just the one we need for the <code>Deque</code> class). It returns the object being created (it could also return <code>undefined</code> and work. But if it carelessly returned something else, that would be assigned to <code>Deque</code>&rsquo;s prototype, which would break our code).</p>

<h4 id="extracting-the-boilerplate">extracting the boilerplate</h4>

<p>Let&rsquo;s turn our extension modifications into a function:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">xtend</code> <code class="p">=</code> <code class="p">(</code><code class="n">child</code><code class="p">,</code> <code class="n">parent</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="n">do</code> <code class="p">(</code><code class="n">proxy</code> <code class="p">=</code> <code class="n">undefined</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="n">proxy</code> <code class="p">=</code> <code class="o">-&gt;</code>
      <code class="p">@</code><code class="n">constructor</code> <code class="p">=</code> <code class="n">child</code>
      <code class="n">this</code>
    <code class="n">proxy</code><code class="p">.</code><code class="n">prototype</code> <code class="p">=</code> <code class="n">parent</code><code class="p">.</code><code class="n">prototype</code>
    <code class="n">child</code><code class="p">.</code><code class="n">prototype</code> <code class="p">=</code> <code class="n">new</code> <code class="n">proxy</code><code class="p">()</code>
</pre></div>

</div>

<p>And use it in <code>Deque</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">class</code> <code class="n">Deque</code>
  <code class="n">xtend</code><code class="p">(</code><code class="n">Deque</code><code class="p">,</code> <code class="n">Queue</code><code class="p">)</code>
  <code class="n">constructor</code><code class="p">:</code> <code class="o">-&gt;</code>
    <code class="n">Queue</code><code class="p">.</code><code class="n">prototype</code><code class="p">.</code><code class="n">constructor</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">this</code><code class="p">)</code>
  <code class="nb">size</code><code class="p">:</code> <code class="o">-&gt;</code>
    <code class="p">@</code><code class="n">tail</code> <code class="o">-</code> <code class="p">@</code><code class="n">head</code> <code class="o">+</code> 1
  <code class="n">pullTail</code><code class="p">:</code> <code class="o">-&gt;</code>
    <code class="n">unless</code> <code class="p">@</code><code class="n">isEmpty</code><code class="p">()</code>
      <code class="n">do</code> <code class="p">(</code><code class="n">value</code> <code class="p">=</code> <code class="p">@</code><code class="n">array</code><code class="p">[@</code><code class="n">tail</code><code class="p">])</code> <code class="p">=</code><code class="o">&gt;</code>
        <code class="p">@</code><code class="n">array</code><code class="p">[@</code><code class="n">tail</code><code class="p">]</code> <code class="p">=</code> <code class="n">undefined</code>
        <code class="p">@</code><code class="n">tail</code> <code class="o">-</code><code class="p">=</code> 1
        <code class="n">value</code>
  <code class="n">INCREMENT</code> <code class="p">=</code> 4
  <code class="n">pushHead</code><code class="p">:</code> <code class="p">(</code><code class="n">value</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="k">if</code> <code class="p">@</code><code class="n">head</code> <code class="n">is</code> 0
      <code class="k">for</code> <code class="nb">i</code> <code class="n">in</code> <code class="p">[@</code><code class="n">tail</code><code class="p">..@</code><code class="n">head</code><code class="p">]</code>
        <code class="p">@</code><code class="n">array</code><code class="p">[</code><code class="nb">i</code> <code class="o">+</code> <code class="n">INCREMENT</code><code class="p">]</code> <code class="p">=</code> <code class="p">@</code><code class="n">array</code><code class="p">[</code><code class="nb">i</code><code class="p">]</code>
      <code class="p">@</code><code class="n">tail</code> <code class="o">+</code><code class="p">=</code> <code class="n">INCREMENT</code>
      <code class="p">@</code><code class="n">head</code> <code class="o">+</code><code class="p">=</code> <code class="n">INCREMENT</code>
    <code class="p">@</code><code class="n">array</code><code class="p">[@</code><code class="n">head</code> <code class="o">-</code><code class="p">=</code> 1<code class="p">]</code> <code class="p">=</code> <code class="n">value</code>
</pre></div>

</div>

<p>And you can use <code>xtend</code> even if you don&rsquo;t want to use the class statement:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">A</code> <code class="p">=</code> <code class="o">-&gt;</code>
<code class="n">B</code> <code class="p">=</code> <code class="o">-&gt;</code>
<code class="n">xtend</code><code class="p">(</code><code class="n">B</code><code class="p">,</code> <code class="n">A</code><code class="p">)</code>
</pre></div>

</div>

<p>It&rsquo;s such a nice idea. Wouldn&rsquo;t it be great if CoffeeScript had it built-in? Behold:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">B</code> <code class="n">extends</code> <code class="n">A</code>
</pre></div>

</div>

<p>Most helpful! In fact, CoffeeScript&rsquo;s keyword is superior to the <code>xtend</code> function: It provides support for extending functions that have other properties, not just the prototype.<sup id="fnref-xt"><a href="#fn-xt" rel="footnote">27</a></sup> </p>

<p>How about the class statement? CoffeeScript does a lot more work for you if you wish. You can write:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">class</code> <code class="n">Deque</code>
  <code class="n">Deque</code> <code class="n">extends</code> <code class="n">Queue</code>
  <code class="n">constructor</code><code class="p">:</code> <code class="o">-&gt;</code>
    <code class="n">Queue</code><code class="p">.</code><code class="n">prototype</code><code class="p">.</code><code class="n">constructor</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">this</code><code class="p">)</code>
  # <code class="p">...</code>
</pre></div>

</div>

<p>But there&rsquo;s more. If you instead write:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">class</code> <code class="n">Deque</code> <code class="n">extends</code> <code class="n">Queue</code>
  # <code class="p">...</code>
</pre></div>

</div>

<ol class="numeric">
  <li>CoffeeScript will do even more work for you. If you aren&rsquo;t doing any extra setup, you can leave the constructor out. CoffeeScript will handle calling the extended function&rsquo;s constructor for you.</li>
  <li>If you do wish to do some extra setup, write your own constructor. Like Ruby, you can call <code>super</code> in any method to access the extended version of the same method.</li>
  <li>CoffeeScript&rsquo;s <code>class</code> and <code>extends</code> keywords handle a lot of the boilerplate and play nicely together. Use them unless you have specific needs they don&rsquo;t cover.</li>
</ol>

<div class="page-break" />
<h3 id="summary-3">Summary</h3>

<div class="tip sidebarish">
  <hr />
  <h4 id="instances-and-classes"><img class="sidebar-image" alt="tip" src="images/leanpub_tip.png" />Instances and Classes</h4>

  <ul>
    <li>The <code>new</code> keyword turns any function into a <em>constructor</em> for creating <em>instances</em>.</li>
    <li>All functions have a <code>prototype</code> element.</li>
    <li>Instances behave as if the elements of their constructor&rsquo;s prototype are their elements.</li>
    <li>Instances can override their constructor&rsquo;s prototype without altering it.</li>
    <li>The relationship between instances and their constructor&rsquo;s prototype is dynamic.</li>
    <li><code>this</code> works seamlessly with methods defined in prototypes.</li>
    <li>Everything behaves like an object.</li>
    <li>CoffeeScript can convert primitives into instances and back into primitives.</li>
    <li>The <code>class</code> keyword and <code>constructor</code> method are syntactic sugar for creating functions and populating prototypes.</li>
    <li><code>@</code> is a convenient shorthand for <code>this.</code>.</li>
    <li>Object methods are typically created in the constructor and are private to each object.</li>
    <li>Canoncialization is tricky but possible in CoffeeScript.</li>
    <li>Prototypes can be chained to allow extension of instances.</li>
    <li>CoffeeScript&rsquo;s <code>extends</code> keyword is syntactic sugar for extending prototypes.</li>
    <li><code>extends</code> plays well with <code>class</code>.</li>
  </ul>

  <hr />
</div>

<div class="page-break" />
<h4 id="interlude-2">interlude&hellip;</h4>

<div class="image-with-caption">
  <p><img src="images/doppio.jpg" alt="Drawing a Doppio" />
  <p>Drawing a Doppio</p>
</div>

<p><a href="http://www.coffeegeek.com/opinions/aarondelazzer/02-24-2002" title="Coffeegeek Etiquette &amp; The Ristretto Shot">Aaron De Lazzer</a> on Ristretto:</p>

<blockquote>
  <p>&ldquo;The ristretto shot of espresso is one of the most fiercely debated and favourite topics amongst the coffee cognoscenti.  It is the purists pour.  The cutting edge of espresso extraction, flying in the face of the “Big Gulp” coffee drinker like nothing else around.  </p>
</blockquote>

<blockquote>
  <p>In anything at all, perfection is finally attained not when there is no longer anything to add, but when there is no longer anything to take away.&ndash;Antoine de Saint-Exupery</p>
</blockquote>

<blockquote>
  <p>&ldquo;Antoine would have drank ristretto shots.  </p>
</blockquote>

<blockquote>
  <p>&ldquo;There is no where to hide with a straight unadulterated shot of espresso.  Even more (less?) so with a ristretto shot.  Any weakness in the blend or in the preparation of the coffee will be brought to light here.  Either the heavens open up and the angels sing after that first sip or&hellip;.something significantly less.  Which is always such a disappointment knowing all the potential distilled into the dribble of coffee liquor that barely coats the bottom of your cup.&rdquo;</p>
</blockquote>

<h2 id="extra-shot">An Extra Shot of Ideas</h2>

<div class="image-with-caption">
  <p><img src="images/intestines.jpg" alt="The Intestines of an Espresso Machine" />
  <p>The Intestines of an Espresso Machine</p>
</div>

<div class="page-break" />
<h3 id="combinators">Refactoring to Combinators</h3>

<p>The word &ldquo;combinator&rdquo; has a precise technical meaning in mathematics:</p>

<blockquote>
  <p>&ldquo;A combinator is a higher-order function that uses only function application and earlier defined combinators to define a result from its arguments.&rdquo;&ndash;<a href="https://en.wikipedia.org/wiki/Combinatory_logic" title="Combinatory Logic">Wikipedia</a></p>
</blockquote>

<p>In this book, we will be using a much looser definition of &ldquo;combinator:&rdquo; Pure functions that act on other functions to produce functions. Combinators are the adverbs of functional programming.</p>

<h4 id="memoize">memoize</h4>

<p>Let&rsquo;s begin with an example of a combinator, <code>memoize</code>. Consider that age-old interview quiz, writing a recursive fibonacci function (there are other ways to derive a fibonacci number, of course). Here&rsquo;s simple implementation:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">fibonacci</code> <code class="p">=</code> <code class="p">(</code><code class="n">n</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="k">if</code> <code class="n">n</code> <code class="o">&lt;</code> 2
    <code class="n">n</code>
  <code class="k">else</code>
    <code class="n">fibonacci</code><code class="p">(</code><code class="n">n</code><code class="o">-</code>2<code class="p">)</code> <code class="o">+</code> <code class="n">fibonacci</code><code class="p">(</code><code class="n">n</code><code class="o">-</code>1<code class="p">)</code>
</pre></div>

</div>

<p>We&rsquo;ll time it:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">s</code> <code class="p">=</code> <code class="p">(</code><code class="n">new</code> <code class="n">Date</code><code class="p">()).</code><code class="n">getTime</code><code class="p">()</code>
<code class="n">new</code> <code class="n">Fibonacci</code><code class="p">(</code>45<code class="p">).</code><code class="n">toInt</code><code class="p">()</code>
<code class="p">(</code> <code class="p">(</code><code class="n">new</code> <code class="n">Date</code><code class="p">()).</code><code class="n">getTime</code><code class="p">()</code> <code class="o">-</code> <code class="n">s</code> <code class="p">)</code> <code class="o">/</code> 1000
  #<code class="p">=</code><code class="o">&gt;</code> 28<code class="p">.</code>565
</pre></div>

</div>

<p>Why is it so slow? Well, it has a nasty habit of recalculating the same results over and over and over again. We could rearrange the computation to avoid this, but let&rsquo;s be lazy and trade space for time. What we want to do is use a lookup table. Whenever we want a result, we look it up. If we don&rsquo;t have it, we calculate it and write the result in the table to use in the future. If we do have it, we return the result without recalculating it.</p>

<p>We could write something specific for fibonacci and then generalize it, but let&rsquo;s skip right to a general solution (we&rsquo;ll discuss extracting a combinator below). First, a new feature. Within any function the name <code>arguments</code> is always bound to an object that behaves like a collection of all the arguments passed to a function. Using <code>arguments</code>, here is a <code>memoize</code> implementation that works for many<sup id="fnref-json"><a href="#fn-json" rel="footnote">28</a></sup> kinds of functions:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">memoized</code> <code class="p">=</code> <code class="p">(</code><code class="n">fn</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="n">do</code> <code class="p">(</code><code class="n">lookupTable</code> <code class="p">=</code> <code class="p">{},</code> <code class="n">key</code> <code class="p">=</code> <code class="n">undefined</code><code class="p">,</code> <code class="n">value</code> <code class="p">=</code> <code class="n">undefined</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="o">-&gt;</code>
      <code class="n">key</code> <code class="p">=</code> <code class="n">JSON</code><code class="p">.</code><code class="n">stringify</code><code class="p">(</code><code class="n">arguments</code><code class="p">)</code>
      <code class="n">lookupTable</code><code class="p">[</code><code class="n">key</code><code class="p">]</code> <code class="n">or</code><code class="p">=</code> <code class="n">fn</code><code class="p">.</code><code class="n">apply</code><code class="p">(</code><code class="n">this</code><code class="p">,</code> <code class="n">arguments</code><code class="p">)</code>
</pre></div>

</div>

<p>We can apply <code>memoized</code> to a function and we will get back a new function that memoizes its results.</p>

<p>Let&rsquo;s try it:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">fastFibonacci</code> <code class="p">=</code>
  <code class="n">memoized</code> <code class="p">(</code><code class="n">n</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="k">if</code> <code class="n">n</code> <code class="o">&lt;</code> 2
      <code class="n">n</code>
    <code class="k">else</code>
      <code class="n">fastFibonacci</code><code class="p">(</code><code class="n">n</code><code class="o">-</code>2<code class="p">)</code> <code class="o">+</code> <code class="n">fastFibonacci</code><code class="p">(</code><code class="n">n</code><code class="o">-</code>1<code class="p">)</code>

<code class="n">fastFibonacci</code><code class="p">(</code>45<code class="p">)</code>
  #<code class="p">=</code><code class="o">&gt;</code> 1134903170
</pre></div>

</div>

<p>We get the result back instantly. It works!</p>

<div class="exercise sidebarish">
  <hr />
  <p><img class="sidebar-image" alt="exercise" src="images/leanpub_exercise.png" />Exercise:</p>

  <p>Optimistic Ophelia tries the following code:</p>

  <div class="code-block">
<div class="highlight"><pre><code class="nv">fibonacci = </code><code class="nf">(n) -&gt;</code>
  <code class="k">if</code> <code class="nx">n</code> <code class="o">&lt;</code> <code class="mi">2</code>
    <code class="nx">n</code>
  <code class="k">else</code>
    <code class="nx">fibonacci</code><code class="p">(</code><code class="nx">n</code><code class="o">-</code><code class="mi">2</code><code class="p">)</code> <code class="o">+</code> <code class="nx">fibonacci</code><code class="p">(</code><code class="nx">n</code><code class="o">-</code><code class="mi">1</code><code class="p">)</code>

<code class="nv">quickFibonacci = </code><code class="nx">memoize</code><code class="p">(</code><code class="nx">fibonacci</code><code class="p">)</code>
</pre></div>
  
</div>

  <p>Does <code>quickFibonacci</code> behave differently than <code>fastFibonacci</code>? Why?</p>

  <hr />
</div>

<p>By using a combinator instead of tangling lookup code with the actual &ldquo;domain logic&rdquo; of fibonacci, our <code>fastFibonacci</code> code is easy to read and understand. As a bonus, we DRY up our application, as the same <code>memoize</code> combinator can be used in many different places.</p>

<h4 id="the-once-and-future-combinator-refactoring">the once and future combinator refactoring</h4>

<p>Combinators can often be extracted from your code. The result is cleaner than the kinds of refactorings possible in languages that have less flexible functions. Let&rsquo;s walk through the process of discovering a combinator to get a feel for the refactoring to combinator process.</p>

<p>Some functions should only be evaluated once, but might be invoked more than once. You want to evaluate them the first time they are called, but thereafter ignore the invocation. </p>

<p>We&rsquo;d start with a function like this, it assumes there&rsquo;s some &ldquo;it&rdquo; that needs to be initialized once, and several pieces of code might call this function before using &ldquo;it:&rdquo;</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">ensureItIsInitialized</code> <code class="p">=</code> <code class="n">do</code> <code class="p">(</code><code class="n">itIsInitialized</code> <code class="p">=</code> <code class="n">false</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="o">-&gt;</code>
    <code class="n">unless</code> <code class="n">itIsInitialized</code>
      <code class="n">itIsInitialized</code> <code class="p">=</code> <code class="n">true</code>
      # <code class="p">...</code>
      # <code class="n">initialization</code> <code class="n">code</code>
      # <code class="p">...</code>
</pre></div>

</div>

<p>The typical meta-pattern is when several different functions all share a common precondition such as loading certain constant data from a server or initializing a resource. We can see that we&rsquo;re tangling the concern of initializing once with the concern of how to perform the initialization. Let&rsquo;s <a href="http://refactoring.com/catalog/extractMethod.html">extract a method</a>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">initializeIt</code> <code class="p">=</code> <code class="o">-&gt;</code>
  # <code class="p">...</code>
  # <code class="n">initialization</code> <code class="n">code</code>
  # <code class="p">...</code>
<code class="n">ensureItIsInitialized</code> <code class="p">=</code> <code class="n">do</code> <code class="p">(</code><code class="n">itIsInitialized</code> <code class="p">=</code> <code class="n">false</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="o">-&gt;</code>
    <code class="n">unless</code> <code class="n">itIsInitialized</code>
      <code class="n">itIsInitialized</code> <code class="p">=</code> <code class="n">true</code>
      <code class="n">initializeIt</code><code class="p">()</code>
</pre></div>

</div>

<p>In many other languages, we&rsquo;d stop right there. But in CoffeeScript, we can see that <code>ensureItIsInitialized</code> is much more generic than its name suggests. Let&rsquo;s convert it to a combinator with a slight variation on the <a href="http://www.industriallogic.com/xp/refactoring/extractParamter.html">extracting a parameter</a>. We&rsquo;ll call the combinator <code>once</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">once</code> <code class="p">=</code> <code class="p">(</code><code class="n">fn</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="n">do</code> <code class="p">(</code><code class="n">done</code> <code class="p">=</code> <code class="n">false</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="o">-&gt;</code>
      <code class="n">unless</code> <code class="n">done</code>
        <code class="n">done</code> <code class="p">=</code> <code class="n">true</code>
        <code class="n">fn</code><code class="p">.</code><code class="n">apply</code><code class="p">(</code><code class="n">this</code><code class="p">,</code> <code class="n">arguments</code><code class="p">)</code>
</pre></div>

</div>

<p>And now our code is very clean:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">initializeIt</code> <code class="p">=</code> <code class="o">-&gt;</code>
  # <code class="p">...</code>
  # <code class="n">initialization</code> <code class="n">code</code>
  # <code class="p">...</code>
<code class="n">ensureItIsInitialized</code> <code class="p">=</code> <code class="n">once</code><code class="p">(</code><code class="n">initializeIt</code><code class="p">)</code>
</pre></div>

</div>

<p>This is so clean you could get rid of <code>initializeIt</code> as a named function:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">ensureItIsInitialized</code> <code class="p">=</code> <code class="n">once</code> <code class="o">-&gt;</code>
  # <code class="p">...</code>
  # <code class="n">initialization</code> <code class="n">code</code>
  # <code class="p">...</code>
</pre></div>

</div>

<p>The concept of a combinator is more important than having a specific portfolio of combinators at your fingertips (although that is always nice). The meta-pattern is that when you are working with a function, identify the core &ldquo;domain logic&rdquo; the function should express. Try to extract that and turn what is left into one or more combinators that take functions as parameters rather than single-purpose methods.</p>

<p>(The <code>memoize</code> and <code>once</code> combinators are available in the <a href="http://underscorejs.org">underscore.js</a> library along with several other handy functions that operate on functions such as <code>throttle</code> and <code>debounce</code>.)</p>

<h4 id="composition-and-combinators">Composition and Combinators</h4>

<p>Although you can write nearly any function and use it as a combinator, one property that is nearly essential is <em>composability</em>. It should be possible to pass the result of one combinator as the argument to another.</p>

<p>Let&rsquo;s consider this combinator as an example:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">requiresValues</code> <code class="p">=</code> <code class="p">(</code><code class="n">fn</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="o">-&gt;</code>
    <code class="n">throw</code> &quot;<code class="n">Value</code> <code class="n">Required</code>&quot; <code class="n">unless</code> <code class="n">arg</code>? <code class="k">for</code> <code class="n">arg</code> <code class="n">in</code> <code class="n">arguments</code>
    <code class="n">fn</code><code class="p">.</code><code class="n">apply</code><code class="p">(</code><code class="n">this</code><code class="p">,</code> <code class="n">arguments</code><code class="p">)</code>
</pre></div>

</div>

<p>And this one:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">requiresReturnValue</code> <code class="p">=</code> <code class="p">(</code><code class="n">fn</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="o">-&gt;</code>
    <code class="n">do</code> <code class="p">(</code><code class="n">result</code> <code class="p">=</code> <code class="n">fn</code><code class="p">.</code><code class="n">apply</code><code class="p">(</code><code class="n">this</code><code class="p">,</code> <code class="n">arguments</code><code class="p">))</code> <code class="o">-&gt;</code>
      <code class="n">throw</code> &quot;<code class="n">Value</code> <code class="n">Required</code>&quot; <code class="n">unless</code> <code class="n">result</code>?
      <code class="n">result</code>
</pre></div>

</div>

<p>You can use <em>both</em> of these combinators and the <code>once</code> combinator on a function to add some runtime validation that both input arguments and the returned value are defined:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">checkedFibonacci</code> <code class="p">=</code> <code class="n">once</code> <code class="n">requiresValues</code> <code class="n">requiresReturnValue</code> <code class="p">(</code><code class="n">n</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="k">if</code> <code class="n">n</code> <code class="o">&lt;</code> 2
    <code class="n">n</code>
  <code class="k">else</code>
    <code class="n">fibonacci</code><code class="p">(</code><code class="n">n</code><code class="o">-</code>2<code class="p">)</code> <code class="o">+</code> <code class="n">fibonacci</code><code class="p">(</code><code class="n">n</code><code class="o">-</code>1<code class="p">)</code>
</pre></div>

</div>

<p>Combinators should be designed by default to compose. And speaking of composition, it&rsquo;s easy to compose functions in CoffeeScript:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">checkBoth</code> <code class="p">=</code> <code class="p">(</code><code class="n">fn</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="n">requiresValues</code> <code class="n">requiresReturnValue</code> <code class="n">fn</code>
</pre></div>

</div>

<p>Libraries like <a href="http://osteele.com/sources/javascript/functional/">Functional</a> also provide <code>compose</code> and <code>sequence</code> functions, so you can write things like:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">checkBoth</code> <code class="p">=</code> <code class="n">Functional</code><code class="p">.</code><code class="n">compose</code><code class="p">(</code><code class="n">requiresValues</code><code class="p">,</code> <code class="n">requiresReturnValue</code><code class="p">)</code>
</pre></div>

</div>

<p>All of this is made possible by the simple property of <em>composability</em>, the property of combinators taking a function as an argument and returning a function that operates on the same arguments and returns something meaningful to code expecting to call the original function.</p>

<div class="page-break" />
<h3 id="method-decorators">Method Decorators</h3>

<p>Now that we&rsquo;ve seen how function combinators can make our code cleaner and DRYer, it isn&rsquo;t a great leap to ask if we can use combinators with methods. After all, methods are functions. That&rsquo;s one of the great strengths of CoffeeScript, since methods are &ldquo;just&rdquo; functions, we don&rsquo;t need to have one kind of tool for functions and another for methods, or a messy way of turning methods into functions and functions into methods.</p>

<p>And the answer is, &ldquo;Yes we can.&rdquo; With some caveats. Let&rsquo;s get our terminology  synchronized. A combinator is a function that modifies another function. A <em>method decorator</em> is a combinator that modifies a method expression used inline. So, all method decorators are combinators, but not all combinators are method decorators.<sup id="fnref-py"><a href="#fn-py" rel="footnote">29</a></sup></p>

<h4 id="decorating-object-methods">decorating object methods</h4>

<p>As you recall, an <a href="#object-methods">object method</a> is a method belonging directly to a Plain Old CoffeeScript object or an instance. All combinators work as decorators for object methods. For example:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">class</code> <code class="n">LazyInitializedMechanism</code>
  <code class="n">constructor</code><code class="p">:</code> <code class="o">-&gt;</code>
    <code class="p">@</code><code class="n">initialize</code> <code class="p">=</code> <code class="n">once</code> <code class="o">-&gt;</code>
      # <code class="p">...</code>
      # <code class="n">complicated</code> <code class="n">stuff</code>
      # <code class="p">...</code>
  <code class="n">someInstanceMethod</code><code class="p">:</code> <code class="o">-&gt;</code>
    <code class="p">@</code><code class="n">initialize</code><code class="p">()</code>
    # <code class="p">...</code>
  <code class="n">anotherInstanceMethod</code><code class="p">:</code> <code class="p">(</code><code class="n">foo</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="p">@</code><code class="n">initialize</code><code class="p">()</code>
    # <code class="p">...</code>
</pre></div>

</div>

<h4 id="decorating-constructor-methods">decorating constructor methods</h4>

<p>Decorating constructor methods works just as well as decorating instance methods, for example:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">class</code> <code class="n">LazyClazz</code>
  <code class="p">@</code><code class="n">setUpLazyClazz</code><code class="p">:</code> <code class="n">once</code> <code class="o">-&gt;</code>
    # <code class="p">...</code>
    # <code class="n">complicated</code> <code class="n">stuff</code>
    # <code class="p">...</code>
  <code class="n">constructor</code><code class="p">:</code> <code class="o">-&gt;</code>
    <code class="n">this</code><code class="p">.</code><code class="n">constructor</code><code class="p">.</code><code class="n">setUpLazyClazz</code><code class="p">()</code>
    # <code class="p">...</code>
</pre></div>

</div>

<p>For this class, there&rsquo;s some setup to be done, but it&rsquo;s deferred until the first instance is created.</p>

<h4 id="decorating-instance-methods">decorating instance methods</h4>

<p>Decorating instance methods can be tricky if they rely on closures to encapsulate state of any kind. For example, this will not work:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">class</code> <code class="n">BrokenMechanism</code>
  <code class="n">initialize</code><code class="p">:</code> <code class="n">once</code> <code class="o">-&gt;</code>
    # <code class="p">...</code>
    # <code class="n">complicated</code> <code class="n">stuff</code>
    # <code class="p">...</code>
  <code class="n">someInstanceMethod</code><code class="p">:</code> <code class="o">-&gt;</code>
    <code class="p">@</code><code class="n">initialize</code><code class="p">()</code>
    # <code class="p">...</code>
  <code class="n">anotherInstanceMethod</code><code class="p">:</code> <code class="p">(</code><code class="n">foo</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="p">@</code><code class="n">initialize</code><code class="p">()</code>
    # <code class="p">...</code>
</pre></div>

</div>

<p>If you have more than one <code>BrokenMechanism</code>, only one will ever be initialized. There is one <code>initialize</code> method, and it belongs to <code>BrokenMechanism.prototype</code>, so once it is called for the first <code>BrokenMechanism</code> instance, all others calling it for the same or different instances will not execute.</p>

<p>The <code>initialize</code> method could be converted from an instance method to an object method as above. An alternate approach is to surrender the perfect encapsulation of <code>once</code>, and write a decorator designed for use on instance methods:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">once</code> <code class="p">=</code> <code class="p">(</code><code class="n">name</code><code class="p">,</code> <code class="n">method</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="o">-&gt;</code>
    <code class="n">unless</code> <code class="p">@[</code><code class="n">name</code><code class="p">]</code>
      <code class="p">@[</code><code class="n">name</code><code class="p">]</code> <code class="p">=</code> <code class="n">true</code>
      <code class="n">method</code><code class="p">.</code><code class="n">apply</code><code class="p">(</code><code class="n">this</code><code class="p">,</code> <code class="n">arguments</code><code class="p">)</code>
</pre></div>

</div>

<p>Now the flag for being done has been changed to an element of the instance, and we use it like this:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">class</code> <code class="n">WorkingMechanism</code>
  <code class="n">initialize</code><code class="p">:</code> <code class="n">once</code> <code class="s">&#39;doneInitializing&#39;</code><code class="p">,</code> <code class="o">-&gt;</code>
    # <code class="p">...</code>
    # <code class="n">complicated</code> <code class="n">stuff</code>
    # <code class="p">...</code>
  <code class="n">someInstanceMethod</code><code class="p">:</code> <code class="o">-&gt;</code>
    <code class="p">@</code><code class="n">initialize</code><code class="p">()</code>
    # <code class="p">...</code>
  <code class="n">anotherInstanceMethod</code><code class="p">:</code> <code class="p">(</code><code class="n">foo</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="p">@</code><code class="n">initialize</code><code class="p">()</code>
    # <code class="p">...</code>
</pre></div>

</div>

<p>Since the flag is stored in the instance, the one function works with all instances. (You do need to make sure that each method using the decorator has its own unique name.)</p>

<h4 id="a-decorator-for-fluent-interfaces">a decorator for fluent interfaces</h4>

<p><a href="https://en.wikipedia.org/wiki/Fluent_interface">Fluent interfaces</a> are a style of API often used for configuration. The principle is to return an instance that has meaningful methods for the next thing you want to do. The simplest (but not only) type of fluent interface is a cascade of methods configuring the same object, such as:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">car</code> <code class="p">=</code> <code class="n">new</code> <code class="n">Automobile</code><code class="p">()</code>
  <code class="p">.</code><code class="n">withBucketSeats</code><code class="p">(</code>2<code class="p">)</code>
  <code class="p">.</code><code class="n">withStandardTransmission</code><code class="p">(</code>5<code class="p">)</code>
  <code class="p">.</code><code class="n">withDoors</code><code class="p">(</code>4<code class="p">)</code>
</pre></div>

</div>

<p>To implement an interface with this simple API, methods need to return <code>this</code>. It&rsquo;s one line and easy to do, but you look at the top of the method to see its name and the bottom of the method to see what it returns. If there are multiple return paths, you must take care that they all return <code>this</code>.</p>

<p>It&rsquo;s easy to write a fluent decorator:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">fluent</code> <code class="p">=</code> <code class="p">(</code><code class="n">method</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="o">-&gt;</code>
    <code class="n">method</code><code class="p">.</code><code class="n">apply</code><code class="p">(</code><code class="n">this</code><code class="p">,</code> <code class="n">arguments</code><code class="p">)</code>
    <code class="n">this</code>
</pre></div>

</div>

<p>And it&rsquo;s easy to use:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">class</code> <code class="n">Automobile</code>
    <code class="n">withBucketSeats</code><code class="p">:</code> <code class="n">fluent</code> <code class="p">(</code><code class="n">num</code><code class="p">)</code> <code class="o">-&gt;</code>
      # <code class="p">...</code>
    <code class="n">withStandardTransmission</code><code class="p">:</code> <code class="n">fluent</code> <code class="p">(</code><code class="n">gears</code><code class="p">)</code> <code class="o">-&gt;</code>
      # <code class="p">...</code>
    <code class="n">withDoors</code><code class="p">:</code> <code class="n">fluent</code> <code class="p">(</code><code class="n">num</code><code class="p">)</code> <code class="o">-&gt;</code>
      # <code class="p">...</code>
</pre></div>

</div>

<h4 id="combinators-for-making-decorators">combinators for making decorators</h4>

<p>Quite a few of the examples involve initializing something before doing some work. This is a very common pattern: Do something <em>before</em> invoking a method. Can we extract that into a combinator? Certainly. Here&rsquo;s a combinator that takes a method and returns a decorator:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">before</code> <code class="p">=</code>
  <code class="p">(</code><code class="n">decoration</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="p">(</code><code class="n">base</code><code class="p">)</code> <code class="o">-&gt;</code>
      <code class="o">-&gt;</code>
        <code class="n">decoration</code><code class="p">.</code><code class="n">apply</code><code class="p">(</code><code class="n">this</code><code class="p">,</code> <code class="n">arguments</code><code class="p">)</code>
        <code class="n">base</code><code class="p">.</code><code class="n">apply</code><code class="p">(</code><code class="n">this</code><code class="p">,</code> <code class="n">arguments</code><code class="p">)</code>
</pre></div>

</div>

<p>You would use it like this:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">forcesInitialize</code> <code class="p">=</code> <code class="n">before</code> <code class="o">-&gt;</code> <code class="p">@</code><code class="n">initialize</code><code class="p">()</code>

<code class="n">class</code> <code class="n">WorkingMechanism</code>
  <code class="n">initialize</code><code class="p">:</code> <code class="n">once</code> <code class="s">&#39;doneInitializing&#39;</code><code class="p">,</code> <code class="o">-&gt;</code>
    # <code class="p">...</code>
    # <code class="n">complicated</code> <code class="n">stuff</code>
    # <code class="p">...</code>
  <code class="n">someInstanceMethod</code><code class="p">:</code> <code class="n">forcesInitialize</code> <code class="o">-&gt;</code>
    # <code class="p">...</code>
  <code class="n">anotherInstanceMethod</code><code class="p">:</code> <code class="n">forcesInitialize</code> <code class="p">(</code><code class="n">foo</code><code class="p">)</code> <code class="o">-&gt;</code>
    # <code class="p">...</code>
</pre></div>

</div>

<p>Of course, you could put anything in there, including the initialization code if you wanted to:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">class</code> <code class="n">WorkingMechanism</code>
  <code class="n">forcesInitialize</code> <code class="p">=</code> <code class="n">before</code> <code class="o">-&gt;</code>
    # <code class="p">...</code>
    # <code class="n">complicated</code> <code class="n">stuff</code>
    # <code class="p">...</code>
  <code class="n">someInstanceMethod</code><code class="p">:</code> <code class="n">forcesInitialize</code> <code class="o">-&gt;</code>
    # <code class="p">...</code>
  <code class="n">anotherInstanceMethod</code><code class="p">:</code> <code class="n">forcesInitialize</code> <code class="p">(</code><code class="n">foo</code><code class="p">)</code> <code class="o">-&gt;</code>
    # <code class="p">...</code>
</pre></div>

</div>

<p>When writing decorators, the same few patterns tend to crop up regularly:</p>

<ol class="numeric">
  <li>You want to do something <em>before</em> the method&rsquo;s base logic is executed.</li>
  <li>You want to do something <em>after</em> the method&rsquo;s base logic is executed.</li>
  <li>You want to wrap some logic <em>around</em> the method&rsquo;s base logic.</li>
  <li>You only want to execute the method&rsquo;s base logic <em>provided</em> some condition is truthy.</li>
</ol>

<p>We saw <code>before</code> above. Here are three more combinators that are very useful for writing method decorators:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">after</code> <code class="p">=</code>
  <code class="p">(</code><code class="n">decoration</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="p">(</code><code class="n">base</code><code class="p">)</code> <code class="o">-&gt;</code>
      <code class="o">-&gt;</code>
        <code class="n">decoration</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">this</code><code class="p">,</code> <code class="n">__value__</code> <code class="p">=</code> <code class="n">base</code><code class="p">.</code><code class="n">apply</code><code class="p">(</code><code class="n">this</code><code class="p">,</code> <code class="n">arguments</code><code class="p">))</code>
        <code class="n">__value__</code>

<code class="n">around</code> <code class="p">=</code>
  <code class="p">(</code><code class="n">decoration</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="p">(</code><code class="n">base</code><code class="p">)</code> <code class="o">-&gt;</code>
      <code class="p">(</code><code class="n">argv</code><code class="p">...)</code> <code class="o">-&gt;</code>
        <code class="n">__value__</code> <code class="p">=</code> <code class="n">undefined</code>
        <code class="n">callback</code> <code class="p">=</code> <code class="p">=</code><code class="o">&gt;</code>
          <code class="n">__value__</code> <code class="p">=</code> <code class="n">base</code><code class="p">.</code><code class="n">apply</code><code class="p">(</code><code class="n">this</code><code class="p">,</code> <code class="n">argv</code><code class="p">)</code>
        <code class="n">decoration</code><code class="p">.</code><code class="n">apply</code><code class="p">(</code><code class="n">this</code><code class="p">,</code> <code class="p">[</code><code class="n">callback</code><code class="p">].</code><code class="n">concat</code><code class="p">(</code><code class="n">argv</code><code class="p">))</code>
        <code class="n">__value__</code>

<code class="n">provided</code> <code class="p">=</code>
  <code class="p">(</code><code class="n">condition</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="p">(</code><code class="n">base</code><code class="p">)</code> <code class="o">-&gt;</code>
      <code class="o">-&gt;</code>
        <code class="k">if</code> <code class="n">condition</code><code class="p">.</code><code class="n">apply</code><code class="p">(</code><code class="n">this</code><code class="p">,</code> <code class="n">arguments</code><code class="p">)</code>
          <code class="n">base</code><code class="p">.</code><code class="n">apply</code><code class="p">(</code><code class="n">this</code><code class="p">,</code> <code class="n">arguments</code><code class="p">)</code>
</pre></div>

</div>

<p>All four of these, and many more can be found in the <a href="https://github.com/raganwald/method-combinators">method combinators</a> module. They can be used with all CoffeeScript and JavaScript projects.</p>

<div class="page-break" />
<h3 id="callbacks-and-promises">Callbacks and Promises</h3>

<p>Like nearly all languages in widespread use, CoffeeScript expresses programs as expressions that are composed together with a combination of operators, function application, and control flow constructs such as sequences of statements.</p>

<p>That&rsquo;s all baked into the underlying language, so it&rsquo;s easy to use it without thinking about it. Much as a fish (perhaps) exists in the ocean without being aware that there is an ocean. In this chapter, we&rsquo;re going to examine how to compose functions together when we have non-traditional forms of control-flow such as asynchronous function invocation.</p>

<h4 id="composition-1">composition</h4>

<p>The very simplest example of composing functions is simply &ldquo;pipelining&rdquo; the values. CoffeeScript&rsquo;s optional parentheses make this quite readable. Given:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">getIdFromSession</code> <code class="p">=</code> <code class="p">(</code><code class="n">session</code><code class="p">)</code> <code class="o">-&gt;</code>
  # <code class="p">...</code>

<code class="n">fetchCustomerById</code> <code class="p">=</code> <code class="p">(</code><code class="n">id</code><code class="p">)</code> <code class="o">-&gt;</code>
  # <code class="p">...</code>
  
<code class="n">currentSession</code> <code class="p">=</code> # <code class="p">...</code>
</pre></div>

</div>

<p>You can write either:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">customerList</code><code class="p">.</code><code class="n">add</code><code class="p">(</code>
  <code class="n">fetchCustomerById</code><code class="p">(</code>
    <code class="n">getIdFromSession</code><code class="p">(</code>
      <code class="n">currentSession</code>
     <code class="p">)</code>
  <code class="p">)</code>
<code class="p">)</code>
</pre></div>

</div>

<p>Or:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">customerList</code><code class="p">.</code><code class="n">add</code> <code class="n">fetchCustomerById</code> <code class="n">getIdFromSession</code> <code class="n">currentSession</code>
</pre></div>

</div>

<p>The &ldquo;flow&rdquo; of data is from right-to-left. Some people find it more readable to go from left-to-right. The <code>sequence</code> function accomplishes this:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">sequence</code> <code class="p">=</code> <code class="o">-&gt;</code>
  <code class="n">do</code> <code class="p">(</code><code class="n">fns</code> <code class="p">=</code> <code class="n">arguments</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="p">(</code><code class="n">value</code><code class="p">)</code> <code class="o">-&gt;</code>
      <code class="p">(</code><code class="n">value</code> <code class="p">=</code> <code class="n">fn</code><code class="p">(</code><code class="n">value</code><code class="p">))</code> <code class="k">for</code> <code class="n">fn</code> <code class="n">in</code> <code class="n">fns</code>
      <code class="n">value</code>
   
<code class="n">sequence</code><code class="p">(</code>
  <code class="n">fetchCustomerById</code><code class="p">,</code>
  <code class="n">getIdFromSession</code><code class="p">,</code>
  <code class="n">customerList</code><code class="p">.</code><code class="n">add</code>
<code class="p">)(</code><code class="n">currentSession</code><code class="p">)</code>
</pre></div>

</div>

<h4 id="asynchronous-code">asynchronous code</h4>

<p>CoffeeScript executes within an environment where code can be invoked asynchronously. For example, a browser application can asynchronously invoke a request to a remote server and invoke handler code when the request is satisfied or deemed to have failed.</p>

<p>A very simple example is that in a browser application, you can defer invocation of a function after all current processing has been completed:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">defer</code> <code class="p">(</code><code class="n">fn</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="n">window</code><code class="p">.</code><code class="n">setTimeout</code><code class="p">(</code><code class="n">fn</code><code class="p">,</code> 0<code class="p">)</code>
</pre></div>

</div>

<p>The result is that if you write:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">defer</code> <code class="o">-&gt;</code> <code class="n">console</code><code class="p">.</code><code class="nb">log</code><code class="p">(</code><code class="s">&#39;Hello&#39;</code><code class="p">)</code>
<code class="n">console</code><code class="p">.</code><code class="nb">log</code><code class="p">(</code><code class="s">&#39;Asynchronicity&#39;</code><code class="p">)</code>
</pre></div>

</div>

<p>The console will show:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">Asynchronicity</code>
<code class="n">Hello</code>
</pre></div>

</div>

<p>The computer has no idea whether the result should be &ldquo;Asynchronicity Hello&rdquo; or &ldquo;Hello Asynchronicity&rdquo; or sometimes one and sometimes the other. But if we intend that the result be &ldquo;Asynchronicity Hello,&rdquo; we say that the function <code>-&gt; console.log('Hello')</code> <em>depends upon</em> the code <code>console.log('Asynchronicity')</code>.</p>

<p>This might be what you want. If it isn&rsquo;t, you need to have a way to force the order of evaluation when there is supposed to be a dependency between different evaluations. There are a number of different models and abstractions for controlling these dependencies.</p>

<p>We will examine two of them (<a href="#callbacks-3">callbacks</a> and <a href="#promises-3">promises</a>) briefly. Not for the purpose of learning the subtleties of using either model, but rather to obtain an understanding of how functions can be used to implement an abstraction over an underlying model.</p>

<h4 id="callbacks-3">callbacks</h4>

<p>The underlying premise of the callback model is that every function that invoked code asynchronously is responsible for invoking code that depends on it. The simplest protocol for this is also the most popular: Functions that invoke asynchronous code take an extra parameter called a <em>callback</em>. That parameter is a function to be invoked when they have completed.</p>

<p>So our <code>defer</code> function looks like this if we want to use callbacks:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">defer</code> <code class="p">(</code><code class="n">fn</code><code class="p">,</code> <code class="n">callback</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="n">window</code><code class="p">.</code><code class="n">setTimeout</code> <code class="p">(</code><code class="o">-&gt;</code> <code class="n">callback</code> <code class="n">fn</code><code class="p">),</code> 0
</pre></div>

</div>

<p>Instead of handing <code>fn</code> directly to <code>window.setTimeout</code>, we&rsquo;re handing it a function that invokes <code>fn</code> and pipelines the result (if any) to <code>callback</code>. Now we can ensure that the output is in the correct order:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">defer</code> <code class="p">(</code><code class="o">-&gt;</code> <code class="n">console</code><code class="p">.</code><code class="nb">log</code> <code class="s">&#39;hello&#39;</code><code class="p">),</code> <code class="p">(</code><code class="o">-&gt;</code> <code class="n">console</code><code class="p">.</code><code class="nb">log</code> <code class="s">&#39;Asynchronicity&#39;</code><code class="p">)</code>

#<code class="p">=</code><code class="o">&gt;</code> <code class="n">Hello</code>
#   <code class="n">Asynchronicity</code>
</pre></div>

</div>

<p>Likewise, let&rsquo;s say we have a <code>displayPhoto</code> function that is synchronous, and not callback-aware:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">displayPhoto</code> <code class="p">=</code> <code class="p">(</code><code class="n">photoData</code><code class="p">)</code> <code class="o">-&gt;</code>
  # <code class="p">...</code> <code class="n">synchronous</code> <code class="k">function</code> <code class="p">...</code>
</pre></div>

</div>

<p>It can also be converted to take a callback:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">displayPhotoWithCallback</code> <code class="p">=</code> <code class="p">(</code><code class="n">photoData</code><code class="p">,</code> <code class="n">callback</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="n">callback</code><code class="p">(</code><code class="n">displayPhoto</code><code class="p">(</code><code class="n">photoData</code><code class="p">))</code>
</pre></div>

</div>

<p>There&rsquo;s a combinator we can extract:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">callbackize</code> <code class="p">=</code> <code class="p">(</code><code class="n">fn</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="p">(</code><code class="n">arg</code><code class="p">,</code> <code class="n">callback</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="n">callback</code><code class="p">(</code><code class="n">fn</code><code class="p">(</code><code class="n">arg</code><code class="p">))</code>
</pre></div>

</div>

<p>You recall that with ordinary functions, you could chain them with function application. With callbacks, you can also chain them manually. Here&rsquo;s an example inspired by <a href="http://elm-lang.org/learn/Escape-from-Callback-Hell.elm">a blog post</a>, fetching photos from a remote photo sharing site using their asynchronous API:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">tag</code> <code class="p">=</code> <code class="s">&#39;ristretto&#39;</code>

<code class="n">fotositeGetPhotosByTag</code> <code class="n">tag</code><code class="p">,</code> <code class="p">(</code><code class="n">photoList</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="n">fotositeGetOneFromList</code> <code class="n">photos</code><code class="p">,</code> <code class="p">(</code><code class="n">photoId</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="n">fotositeGetPhoto</code> <code class="n">photoId</code><code class="p">,</code> <code class="n">displayPhoto</code>
</pre></div>

</div>

<p>We can also create a callback-aware function that represents the composition of functions:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">displayPhotoForTag</code> <code class="p">=</code> <code class="p">(</code><code class="n">tag</code><code class="p">,</code> <code class="n">callback</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="n">fotositeGetPhotosByTag</code> <code class="n">tag</code><code class="p">,</code> <code class="p">(</code><code class="n">photoList</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="n">fotositeGetOneFromList</code> <code class="n">photos</code><code class="p">,</code> <code class="p">(</code><code class="n">photoId</code><code class="p">)</code> <code class="o">-&gt;</code>
      <code class="n">fotositeGetPhoto</code> <code class="n">photoId</code><code class="p">,</code> <code class="n">displayPhoto</code>
</pre></div>

</div>

<p>This code is <em>considerably</em> less messy in CoffeeScript than other languages that require a lot of additional syntax for functions. As a bonus, although it has some extra scaffolding and indentation, it&rsquo;s already in sequence order from top to bottom and doesn&rsquo;t require re-ordering like normal function application did. That being said, you can avoid the indentation and extra syntax by writing a <code>sequenceWithCallbacks</code> function:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">I</code> <code class="p">=</code> <code class="p">(</code><code class="n">x</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">x</code>

<code class="n">sequenceWithCallbacks</code> <code class="p">=</code> <code class="o">-&gt;</code>
  <code class="n">do</code> <code class="p">(</code><code class="n">fns</code> <code class="p">=</code> <code class="n">arguments</code><code class="p">,</code> 
      <code class="n">lastIndex</code> <code class="p">=</code> <code class="n">arguments</code><code class="p">.</code><code class="nb">length</code> <code class="o">-</code> 1<code class="p">,</code> 
      <code class="n">helper</code> <code class="p">=</code> <code class="n">undefined</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="n">helper</code> <code class="p">=</code> <code class="p">(</code><code class="n">arg</code><code class="p">,</code> <code class="n">index</code><code class="p">,</code> <code class="n">callback</code> <code class="p">=</code> <code class="n">I</code><code class="p">)</code> <code class="o">-&gt;</code>
      <code class="k">if</code> <code class="n">index</code> <code class="o">&gt;</code> <code class="n">lastIndex</code>
        <code class="n">callback</code> <code class="n">arg</code>
      <code class="k">else</code>
        <code class="n">fns</code><code class="p">[</code><code class="n">index</code><code class="p">]</code> <code class="n">arg</code><code class="p">,</code> <code class="p">(</code><code class="n">result</code><code class="p">)</code> <code class="o">-&gt;</code>
          <code class="n">helper</code> <code class="n">result</code><code class="p">,</code> <code class="n">index</code> <code class="o">+</code> 1<code class="p">,</code> <code class="n">callback</code>
   <code class="p">(</code><code class="n">arg</code><code class="p">,</code> <code class="n">callback</code><code class="p">)</code> <code class="o">-&gt;</code>
     <code class="n">helper</code> <code class="n">arg</code><code class="p">,</code> 0<code class="p">,</code> <code class="n">callback</code>
     
 <code class="n">displayPhotoForTag</code> <code class="p">=</code> <code class="n">sequenceWithCallbacks</code><code class="p">(</code>
   <code class="n">fotositeGetPhotosByTag</code><code class="p">,</code>
   <code class="n">fotositeGetOneFromList</code><code class="p">,</code>
   <code class="n">fotositeGetPhoto</code><code class="p">,</code>
   <code class="n">displayPhotoWithCallback</code>       
 <code class="p">)</code>
</pre></div>

</div>

<p><code>sequenceWithCallbacks</code> is more complex than <code>sequence</code>, but it does help us make callback-aware code &ldquo;linear&rdquo; instead of nested/indented.</p>

<p>As we have seen, we can compose linear execution of asynchronous functions, using either the explicit invocation of callbacks or using <code>sequenceWithCallbacks</code> to express the execution as a list.</p>

<h4 id="promises-3">solving this problem with promises</h4>

<p>Asynchronous control flow can also be expressed using objects and methods. One model is called <a href="http://wiki.commonjs.org/wiki/Promises/A">promises</a>. A <em>promise</em> is an object that acts as a state machine.<sup id="fnref-fsm"><a href="#fn-fsm" rel="footnote">30</a></sup> Its permissible states are:</p>

<ul>
  <li>unfulfilled</li>
  <li>fulfilled</li>
  <li>failed</li>
</ul>

<p>The only permissible transitions are from <em>unfulfilled</em> to <em>fulfilled</em> and from <em>unfulfilled</em> to <em>failed</em>. Once in either the fulfilled or failed states, it remains there permanently.</p>

<p>Each promise must at a bare minimum implement a single method, <code>.then(fulfilledCallback, failedCallback)</code>.<sup id="fnref-interactive"><a href="#fn-interactive" rel="footnote">31</a></sup> <code>fulfilledCallback</code> is a function to be invoked by a fulfilled promise, <code>failedCallback</code> by a failed promise. If the promise is already in either state, that function is invoked immediately.</p>

<p><code>.then</code> returns another promise that is fulfilled when the appropriate callback is fulfilled or fails when the appropriate callback fails. This allows chaining of <code>.then</code> calls.</p>

<p>If the promise is unfulfilled, the function(s) provided by the <code>.then</code> call are queued up to be invoked if and when the promise transitions to the appropriate state. In addition to this being an object-based protocol, the promise model also differs from the callback model in that <code>.then</code> can be invoked on a promise at any time, whereas callbacks must be specified in advance.</p>

<p>Here&rsquo;s how our fotosite API would be used if it implemented promises instead of callbacks (we&rsquo;ll ignore handling failures):</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">fotositeGetPhotosByTag</code><code class="p">(</code><code class="n">tag</code><code class="p">)</code>
  <code class="p">.</code><code class="n">then</code> <code class="n">fotositeGetOneFromList</code>
  <code class="p">.</code><code class="n">then</code> <code class="n">fotositeGetPhoto</code>
  <code class="p">.</code><code class="n">then</code> <code class="n">displayPhoto</code>
</pre></div>

</div>

<p>Crisp and clean, no caffeine. The promises model provides linear code &ldquo;out of the box,&rdquo; and it &ldquo;scales up&rdquo; to serve as a complete platform for managing asynchronous code and remote invocation. Be sure to look at libraries supporting promises like <a href="https://github.com/kriskowal/q">q</a>, and <a href="https://github.com/cujojs/when">when</a>.</p>

<div class="page-break" />
<h3 id="summary-4">Summary</h3>

<div class="tip sidebarish">
  <hr />
  <h4 id="an-extra-shot-of-ideas"><img class="sidebar-image" alt="tip" src="images/leanpub_tip.png" />An Extra Shot of Ideas</h4>

  <ul>
    <li>Combinators are pure functions that act on other functions to produce functions.</li>
    <li>Combinators are the adverbs of functional programming.</li>
    <li>Combinators can often be extracted from your code.</li>
    <li>Combinators make code more composeable.</li>
    <li>Many combinators are also Method Decorators.</li>
    <li>Some combinators decorate decorators.</li>
    <li>Callbacks abstract control flow.</li>
    <li>Callbacks hide asynchronicity.</li>
    <li>Promises represent control flow with an object API.</li>
  </ul>

  <hr />
</div>

<h4 id="the-last-word">the last word&hellip;</h4>

<div class="image-with-caption">
  <p><img src="images/brown-cups-1900.jpg" alt="Espresso a lungo, or the long pull, is thinner in texture, more acidic, and contains more caffeine than a ristretto pull" />
  <p>Espresso a lungo, or the long pull, is thinner in texture, more acidic, and contains more caffeine than a ristretto pull</p>
</div>

<!-- begin backmatter -->
<h2 id="a-golden-crema">A Golden Crema</h2>

<div class="image-with-caption">
  <p><img src="images/la_marzocco.jpg" alt="You've earned a break!" />
  <p>You've earned a break!</p>
</div>

<div class="page-break" />
<h3 id="online">How to run the examples</h3>

<p>If you follow the instructions at <a href="http://coffeescript.org/#installation" title="Install CoffeeScript">coffeescript.org</a> to install NodeJS and CoffeeScript,<sup id="fnref-whoa"><a href="#fn-whoa" rel="footnote">32</a></sup> you can run an interactive CoffeeScript <a href="https://en.wikipedia.org/wiki/REPL" title="Read–eval–print loop">REPL</a> on your command line simply by typing <code>coffee</code>. This is how the examples in this book were tested, and what many programmers will do. When running CoffeeScript on the command line, ctrl-V switches between single-line and multi-line input mode. If you need to enter more than one line of code, be sure to enter multi-line mode.</p>

<p>Some websites function as online <a href="https://en.wikipedia.org/wiki/REPL" title="Read–eval–print loop">REPLs</a>, allowing you to type CoffeeScript programs right within a web page and see the results (as well as a translation from CoffeeScript to JavaScript). The examples in this book have all been tested on <a href="http://coffeescript.org/#try:">coffeescript.org</a>. You simply type a CoffeeScript expression into the blank window and you will see its JavaScript translation live. Clicking &ldquo;Run&rdquo; evaluates the expression in the browser.</p>

<p>To actually see the result of your expressions, you&rsquo;ll need to either include a call to <code>console.log</code> (and be using a browser that supports console logging) or you could go old-school and use <code>alert</code>, e.g. <code>alert 2+2</code> will cause the alert box to be displayed with the message <code>4</code>.</p>

<div class="page-break" />
<h3 id="thanks">Thanks!</h3>

<h4 id="daniel-friedman-and-matthias-felleisen">Daniel Friedman and Matthias Felleisen</h4>

<div class="image-with-caption">
  <p><img src="images/little-schemer.jpg" alt="The Little Schemer" />
  <p>The Little Schemer</p>
</div>

<p><em>CoffeeScript Ristretto</em> was inspired by <a href="http://www.amzn.com/0262560992?tag=raganwald001-20">The Little Schemer</a> by Daniel Friedman and Matthias Felleisen. But where <em>The Little Schemer&rsquo;s</em> primary focus is recursion, <em>CoffeeScript Ristretto&rsquo;s</em> primary focus is <strong>functions as first-class values</strong>.</p>

<div class="page-break" />
<h4 id="richard-feynman">Richard Feynman</h4>

<div class="image-with-caption">
  <p><img src="images/qed.jpg" alt="QED: The Strange Theory of Light and Matter" />
  <p>QED: The Strange Theory of Light and Matter</p>
</div>

<p>Richard Feynman&rsquo;s <a href="http://www.amzn.com/0691125759?tag=raganwald001-20">QED</a> was another inspiration: A book that explains Quantum Electrodynamics and the &ldquo;Sum of the Histories&rdquo; methodology using the simple expedient of explaining how light reflects off a mirror, and showing how most of the things we think are happening&ndash;such as light travelling on a straight line,  the angle of reflection equalling the angle of refraction, or that a beam of light only interacts with a small portion of the mirror, or that it reflects off a plane&ndash;are all wrong. And everything is explained in simple, concise terms that build upon each other logically.</p>

<div class="page-break" />
<h4 id="trevor-burnham">Trevor Burnham</h4>

<div class="image-with-caption">
  <p><img src="images/tbcoffee.jpg" alt="CoffeeScript: Accelerated JavaScript Development" />
  <p>CoffeeScript: Accelerated JavaScript Development</p>
</div>

<p>Trevor Burnham provided invaluable assistance with this book. Trevor is the author of <a href="http://pragprog.com/book/tbcoffee/coffeescript">CoffeeScript: Accelerated JavaScript Development</a>, an excellent resource for CoffeeScript programmers.</p>

<div class="page-break" />
<div class="page-break" />
<h3 id="javascript-allong">JavaScript Allongé</h3>

<div class="image-with-caption">
  <p><img src="images/javascript_allonge_medium.jpg" alt="a long and strong programming book" />
  <p>a long and strong programming book</p>
</div>

<p><a href="http://leanpub.com/javascript-allonge">JavaScript Allongé</a> is the companion book to <em>CoffeeScript Ristretto</em>.</p>

<div class="page-break" />
<h3 id="copyright-notice">Copyright Notice</h3>

<p>The original words in this sample preview of <a href="https://leanpub.com/coffeescript-ristretto">CoffeeScript Ristretto</a> are (c) 2012, Reginald Braithwaite. This sample preview work is licensed under an <a href="http://creativecommons.org/licenses/by-nc-nd/3.0/">Attribution-NonCommercial-NoDerivs 3.0 Unported</a> license.</p>

<div class="image-with-caption">
  <p><img src="images/cc.png" alt="Creative Commons Attribution-NonCommercial-NoDerivs 3.0 Unported License" />
  <p>Creative Commons Attribution-NonCommercial-NoDerivs 3.0 Unported License</p>
</div>

<h4 id="images">images</h4>

<ul>
  <li>The picture of the author is (c) 2008, <a href="http://www.flickr.com/photos/trumpetca/">Joseph Hurtado</a>, All Rights Reserved. </li>
  <li><a href="http://www.flickr.com/photos/digitalcolony/5054568279/">Double ristretto menu</a> (c) 2010, Michael Allen Smith. <a href="http://creativecommons.org/licenses/by-sa/2.0/deed.en">Some rights reserved</a>.</li>
  <li><a href="http://www.flickr.com/photos/everydaylifemodern/1353570874/">Short espresso shot in a white cup with blunt handle</a> (c) 2007, EVERYDAYLIFEMODERN. <a href="http://creativecommons.org/licenses/by-nd/2.0/deed.en">Some rights reserved</a>.</li>
  <li><a href="http://www.flickr.com/photos/everydaylifemodern/434299813/">Espresso shot in a caffe molinari cup</a> (c) 2007, EVERYDAYLIFEMODERN. <a href="http://creativecommons.org/licenses/by-nd/2.0/deed.en">Some rights reserved</a>.</li>
  <li><a href="http://www.flickr.com/photos/the_rev/2295096211/">Beans in a Bag</a> (c) 2008, Stirling Noyes. <a href="http://creativecommons.org/licenses/by/2.0/deed.en">Some Rights Reserved</a>.</li>
  <li><a href="http://www.flickr.com/photos/thedigitelmyr/6199419022/">Free Samples</a> (c) 2011, Myrtle Bech Digitel. <a href="http://creativecommons.org/licenses/by-sa/2.0/deed.en">Some Rights Reserved</a>.</li>
  <li><a href="http://www.flickr.com/photos/sagamiono/4391542823/">Free Coffees</a> image (c) 2010, Michael Francis McCarthy. <a href="http://creativecommons.org/licenses/by-sa/2.0/deed.en">Some Rights Reserved</a>.</li>
  <li><a href="http://www.flickr.com/photos/digitalcolony/3924227011/">La Marzocco</a> (c) 2009, Michael Allen Smith. <a href="http://creativecommons.org/licenses/by-sa/2.0/deed.en">Some rights reserved</a>.</li>
  <li><a href="http://www.flickr.com/photos/15481483@N06/6231443466/">Cafe Diplomatico</a> (c) 2011, Missi. <a href="http://creativecommons.org/licenses/by-sa/2.0/deed.en">Some rights reserved</a>.</li>
  <li><a href="http://www.flickr.com/photos/tjgfernandes/2785677276/">Sugar Service</a> (c) 2008 Tiago Fernandes. <a href="http://creativecommons.org/licenses/by/2.0/deed.en">Some rights reserved</a>.</li>
  <li><a href="http://www.flickr.com/photos/kirstenloza/4805716699/">Biscotti on a Rack</a> (c) 2010 Kirsten Loza. <a href="http://creativecommons.org/licenses/by/2.0/deed.en">Some rights reserved</a>.</li>
  <li><a href="http://www.flickr.com/photos/jenny-pics/5053954146/">Coffee Spoons</a> (c) 2010 Jenny Downing. <a href="http://creativecommons.org/licenses/by/2.0/deed.en">Some rights reserved</a>.</li>
  <li><a href="http://www.flickr.com/photos/33388953@N04/4017985434/">Drawing a Doppio</a> (c) 2008 Osman Bas. <a href="http://creativecommons.org/licenses/by/2.0/deed.en">Some rights reserved</a>.</li>
  <li><a href="http://www.flickr.com/photos/tangysd/5953453156/">Cupping Coffees</a> (c) 2011 Dennis Tang. <a href="http://creativecommons.org/licenses/by-sa/2.0/deed.en">Some rights reserved</a>.</li>
  <li><a href="http://www.flickr.com/photos/digitalcolony/4000837035/">Three Coffee Roasters</a> (c) 2009 Michael Allen Smith. <a href="http://creativecommons.org/licenses/by-sa/2.0/deed.en">Some rights reserved</a>.</li>
  <li><a href="http://www.flickr.com/photos/digitalcolony/4309812256/">Blue Diedrich Roaster</a> (c) 2010 Michael Allen Smith. <a href="http://creativecommons.org/licenses/by-sa/2.0/deed.en">Some rights reserved</a>.</li>
  <li><a href="http://www.flickr.com/photos/bike/3237859728/">Red Diedrich Roaster</a> (c) 2009 Richard Masoner. <a href="http://creativecommons.org/licenses/by-sa/2.0/deed.en">Some rights reserved</a>.</li>
  <li><a href="http://www.flickr.com/photos/lacerabbit/2102801319/">Roaster with Tree Leaves</a> (c) 2007 ting. <a href="http://creativecommons.org/licenses/by-nd/2.0/deed.en">Some rights reserved</a>.</li>
  <li><a href="http://www.flickr.com/photos/nalundgaard/4785922266/">Half Drunk</a> (c) 2010 Nicholas Lundgaard. <a href="http://creativecommons.org/licenses/by-sa/2.0/deed.en">Some rights reserved</a>.</li>
  <li><a href="http://www.flickr.com/photos/paulmccoubrie/6828131856/">Anticipation</a> (c) 2012 Paul McCoubrie. <a href="http://creativecommons.org/licenses/by-nd/2.0/deed.en">Some rights reserved</a>.</li>
  <li><a href="http://www.flickr.com/photos/mikecogh/7676649034/">Ooh!</a> (c) 2012 Michael Coghlan. <a href="http://creativecommons.org/licenses/by-sa/2.0/deed.en">Some rights reserved</a>.</li>
  <li><a href="http://www.flickr.com/photos/yellowskyphotography/5641003165/">Intestines of an Espresso Machine</a> (c) 2011 Angie Chung. <a href="http://creativecommons.org/licenses/by-sa/2.0/deed.en">Some rights reserved</a>.</li>
  <li><a href="http://www.flickr.com/photos/andynash/6204253236/">Bezzera Espresso Machine</a> (c) 2011 Andrew Nash. <a href="http://creativecommons.org/licenses/by-sa/2.0/deed.en">Some rights reserved</a>.
*<a href="http://www.flickr.com/photos/28705377@N04/5306009552/">Beans Ripening on a Branch</a> (c) 2008 John Pavelka. <a href="http://creativecommons.org/licenses/by/2.0/deed.en">Some rights reserved</a>.</li>
  <li><a href="http://www.flickr.com/photos/shavejonathan/2343081208/">Cafe Macchiato on Gazotta Della Sport</a> (c) 2008 Jon Shave. <a href="http://creativecommons.org/licenses/by/2.0/deed.en">Some rights reserved</a>.</li>
  <li><a href="http://www.flickr.com/photos/ilovememphis/7103931235/">Jars of Coffee Beans</a> (c) 2012 Memphis CVB. <a href="http://creativecommons.org/licenses/by-nd/2.0/deed.en">Some rights reserved</a>.</li>
  <li><a href="http://www.flickr.com/photos/mikecogh/7561440544/">Types of Coffee Drinks</a> (c) 2012 Michael Coghlan. <a href="http://creativecommons.org/licenses/by-sa/2.0/deed.en">Some rights reserved</a>.</li>
  <li><a href="http://www.flickr.com/photos/dtownsend/6171015997/">Coffee Trees</a> (c) 2011 Dave Townsend. <a href="http://creativecommons.org/licenses/by-sa/2.0/deed.en">Some rights reserved</a>.</li>
  <li><a href="http://www.flickr.com/photos/93425126@N00/313053257/">Cafe do Brasil</a> (c) 2003 Temporalata. <a href="http://creativecommons.org/licenses/by-sa/2.0/deed.en">Some rights reserved</a>.</li>
  <li><a href="http://www.flickr.com/photos/digitalcolony/2833809436/">Brown Cups</a> (c) 2007 Michael Allen Smith. <a href="http://creativecommons.org/licenses/by-sa/2.0/deed.en">Some rights reserved</a>.</li>
  <li><a href="http://www.flickr.com/photos/citizenhelder/5006498068/">Mirage</a> (c) 2010 Mira Helder. <a href="http://creativecommons.org/licenses/by/2.0/deed.en">Some rights reserved</a>.</li>
  <li><a href="http://www.flickr.com/photos/joncrel/237026246/">Coffee Van with Bullet Holes</a> (c) 2006 Jon Crel. <a href="http://creativecommons.org/licenses/by-nd/2.0/deed.en">Some rights reserved</a>.</li>
</ul>

<div class="page-break" />
<h3 id="about-the-author">About The Author</h3>

<p>When he&rsquo;s not shipping CoffeeScript, Ruby, JavaScript and Java applications scaling out to millions of users, Reg &ldquo;Raganwald&rdquo; Braithwaite has authored <a href="http://github.com/raganwald">libraries</a> for CoffeeScript, JavaScript and Ruby programming such as Method Combinators, Katy, JQuery Combinators, YouAreDaChef, andand, and others.</p>

<p>He writes about programming on his &ldquo;<a href="http://github.com/raganwald/homoiconic">Homoiconic</a>&rdquo; un-blog as well as general-purpose ruminations on his <a href="http://raganwald.posterous.com">posterous space</a>. He is also known for authoring the popular <a href="http://weblog.raganwald.com">raganwald programming blog</a> from 2005-2008.</p>

<h4 id="contact">contact</h4>

<p>Twitter: <a href="https://twitter.com/raganwald">@raganwald</a><br />
Email: <a href="&#109;&#097;&#105;&#108;&#116;&#111;:&#114;&#101;&#103;&#064;&#098;&#114;&#097;&#121;&#116;&#104;&#119;&#097;&#121;&#116;&#046;&#099;&#111;&#109;">&#114;&#101;&#103;&#064;&#098;&#114;&#097;&#121;&#116;&#104;&#119;&#097;&#121;&#116;&#046;&#099;&#111;&#109;</a></p>

<div class="image-with-caption">
  <p><img src="images/reg2.jpg" alt="Reg &quot;Raganwald&quot; Braithwaite " />
  <p>Reg "Raganwald" Braithwaite </p>
</div>

<div class="footnotes">
  <ol>
    <li id="fn-representation">Technically, it&rsquo;s a <em>representation</em> of a value using Base10 notation, but we needn&rsquo;t worry about that in this book. You and I both understand that this means &ldquo;42,&rdquo; and so does the computer.<a href="#fnref-representation" rev="footnote">&#8617;</a></li>
    <li id="fn-homoiconicity">In some languages, expressions are a kind of value unto themselves and can be manipulated. The grandfather of such languages is Lisp. CoffeeScript is not such a language, expressions in and of themselves are not values.<a href="#fnref-homoiconicity" rev="footnote">&#8617;</a></li>
    <li id="fn-also">If you have dabbled in CoffeeScript or look at other people&rsquo;s CoffeeScript programs, you may discover that it is also legal to write <code>()-&gt;</code>. Conceptually, <code>-&gt;</code> is a function with no arguments and no body. <code>()-&gt;</code> is a function with an empty list of arguments and no body. Generally, CoffeeScript programmers prefer <code>-&gt;</code>, so let&rsquo;s do that.<a href="#fnref-also" rev="footnote">&#8617;</a></li>
    <li id="fn-circular">The exact same thing will happen to you once you figure out how to make an array that contains itself. You&rsquo;ll try to print it out and you&rsquo;ll get <code>[[Circular]]</code> back. Never mind, internally CoffeeScript has constructed a perfectly fine Ouroborian array even if it won&rsquo;t try to print it out for you.<a href="#fnref-circular" rev="footnote">&#8617;</a></li>
    <li id="fn-ambiguous">If you&rsquo;re used to other programming languages, you&rsquo;ve probably internalized the idea that sometimes parentheses are used to group operations in an expression like math, and sometimes to apply a function to arguments. If not&hellip; Welcome to the <a href="https://en.wikipedia.org/wiki/ALGOL">ALGOL</a> family of programming languages!<a href="#fnref-ambiguous" rev="footnote">&#8617;</a></li>
    <li id="fn-omit">Elsewhere, we&rsquo;ve pledged to avoid optional bits that don&rsquo;t add a lot to our understanding. This optional bit gives us an excuse to learn about <code>undefined</code>, so that&rsquo;s why it&rsquo;s in. Now that we know this, we see that our expression <code>-&gt;</code> evaluates to a function taking no arguments and having no expression, therefore when you apply it to no arguments with <code>(-&gt;)()</code>, you get <code>undefined</code>.<a href="#fnref-omit" rev="footnote">&#8617;</a></li>
    <li id="fn-pedant">It does something else when the first argument is a string, but let&rsquo;s ignore that bit of pedantry for now.<a href="#fnref-pedant" rev="footnote">&#8617;</a></li>
    <li id="fn-mp"><a href="http://www.mindspring.com/~mfpatton/sketch.htm">The Argument Sketch</a> from &ldquo;Monty Python&rsquo;s Previous Record&rdquo; and &ldquo;Monty Python&rsquo;s Instant Record Collection&rdquo;<a href="#fnref-mp" rev="footnote">&#8617;</a></li>
    <li id="fn-f2f">We said that you can&rsquo;t apply a function to an expression. You <em>can</em> apply a function to one or more functions. Functions are values! This has interesting applications, and they will be explored much more thoroughly in <a href="#consumers">Functions That Are Applied to Functions</a>.<a href="#fnref-f2f" rev="footnote">&#8617;</a></li>
    <li id="fn-nonlocal">You may also hear the term &ldquo;non-local variable.&rdquo; <a href="https://en.wikipedia.org/wiki/Free_variables_and_bound_variables">Both are correct.</a> <a href="#fnref-nonlocal" rev="footnote">&#8617;</a></li>
    <li id="fn-let"><code>let</code> has made its way into other languages like JavaScript.<a href="#fnref-let" rev="footnote">&#8617;</a></li>
    <li id="fn-letrec"><code>let</code> is limited in some ways. For example, you can&rsquo;t define a recursive function without some fixed point combinator backflips. This will be discussed later when we look at the related pattern <a href="#letrec"><code>letrec</code></a>.<a href="#fnref-letrec" rev="footnote">&#8617;</a></li>
    <li id="fn-ssugar">&ldquo;Syntactic sugar causes cancer of the semicolon&rdquo;&ndash;<a href="http://www.cs.yale.edu/quotes.html" title="Epigrams in Programming">Alan Perlis</a><a href="#fnref-ssugar" rev="footnote">&#8617;</a></li>
    <li id="fn-hunh">Arrays in all contemporary languages store references and not copies, so we can be forgiven for expecting them to work the same way in CoffeeScript. Nevertheless, it&rsquo;s a useful exercise to test things for ourself.<a href="#fnref-hunh" rev="footnote">&#8617;</a></li>
    <li id="fn-poco">Tradition would have us call objects that don&rsquo;t contain any functions &ldquo;POCOs,&rdquo; meaning Plain Old CoffeeScript Objects. Given that <em>poco a poco</em> means &ldquo;little by little&rdquo; in musical notation, I&rsquo;m tempted to go along with that.<a href="#fnref-poco" rev="footnote">&#8617;</a></li>
    <li id="fn-y">You may also find <a href="https://en.wikipedia.org/wiki/Fixed-point_combinator">fixed point combinators</a> interesting.<a href="#fnref-y" rev="footnote">&#8617;</a></li>
    <li id="fn-worse">It could be worse. One very popular language assumes that if you haven&rsquo;t otherwise declared a variable local to a function, you must want a global variable that may clobber an existing global variable used by any piece of code in any file or module.<a href="#fnref-worse" rev="footnote">&#8617;</a></li>
    <li id="fn-encapsulation">&ldquo;A language construct that facilitates the bundling of data with the methods (or other functions) operating on that data.&rdquo;&ndash;<a href="https://en.wikipedia.org/wiki/Encapsulation_" title="object-oriented_programming">Wikipedia</a><a href="#fnref-encapsulation" rev="footnote">&#8617;</a></li>
    <li id="fn-length">Yes, there&rsquo;s another way to track the size of the array, but we don&rsquo;t need it to demonstrate encapsulation and hiding of state.<a href="#fnref-length" rev="footnote">&#8617;</a></li>
    <li id="fn-refactoring">And when you take an already factored component and rearrange things so that it is factored into a different set of subcomponents without altering its behaviour, you are <em>refactoring</em>.<a href="#fnref-refactoring" rev="footnote">&#8617;</a></li>
    <li id="fn-wasa">Before you start wondering whether a deque is-a queue, we said nothing about types and classes. This relationship is called was-a, or &ldquo;implemented in terms of a.&rdquo;<a href="#fnref-wasa" rev="footnote">&#8617;</a></li>
    <li id="fn-this">CoffeeScript also does other things with <code>this</code> as well, but this is all we care about right now.<a href="#fnref-this" rev="footnote">&#8617;</a></li>
    <li id="fn-turing">Since the CoffeeScript that we have presented so far is <a href="https://en.wikipedia.org/wiki/Turing_completeness" title="Computational Universality and Turing Completeness">computationally universal</a>, it is possible to perform any calculation with its existing feature set, including emulating any other programming language. Therefore, it is not theoretically necessary to have any further language features; If we need macros, continuations, generic functions, static typing, or anything else, we can <a href="https://en.wikipedia.org/wiki/Greenspun%27s_Tenth_Rule">greenspun</a> them ourselves. In practice, however, this is buggy, inefficient, and presents our fellow developers with serious challenges understanding our code.<a href="#fnref-turing" rev="footnote">&#8617;</a></li>
    <li id="fn-dynamic">For many programmers, the distinction between a dynamic relationship and a copying mechanism too fine to worry about. However, it makes many dynamic program modifications possible.<a href="#fnref-dynamic" rev="footnote">&#8617;</a></li>
    <li id="fn-reminder">Recall that Strings, Numbers, Booleans and so forth are value types and primitives. We&rsquo;re calling them primitives here.<a href="#fnref-reminder" rev="footnote">&#8617;</a></li>
    <li id="fn-wr">A <a href="https://en.wikipedia.org/wiki/Weak_reference">weak reference</a> is a reference that does not protect the referenced object from collection by a garbage collector; unlike a strong reference. An object referenced only by weak references is considered unreachable (or weakly reachable) and so may be collected at any time.<a href="#fnref-wr" rev="footnote">&#8617;</a></li>
    <li id="fn-xt">You should almost always use <code>extends</code> rather than rolling your own code to chain functions and instances. And even if you let CoffeeScript do the work, you should always <em>understand</em> what CoffeeScript is doing for you.<a href="#fnref-xt" rev="footnote">&#8617;</a></li>
    <li id="fn-json">To be precise, it works for functions that take arguments that can be expressed with JSON. So you can&rsquo;t memoize a function that is applied to functions, but it&rsquo;s fine for strings, numbers, arrays of JSON, POCOs of JSON, and so forth.<a href="#fnref-json" rev="footnote">&#8617;</a></li>
    <li id="fn-py">The term &ldquo;method decorator&rdquo; is borrowed from the Python programming language<a href="#fnref-py" rev="footnote">&#8617;</a></li>
    <li id="fn-fsm">A <a href="https://en.wikipedia.org/wiki/Finite-state_machine">state machine</a> is a mathematical model of computation used to design both computer programs and sequential logic circuits. It is conceived as an abstract machine that can be in one of a finite number of states. The machine is in only one state at a time; the state it is in at any given time is called the current state. It can change from one state to another when initiated by a triggering event or condition, this is called a transition. A particular FSM is defined by a list of its states, and the triggering condition for each transition.<a href="#fnref-fsm" rev="footnote">&#8617;</a></li>
    <li id="fn-interactive">Interactive promises also support <code>.get</code> and <code>.call</code> methods for interacting with a potentially remote object.<a href="#fnref-interactive" rev="footnote">&#8617;</a></li>
    <li id="fn-whoa">Instructions for installing NodeJS and modules like CoffeeScript onto a desktop computer is beyond the scope of this book, especially given the speed with which things advance. Fortunately, there are always up-to-date instructions on the web.<a href="#fnref-whoa" rev="footnote">&#8617;</a></li>
  </ol>
</div>

</div>
<div id="leanpub-toc">
<h2>Table of Contents</h2>
<ol class="toc">
<li class="chapter"><a href="#a-pull-of-the-lever-prefaces">A Pull of the Lever: Prefaces</a></li>
<li class="section"><a href="#about-this-book">About This Book</a></li>
<li class="section"><a href="#foreword-by-jeremy-ashkenas">Foreword by Jeremy Ashkenas</a></li>
<li class="section"><a href="#legend">Legend</a></li>
<li class="chapter"><a href="#prelude-values-and-expressions">Prelude: Values and Expressions</a></li>
<li class="section"><a href="#values-and-expressions">values and expressions</a></li>
<li class="section"><a href="#values-and-identity">values and identity</a></li>
<li class="chapter"><a href="#coffeescript-ristretto">CoffeeScript Ristretto</a></li>
<li class="chapter"><a href="#functions">The first sip: Functions</a></li>
<li class="section"><a href="#as-little-as-possible-about-functions-but-no-less">As Little As Possible About Functions, But No Less</a></li>
<li class="section"><a href="#fargs">Ah. I&#x2019;d Like to Have an Argument, Please.<sup id="fnref-mp">
  <a href="#fn-mp" rel="footnote">8</a>
</sup></a></li>
<li class="section"><a href="#closures">Closures and Scope</a></li>
<li class="section"><a href="#summary">Summary</a></li>
<li class="chapter"><a href="#more-functions">Slurp: More About Functions and Scope</a></li>
<li class="section"><a href="#let-me-show-you-what-to-do">Let Me Show You What To Do</a></li>
<li class="section"><a href="#a-simple-question">A Simple Question</a></li>
<li class="section"><a href="#making-things-easy">Making Things Easy</a></li>
<li class="section"><a href="#summary-1">Summary</a></li>
<li class="chapter"><a href="#poco">References, Identity, Arrays, and Objects</a></li>
<li class="section"><a href="#arguments-and-arrays">arguments and arrays</a></li>
<li class="section"><a href="#references-and-objects">references and objects</a></li>
<li class="chapter"><a href="#mutable">Stir the Espresso: Objects, Mutation, and State</a></li>
<li class="section"><a href="#reassignment-and-mutation">Reassignment and Mutation</a></li>
<li class="section"><a href="#normal-variables">Normal Variables</a></li>
<li class="section"><a href="#comprehensions">Comprehensions</a></li>
<li class="section"><a href="#encapsulation">Encapsulating State with Closures</a></li>
<li class="section"><a href="#composition">Composition and Extension</a></li>
<li class="section"><a href="#this">This and That</a></li>
<li class="section"><a href="#summary-2">Summary</a></li>
<li class="chapter"><a href="#methods">Finish the Cup: Instances and Classes</a></li>
<li class="section"><a href="#prototypes-are-simple-its-the-explanations-that-are-hard-to-understand">Prototypes are Simple, it&#x2019;s the Explanations that are Hard To Understand</a></li>
<li class="section"><a href="#a-touch-of-class">A Touch of Class</a></li>
<li class="section"><a href="#object-methods">Object Methods</a></li>
<li class="section"><a href="#canonicalization">Canonicalization</a></li>
<li class="section"><a href="#this-section-needs-no-title">This Section Needs No Title</a></li>
<li class="section"><a href="#classextension">Extending Classes</a></li>
<li class="section"><a href="#summary-3">Summary</a></li>
<li class="chapter"><a href="#extra-shot">An Extra Shot of Ideas</a></li>
<li class="section"><a href="#combinators">Refactoring to Combinators</a></li>
<li class="section"><a href="#method-decorators">Method Decorators</a></li>
<li class="section"><a href="#callbacks-and-promises">Callbacks and Promises</a></li>
<li class="section"><a href="#summary-4">Summary</a></li>
<li class="chapter"><a href="#a-golden-crema">A Golden Crema</a></li>
<li class="section"><a href="#online">How to run the examples</a></li>
<li class="section"><a href="#thanks">Thanks!</a></li>
<li class="section"><a href="#javascript-allong">JavaScript Allong&#xE9;</a></li>
<li class="section"><a href="#copyright-notice">Copyright Notice</a></li>
<li class="section"><a href="#about-the-author">About The Author</a></li>
</ol>
</div>
